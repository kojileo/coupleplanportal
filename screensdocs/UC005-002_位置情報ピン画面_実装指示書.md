# UC005-002: 位置情報ピン画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: デート中に訪れた場所をリアルタイムで記録し、ボード内から直感的に共有できる地図体験を提供
- **ビジネスゴール**: ロケーションデータを活用した後続レコメンドとアルバム生成の価値向上
- **技術ゴール**: 精度の高い位置取得と双方向同期、離脱時の位置履歴保持

### 受け入れ基準
- 既存ピンが2秒以内に地図へプロットされる
- 新規ピン作成がGPS測位完了から3秒以内に保存される
- ピンの共同編集結果が500ms以内に相互反映される
- 位置情報許諾が未取得の場合はフォールバック入力を案内
- 色覚多様性に配慮したピンカラーパレットを提供

### 機能段階性
1. **基礎**: 位置取得、ピン追加・編集・削除、地図表示、同期
2. **拡張**: チェックイン履歴、写真添付、ルート描画
3. **制約**: ピン数上限100件、更新頻度5秒間隔、測位精度閾値

## 2. 仕様の厳密化

### コア機能

#### 位置情報取得
- **取得**: GET /api/v1/dates/{dateId}/locations
- **補完**: 直近訪問順で返却、緯度経度とラベルを含む
- **失敗**: リトライ導線と手動入力フォームを解放

#### ピン追加
- **送信**: POST /api/v1/dates/{dateId}/locations
- **入力**: 緯度経度、場所名、カテゴリ、メモ
- **通知**: 追加結果をDate Canvasへイベント送信

#### ピン更新
- **送信**: PUT /api/v1/dates/{dateId}/locations/{pinId}
- **操作**: ドラッグ移動、カテゴリ変更、ステータス更新
- **競合**: versionフィールドで制御、失敗時は再読み込み

#### 地図表示
- **レンダリング**: Mapbox GL/Google Maps APIを利用
- **スタイル**: デートテーマに合わせたカスタムスタイル
- **クラスタ**: ピン密集時はズームに応じてクラスタリング

#### GPS位置取得
- **利用**: HTML Geolocation APIで現在地測位
- **フォールバック**: 許可拒否時は検索ボックスと候補リスト

### 入力制約 & バリデーション

#### locationName
- **形式**: 1〜60文字
- **必須**: 必須
- **エラーメッセージ**: "場所名を入力してください"

#### latitude / longitude
- **形式**: 浮動小数点
- **範囲**: 緯度 -90〜90、経度 -180〜180
- **エラーメッセージ**: "有効な位置情報を入力してください"

#### category
- **形式**: enum(date_spot | meal | activity | memory | other)
- **必須**: 任意（未設定時はother）
- **エラーメッセージ**: "カテゴリが不正です"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface LocationListResponse {
  dateId: string;
  pins: LocationPin[];
  updatedAt: string;
}

interface LocationPin {
  pinId: string;
  name: string;
  latitude: number;
  longitude: number;
  category: 'date_spot' | 'meal' | 'activity' | 'memory' | 'other';
  memo?: string;
  visitedAt?: string;
  createdBy: string;
  updatedAt: string;
}

interface LocationCreatePayload {
  name: string;
  latitude: number;
  longitude: number;
  category?: LocationPin['category'];
  memo?: string;
}

interface LocationUpdatePayload extends Partial<LocationCreatePayload> {
  pinId: string;
  version: number;
}
~~~

#### API エンドポイント
- 位置情報取得: GET /api/v1/dates/{dateId}/locations
- ピン追加: POST /api/v1/dates/{dateId}/locations
- ピン更新: PUT /api/v1/dates/{dateId}/locations/{pinId}

### UX / A11y

#### 地図操作
- ズーム、パン、回転をマウス・タッチ・キーボードでサポート
- キーボード用にフォーカス可能なピンリストと地図連動ハイライト
- 音声フィードバックでピンのカテゴリーと距離を読み上げ

#### 視覚設計
- ピンカラーはWCAG 2.1 AAのコントラスト準拠
- カテゴリアイコンとラベルで冗長表現
- 夜間モードで地図色を反転

#### 安心設計
- 位置共有の同意状態を常時ステータスバーで表示
- 許諾撤回時は即座に再測位を停止

### セキュリティ & プライバシー
- **許諾**: 初回訪問時に位置情報利用同意を取得し更新メカニズム提供
- **アクセス制御**: dateIdに紐づくユーザーのみ操作可
- **データ保持**: 詳細位置はアルバム生成後180日で匿名化
- **通信**: HTTPS/TLS1.3

### 非機能要件
- **レイテンシ**: ピン追加後の表示500ms以内
- **精度**: 測位誤差許容30m以内で収束しない場合は再測位
- **可用性**: 99.9%稼働、測位失敗率5%未満
- **可観測性**: 測位成功率、拒否率、クラスタ利用率をメトリクス化

## 3. 曖昧さと解決

### ピン重複
- 半径10m以内に同一カテゴリが存在する場合はアラート表示
- ユーザー選択で統合または新規作成を選べる

### 位置精度
- 精度が30mを超える場合は黄色警告バッジ
- 100m以上は追加不可とし手動入力のみ許可

### オフライン時の挙動
- ピン作成はローカルキューに保持し地図には仮ピン表示
- 復帰後の保存失敗時は再編集ダイアログ

## 4. 受け入れ基準例（Gherkin風）

### ピン追加
~~~gherkin
Given 位置情報利用を許可したユーザー
When 現在地からピンを追加する
Then 地図に新しいピンが表示される
And パートナー側にも500ms以内で反映される
~~~

### 位置情報拒否
~~~gherkin
Given 位置情報利用を拒否したユーザー
When 位置情報ピン画面を開く
Then 手動入力フォームが表示される
And 位置情報許可の再設定ガイドが表示される
~~~

## 5. リスクとトレードオフ

### 技術リスク
- 測位精度不足 → Wi-Fi/Bluetooth補助、再測位リトライ
- Map SDKレイテンシ → タイルキャッシュと最適ズーム制御
- 同期競合 → バージョン衝突時の自動マージと警告

### UXリスク
- 地図操作の複雑化 → フィルタとリスト操作で補完
- ピン乱立 → カテゴリフィルタとクラスタリングで整理
- 屋内測位難 → 手動入力支援と写真添付で文脈補強

### プライバシーリスク
- 過度な位置共有 → 匿名化設定と共有範囲選択肢を提供
- ログ漏えい → ログには座標ハッシュのみ記録

## 6. 拡張余地

### 短期拡張
- ARナビゲーション
- ビュー切替（リスト / タイムライン）
- 自動チェックイン提案

### 中期拡張
- 外部交通API連携
- 口コミ/レビュー連携
- パートナー別訪問履歴比較

### 長期拡張
- 室内マップ連携
- ドローンショット等の位置連動メディア
- AIによる移動ルート最適化

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **地図ライブラリ**: Mapbox GL JS（アクセシビリティ対応必須）
- **状態管理**: Zustand + React Query
- **測位**: Geolocation API + fallback geocoding

### コンポーネント設計
~~~typescript
interface LocationMapPageProps {
  dateId: string;
  userId: string;
}

interface LocationMapProps {
  pins: LocationPin[];
  onCreate: (payload: LocationCreatePayload) => void;
  onUpdate: (payload: LocationUpdatePayload) => void;
  loading: boolean;
}

interface PermissionBannerProps {
  status: 'granted' | 'prompt' | 'denied';
  onRequest: () => void;
}
~~~

### スタイリング
~~~css
.location-map-page {
  @apply relative h-full bg-slate-50;
}

.map-container {
  @apply h-full w-full rounded-3xl overflow-hidden shadow-lg;
}

.pin-detail-panel {
  @apply absolute bottom-6 left-1/2 -translate-x-1/2 w-96 max-w-full bg-white/95 backdrop-blur rounded-2xl shadow-xl border border-slate-200;
}

.permission-banner {
  @apply absolute top-4 left-1/2 -translate-x-1/2 flex items-center gap-2 px-4 py-2 bg-amber-50 text-amber-800 rounded-full shadow;
}
~~~

### テレメトリ
- ピン作成/更新回数、測位成功率、クラスタ展開率をトラッキング
- 許諾拒否時の離脱率を測定し改善に活用


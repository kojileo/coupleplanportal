# UC003-002: デート情報検索画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: 詳細なデート情報検索とフィルタ機能を提供
- **ビジネスゴール**: ユーザーエンゲージメント向上と検索体験の最適化
- **技術ゴール**: 高精度な検索とリアルタイムフィルタリングの実現

### 受け入れ基準
- 検索実行が1秒以内に完了する
- フィルタ適用が500ms以内に完了する
- 検索履歴保存が2秒以内に完了する
- モバイル・デスクトップ両対応のレスポンシブデザイン
- WCAG 2.1 AA準拠のアクセシビリティ

### 機能段階性
1. **基礎**: 検索実行、フィルタ適用、検索履歴保存
2. **拡張**: リアルタイム検索、検索結果表示、検索履歴表示
3. **制約**: 検索制限、フィルタ制限、履歴制限

## 2. 仕様の厳密化

### コア機能

#### 検索実行
- **入力**: 検索クエリの入力
- **実行**: 検索の実行
- **表示**: 検索結果の表示
- **完了**: 検索完了の通知

#### フィルタ適用
- **選択**: フィルタ条件の選択
- **適用**: フィルタの適用
- **表示**: フィルタ結果の表示
- **完了**: 適用完了の通知

#### 検索履歴保存
- **記録**: 検索履歴の記録
- **保存**: 履歴の保存
- **表示**: 履歴の表示
- **完了**: 保存完了の通知

#### リアルタイム検索
- **入力**: リアルタイムでの検索
- **更新**: 検索結果の更新
- **表示**: リアルタイム結果の表示
- **完了**: 更新完了の通知

#### 検索結果表示
- **表示**: 検索結果の表示
- **ソート**: 結果のソート
- **ページネーション**: 結果のページネーション
- **完了**: 表示完了の通知

### 入力制約 & バリデーション

#### 検索クエリ
- **長さ**: 1-200文字
- **形式**: 文字列
- **必須**: 任意項目
- **エラーメッセージ**: "200文字以内で入力してください"

#### フィルタ条件
- **選択肢**: 事前定義されたフィルタ
- **必須**: 任意項目
- **エラーメッセージ**: "有効なフィルタを選択してください"

#### 検索履歴
- **最大数**: 100件
- **保持期間**: 30日間
- **エラーメッセージ**: "検索履歴の保存に失敗しました"

### データモデル & API

#### リクエストモデル
```typescript
interface SearchRequest {
  query: string;
  page: number;
  limit: number;
  filters: SearchFilters;
  sortBy?: 'relevance' | 'date' | 'rating' | 'price';
  sortOrder?: 'asc' | 'desc';
}

interface SearchFilters {
  category?: string[];
  location?: string[];
  priceRange?: {
    min: number;
    max: number;
  };
  rating?: number;
  dateRange?: {
    start: string;
    end: string;
  };
  tags?: string[];
}

interface SearchHistoryRequest {
  userId: string;
  query: string;
  filters: SearchFilters;
  resultCount: number;
}
```

#### レスポンスモデル
```typescript
interface SearchResponse {
  results: SearchResult[];
  totalCount: number;
  currentPage: number;
  totalPages: number;
  hasMore: boolean;
  searchTime: number; // milliseconds
  filters: AppliedFilters;
  suggestions: string[];
}

interface SearchResult {
  id: string;
  type: 'article' | 'spot' | 'event' | 'plan';
  title: string;
  description: string;
  category: string;
  location?: string;
  rating?: number;
  priceLevel?: number;
  imageUrl?: string;
  tags: string[];
  relevanceScore: number;
  publishedAt?: string;
  viewCount?: number;
  likeCount?: number;
}

interface AppliedFilters {
  category: string[];
  location: string[];
  priceRange: {
    min: number;
    max: number;
  };
  rating: number;
  dateRange: {
    start: string;
    end: string;
  };
  tags: string[];
}

interface SearchHistoryResponse {
  history: SearchHistoryItem[];
  totalCount: number;
  hasMore: boolean;
}

interface SearchHistoryItem {
  id: string;
  query: string;
  filters: SearchFilters;
  resultCount: number;
  searchedAt: string;
}
```

#### API エンドポイント
- **詳細検索**: `POST /api/v1/portal/search/advanced`
- **フィルタ検索**: `POST /api/v1/portal/search/filtered`
- **検索履歴保存**: `POST /api/v1/portal/search/history`

### UX / A11y

#### キーボード操作
- **Tab順序**: 検索ボックス → フィルタ → 検索結果 → ページネーション
- **Enter**: 検索実行
- **Escape**: 検索クリア
- **矢印キー**: 検索結果間の移動

#### スクリーンリーダー対応
- **aria-label**: 各検索要素の説明
- **aria-live**: 検索結果の読み上げ
- **aria-describedby**: 検索説明の関連付け
- **role**: 検索要素の役割定義

#### 色覚対応
- **検索結果**: 色 + アイコン + テキスト
- **フィルタ状態**: 色 + 選択アイコン + テキスト
- **フォーカス**: 色 + アウトライン + 影

### セキュリティ & プライバシー

#### データ保護
- **検索データ**: 暗号化された保存
- **通信**: HTTPS強制、TLS 1.3以上
- **アクセス**: 認証済みユーザーのみ
- **履歴**: 適切なデータ保持期間

#### プライバシー保護
- **検索履歴**: 匿名化された分析
- **個人情報**: 最小限の情報収集
- **データ削除**: ユーザー要求による削除
- **履歴管理**: 適切な履歴管理

### 非機能要件

#### パフォーマンス
- **検索実行**: 1秒以内
- **フィルタ適用**: 500ms以内
- **検索履歴保存**: 2秒以内
- **リアルタイム検索**: 300ms以内

#### 可用性
- **稼働率**: 99.9%以上
- **エラー率**: 1%以下
- **復旧時間**: 5分以内

#### スケーラビリティ
- **同時接続**: 50,000ユーザー
- **スループット**: 5,000リクエスト/秒
- **検索処理**: 1,000件/秒

## 3. 曖昧さと解決

### 検索機能
- **全文検索**: タイトル・説明・タグでの検索
- **ファジー検索**: 類似語での検索
- **検索候補**: 入力に応じた検索候補
- **検索履歴**: 過去の検索履歴

### フィルタ機能
- **カテゴリフィルタ**: カテゴリ別の絞り込み
- **地域フィルタ**: 地域別の絞り込み
- **価格フィルタ**: 価格帯での絞り込み
- **評価フィルタ**: 評価での絞り込み

### 検索結果
- **関連度順**: 関連度の高い順での表示
- **日付順**: 最新順での表示
- **評価順**: 評価の高い順での表示
- **価格順**: 価格の安い順での表示

## 4. 受け入れ基準例（Gherkin風）

### 検索実行
```gherkin
Given ユーザーがデート情報検索画面にアクセス
When 検索クエリを入力
And 検索ボタンをクリック
Then 検索結果が表示される
And 1秒以内に完了する

Given ユーザーがデート情報検索画面にアクセス
When 無効な検索クエリを入力
Then エラーメッセージが表示される
And 検索が阻止される
```

### フィルタ適用
```gherkin
Given ユーザーがデート情報検索画面にアクセス
When フィルタ条件を選択
And フィルタ適用ボタンをクリック
Then フィルタ結果が表示される
And 500ms以内に完了する

Given ユーザーがデート情報検索画面にアクセス
When 無効なフィルタ条件を選択
Then エラーメッセージが表示される
And フィルタ適用が阻止される
```

## 5. リスクとトレードオフ

### 技術リスク
- **検索遅延**: 適切なタイムアウト設定
- **大量データ**: 適切なページネーション
- **検索精度**: 適切な検索アルゴリズム

### UXリスク
- **複雑な検索**: 分かりやすい検索インターフェース
- **フィルタ操作**: 直感的なフィルタ操作
- **検索結果**: 関連度の高い結果表示

### パフォーマンスリスク
- **検索処理**: 適切な検索処理
- **フィルタ処理**: 適切なフィルタ処理
- **履歴管理**: 効率的な履歴管理

## 6. 拡張余地

### 短期拡張
- **検索候補**: 入力に応じた検索候補
- **検索履歴**: 検索履歴の表示
- **お気に入り**: 検索結果のお気に入り

### 中期拡張
- **パーソナライズ**: ユーザーに応じた検索結果
- **検索分析**: 検索パターンの分析
- **推奨**: 検索結果の推奨

### 長期拡張
- **AI検索**: AIによる検索最適化
- **音声検索**: 音声による検索
- **画像検索**: 画像による検索

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **HTTP クライアント**: Axios
- **検索**: Elasticsearch
- **フィルタ**: React Hook Form

### コンポーネント設計
```typescript
// メインコンポーネント
interface SearchComponentProps {
  onSearch: (query: string, filters: SearchFilters) => void;
  onFilterChange: (filters: SearchFilters) => void;
  onHistoryLoad: () => void;
  onError: (error: string) => void;
}

// 検索結果
interface SearchResultsProps {
  results: SearchResult[];
  totalCount: number;
  currentPage: number;
  hasMore: boolean;
  onLoadMore: () => void;
  onSort: (sortBy: string, sortOrder: string) => void;
}

// フィルタ
interface FilterComponentProps {
  filters: SearchFilters;
  onFilterChange: (filters: SearchFilters) => void;
  onClear: () => void;
}
```

### スタイリング
```css
/* レスポンシブデザイン */
.search-container {
  @apply max-w-6xl mx-auto p-6 bg-white rounded-lg shadow-md;
}

.search-header {
  @apply mb-6;
}

.search-title {
  @apply text-2xl font-bold text-gray-800 mb-4;
}

.search-input-section {
  @apply mb-6;
}

.search-input-container {
  @apply relative;
}

.search-input {
  @apply w-full px-4 py-3 pr-12 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none;
}

.search-button {
  @apply absolute right-2 top-1/2 transform -translate-y-1/2 px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 focus:outline-none;
}

.search-suggestions {
  @apply absolute top-full left-0 right-0 bg-white border border-gray-300 rounded-lg shadow-lg z-10;
}

.suggestion-item {
  @apply px-4 py-2 hover:bg-gray-100 cursor-pointer;
}

.filters-section {
  @apply mb-6;
}

.filters-title {
  @apply text-lg font-semibold text-gray-800 mb-4;
}

.filters-grid {
  @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4;
}

.filter-group {
  @apply space-y-2;
}

.filter-label {
  @apply block text-sm font-medium text-gray-700;
}

.filter-select {
  @apply w-full px-3 py-2 border border-gray-300 rounded-md focus:border-blue-500 focus:outline-none;
}

.filter-checkbox {
  @apply flex items-center space-x-2;
}

.filter-checkbox-input {
  @apply w-4 h-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500;
}

.filter-checkbox-label {
  @apply text-sm text-gray-700;
}

.search-results-section {
  @apply mb-6;
}

.results-header {
  @apply flex items-center justify-between mb-4;
}

.results-count {
  @apply text-sm text-gray-600;
}

.results-sort {
  @apply flex items-center space-x-2;
}

.sort-select {
  @apply px-3 py-1 border border-gray-300 rounded-md focus:border-blue-500 focus:outline-none;
}

.results-grid {
  @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6;
}

.result-card {
  @apply bg-white border border-gray-200 rounded-lg overflow-hidden hover:shadow-md transition-shadow;
}

.result-image {
  @apply w-full h-48 object-cover;
}

.result-content {
  @apply p-4;
}

.result-title {
  @apply text-lg font-semibold text-gray-800 mb-2;
}

.result-description {
  @apply text-sm text-gray-600 mb-3;
}

.result-meta {
  @apply flex items-center justify-between text-xs text-gray-500;
}

.result-rating {
  @apply flex items-center text-yellow-600;
}

.result-price {
  @apply text-green-600 font-semibold;
}

.search-history-section {
  @apply mb-6;
}

.history-title {
  @apply text-lg font-semibold text-gray-800 mb-4;
}

.history-list {
  @apply space-y-2;
}

.history-item {
  @apply flex items-center justify-between p-3 bg-gray-50 rounded-lg hover:bg-gray-100 cursor-pointer;
}

.history-query {
  @apply text-sm font-medium text-gray-800;
}

.history-date {
  @apply text-xs text-gray-500;
}

.pagination-section {
  @apply flex items-center justify-center space-x-2;
}

.pagination-button {
  @apply px-3 py-2 border border-gray-300 rounded-md hover:bg-gray-50 focus:outline-none;
}

.pagination-button.active {
  @apply bg-blue-600 text-white border-blue-600;
}

.pagination-button.disabled {
  @apply opacity-50 cursor-not-allowed;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  .search-container {
    @apply bg-gray-800;
  }
  .search-title {
    @apply text-gray-200;
  }
  .search-input {
    @apply border-gray-600 bg-gray-700 text-white;
  }
  .search-suggestions {
    @apply bg-gray-700 border-gray-600;
  }
  .suggestion-item {
    @apply hover:bg-gray-600;
  }
  .filters-title {
    @apply text-gray-200;
  }
  .filter-label {
    @apply text-gray-300;
  }
  .filter-select {
    @apply border-gray-600 bg-gray-700 text-white;
  }
  .filter-checkbox-label {
    @apply text-gray-300;
  }
  .results-count {
    @apply text-gray-400;
  }
  .sort-select {
    @apply border-gray-600 bg-gray-700 text-white;
  }
  .result-card {
    @apply bg-gray-700 border-gray-600;
  }
  .result-title {
    @apply text-gray-200;
  }
  .result-description {
    @apply text-gray-400;
  }
  .result-meta {
    @apply text-gray-500;
  }
  .history-title {
    @apply text-gray-200;
  }
  .history-item {
    @apply bg-gray-700 hover:bg-gray-600;
  }
  .history-query {
    @apply text-gray-200;
  }
  .history-date {
    @apply text-gray-500;
  }
  .pagination-button {
    @apply border-gray-600 hover:bg-gray-700;
  }
}
```

## 8. 日本語サンプルデータ

### 検索結果データ
```json
{
  "searchResults": [
    {
      "id": "result_001",
      "type": "article",
      "title": "渋谷で過ごすロマンチックなデートスポット10選",
      "description": "渋谷の街で楽しめるロマンチックなデートスポットを厳選してご紹介します。",
      "category": "デートスポット",
      "location": "渋谷区",
      "rating": 4.5,
      "priceLevel": 2,
      "imageUrl": "https://example.com/images/shibuya-date-spots.jpg",
      "tags": ["渋谷", "ロマンチック", "デート", "カフェ", "レストラン"],
      "relevanceScore": 0.95,
      "publishedAt": "2025-01-27T10:00:00Z",
      "viewCount": 1250,
      "likeCount": 89
    },
    {
      "id": "result_002",
      "type": "spot",
      "title": "渋谷スカイ",
      "description": "渋谷の新ランドマーク。地上229mの展望台から東京の街を一望できます。",
      "category": "観光",
      "location": "渋谷区",
      "rating": 4.5,
      "priceLevel": 2,
      "imageUrl": "https://example.com/images/shibuya-sky.jpg",
      "tags": ["展望台", "夜景", "記念写真", "ロマンチック"],
      "relevanceScore": 0.92,
      "viewCount": 5000,
      "likeCount": 320
    },
    {
      "id": "result_003",
      "type": "event",
      "title": "渋谷イルミネーション2025",
      "description": "渋谷の街を彩る美しいイルミネーションイベント。",
      "category": "イベント",
      "location": "渋谷区",
      "rating": 4.3,
      "priceLevel": 1,
      "imageUrl": "https://example.com/images/shibuya-illumination.jpg",
      "tags": ["イルミネーション", "イベント", "冬", "ロマンチック"],
      "relevanceScore": 0.88,
      "publishedAt": "2025-01-20T15:00:00Z",
      "viewCount": 3200,
      "likeCount": 180
    }
  ]
}
```

### 検索履歴データ
```json
{
  "searchHistory": [
    {
      "id": "history_001",
      "query": "渋谷 デート",
      "filters": {
        "category": ["デートスポット", "カフェ"],
        "location": ["渋谷区"],
        "priceRange": {
          "min": 1000,
          "max": 5000
        },
        "rating": 4.0
      },
      "resultCount": 25,
      "searchedAt": "2025-01-27T10:00:00Z"
    },
    {
      "id": "history_002",
      "query": "新宿 アクティブ",
      "filters": {
        "category": ["アクティビティ", "スポーツ"],
        "location": ["新宿区"],
        "priceRange": {
          "min": 2000,
          "max": 8000
        },
        "rating": 3.5
      },
      "resultCount": 18,
      "searchedAt": "2025-01-26T15:30:00Z"
    },
    {
      "id": "history_003",
      "query": "上野 文化",
      "filters": {
        "category": ["美術館", "博物館"],
        "location": ["台東区"],
        "priceRange": {
          "min": 500,
          "max": 2000
        },
        "rating": 4.0
      },
      "resultCount": 12,
      "searchedAt": "2025-01-25T09:15:00Z"
    }
  ]
}
```

### フィルタオプションデータ
```json
{
  "filterOptions": {
    "categories": [
      "デートスポット",
      "カフェ",
      "レストラン",
      "観光",
      "アクティビティ",
      "スポーツ",
      "エンターテイメント",
      "文化",
      "美術館",
      "博物館",
      "イベント",
      "ショッピング"
    ],
    "locations": [
      "渋谷区",
      "新宿区",
      "台東区",
      "中央区",
      "港区",
      "千代田区",
      "文京区",
      "墨田区",
      "江東区",
      "品川区",
      "目黒区",
      "大田区",
      "世田谷区",
      "中野区",
      "杉並区",
      "豊島区",
      "北区",
      "荒川区",
      "板橋区",
      "練馬区",
      "足立区",
      "葛飾区",
      "江戸川区"
    ],
    "priceRanges": [
      {
        "label": "1,000円以下",
        "min": 0,
        "max": 1000
      },
      {
        "label": "1,000円〜3,000円",
        "min": 1000,
        "max": 3000
      },
      {
        "label": "3,000円〜5,000円",
        "min": 3000,
        "max": 5000
      },
      {
        "label": "5,000円〜10,000円",
        "min": 5000,
        "max": 10000
      },
      {
        "label": "10,000円以上",
        "min": 10000,
        "max": 999999
      }
    ],
    "ratings": [
      {
        "label": "4.5以上",
        "value": 4.5
      },
      {
        "label": "4.0以上",
        "value": 4.0
      },
      {
        "label": "3.5以上",
        "value": 3.5
      },
      {
        "label": "3.0以上",
        "value": 3.0
      }
    ]
  }
}
```

### エラーメッセージ
```json
{
  "errorMessages": {
    "search": {
      "queryRequired": "検索クエリを入力してください",
      "queryTooLong": "200文字以内で入力してください",
      "networkError": "検索に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "検索がタイムアウトしました",
      "noResults": "検索結果が見つかりません"
    },
    "filter": {
      "invalidFilter": "無効なフィルタ条件です",
      "networkError": "フィルタ適用に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "フィルタ適用がタイムアウトしました"
    },
    "history": {
      "saveFailed": "検索履歴の保存に失敗しました",
      "loadFailed": "検索履歴の読み込みに失敗しました",
      "deleteFailed": "検索履歴の削除に失敗しました",
      "networkError": "ネットワークエラーが発生しました"
    },
    "general": {
      "networkError": "ネットワークエラーが発生しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "タイムアウトが発生しました",
      "unknown": "不明なエラーが発生しました"
    }
  }
}
```

### 成功メッセージ
```json
{
  "successMessages": {
    "searchCompleted": "検索が完了しました",
    "filterApplied": "フィルタが適用されました",
    "historySaved": "検索履歴が保存されました",
    "historyLoaded": "検索履歴が読み込まれました",
    "historyDeleted": "検索履歴が削除されました"
  }
}
```

## 9. 最終チェックリスト

### 機能要件
- [ ] 検索実行機能が正常に動作する
- [ ] フィルタ適用機能が正常に動作する
- [ ] 検索履歴保存機能が正常に動作する
- [ ] リアルタイム検索機能が正常に動作する
- [ ] 検索結果表示機能が正常に動作する

### 非機能要件
- [ ] レスポンシブデザインが実装されている
- [ ] アクセシビリティ（WCAG 2.1 AA）に準拠している
- [ ] パフォーマンス要件を満たしている
- [ ] セキュリティ要件が実装されている
- [ ] エラー率が許容範囲内である

### ユーザビリティ
- [ ] 直感的なUI/UXが実装されている
- [ ] 適切なフィードバックが提供されている
- [ ] 検索インターフェースが分かりやすい
- [ ] エラーメッセージが分かりやすい
- [ ] キーボード操作が可能である

### セキュリティ
- [ ] 検索データが適切に保護されている
- [ ] HTTPS通信が強制されている
- [ ] 認証・認可が適切に実装されている
- [ ] 検索履歴が適切に管理されている
- [ ] プライバシー保護が実装されている

### 技術要件
- [ ] 検索機能が適切に実装されている
- [ ] フィルタ機能が適切に実装されている
- [ ] 検索履歴が適切に実装されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] 状態管理が適切に実装されている

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: ソフトウェアエンジニア・UX/UIデザイナー  
**承認者**: [承認者名]  
**レビュー者**: [レビュー者名]

# UC007-001: 課金管理画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: カップル単位のサブスクリプション状況、支払い履歴、機能制限を一望できるダッシュボードを提供
- **ビジネスゴール**: 段階的マネタイズの透明性を確保し、アップグレード転換率を向上
- **技術ゴール**: 課金・使用量APIとの整合性と監査対応ログの確保

### 受け入れ基準
- サブスク情報が2秒以内に表示される
- 支払い履歴テーブルはページネーション付きで3秒以内にロード
- プラン変更操作は3秒以内に結果を返し、楽観的UIで反映
- 使用量メトリクスはリアルタイム（最大1分遅延）で更新
- アクセシビリティ: テーブル、チャート、操作ボタンがWCAG 2.1 AA準拠

### 機能段階性
1. **基礎**: サブスク情報、支払い履歴、使用量表示、プラン変更
2. **拡張**: クーポン適用、請求書ダウンロード、アラート設定
3. **制約**: プラン変更日数制限、支払い履歴取得上限、レート制限

## 2. 仕様の厳密化

### コア機能

#### サブスクリプション取得
- **取得**: GET /api/v1/subscriptions/{coupleId}
- **表示**: プラン名、料金、次回請求日、ステータス
- **失敗**: エラーバナーとサポート導線

#### プラン変更
- **送信**: PUT /api/v1/subscriptions/{coupleId}/plan
- **入力**: newPlan、effectiveDate、promotionCode
- **制御**: 同一プランへの変更は不可、最低滞在期間をチェック

#### 支払い履歴取得
- **取得**: GET /api/v1/payments/{coupleId}
- **表示**: テーブル＋フィルタ（期間、ステータス）
- **ダウンロード**: CSV出力（ローカル生成）

#### 使用量取得
- **取得**: GET /api/v1/usage/{coupleId}
- **内容**: 機能別使用量、制限比率、超過警告
- **可視化**: ドーナツチャートとメーターバー

### 入力制約 & バリデーション

#### coupleId
- **形式**: UUID v4
- **必須**: 必須
- **エラーメッセージ**: "カップルIDを確認してください"

#### newPlan
- **形式**: enum(free | lite | premium | enterprise)
- **必須**: プラン変更時に必須
- **エラーメッセージ**: "プランが不正です"

#### promotionCode
- **形式**: 英数字8〜16文字
- **制限**: オプション
- **エラーメッセージ**: "プロモコードが不正です"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface SubscriptionResponse {
  coupleId: string;
  plan: 'free' | 'lite' | 'premium' | 'enterprise';
  status: 'trial' | 'active' | 'past_due' | 'canceled';
  billingCycle: 'monthly' | 'annual';
  amount: number;
  currency: 'JPY';
  nextBillingAt?: string;
  trialEndsAt?: string;
  featureStage: 'phase_1' | 'phase_2' | 'phase_3';
}

interface PlanChangePayload {
  newPlan: SubscriptionResponse['plan'];
  effectiveDate?: string;
  promotionCode?: string;
  reason?: string;
}

interface PaymentHistoryItem {
  paymentId: string;
  amount: number;
  currency: 'JPY';
  status: 'succeeded' | 'pending' | 'failed';
  paidAt: string;
  invoiceUrl?: string;
}

interface UsageMetricsResponse {
  coupleId: string;
  metrics: Array<{
    featureKey: string;
    used: number;
    limit: number;
    resetAt: string;
  }>;
  lastUpdatedAt: string;
}
~~~

#### API エンドポイント
- サブスクリプション取得: GET /api/v1/subscriptions/{coupleId}
- プラン変更: PUT /api/v1/subscriptions/{coupleId}/plan
- 支払い履歴取得: GET /api/v1/payments/{coupleId}
- 使用量取得: GET /api/v1/usage/{coupleId}

### UX / A11y

#### 情報構造
- 上部にプラン概要カード、中央に使用量チャート、下部に履歴テーブル
- 過去支払いのフィルタと検索
- プラン比較表とアップグレードボタン

#### アクセシビリティ
- テーブル列ヘッダにscope属性
- チャートはテーブルデータと説明文を併記
- フォーム要素にaria-describedbyで注意書きを連結

#### ガイダンス
- プラン変更の影響をモーダルで説明
- 過去支払い失敗時はエラー履歴と対処リンク
- 超過警告をバナーとメール設定へ誘導

### セキュリティ & プライバシー
- **認可**: 管理者または該当カップルの代表ユーザーのみアクセス
- **通信**: HTTPS/TLS1.3
- **データ保護**: 支払い情報はトークン化、画面では下4桁のみ
- **監査**: プラン変更アクティビティを監査ログへ送信

### 非機能要件
- **レスポンス**: 主要API 2秒以内
- **可用性**: 99.9%、課金API失敗率1%未満
- **耐障害性**: プラン変更失敗時はロールバック
- **可観測性**: 変更率、失敗率、使用量閾値超過率を監視

## 3. 曖昧さと解決

### プラン変更時期
- 同日変更は即時反映、過去日付はエラー
- future effectiveDateはタイムゾーンをUTCで表示

### 支払い履歴表示範囲
- 初期は過去6か月、もっと見るで12か月単位
- CSVは最大24か月分、超過はサポート問い合わせ

### 使用量リセット
- resetAt表示し、超過時は次回リセット日時を強調
- 使用量は1分単位でキャッシュ更新

## 4. 受け入れ基準例（Gherkin風）

### プラン変更
~~~gherkin
Given アクティブなサブスクリプションを持つユーザー
When プランをliteからpremiumへ変更する
Then 3秒以内に変更成功メッセージが表示される
And プラン概要カードがpremiumに更新される
~~~

### 支払い履歴
~~~gherkin
Given ユーザーが課金管理画面を開く
When 過去3か月の支払い履歴を表示する
Then テーブルに取引が日付降順で表示される
And 各行に詳細リンクが表示される
~~~

## 5. リスクとトレードオフ

### 技術リスク
- 課金API遅延 → キャッシュとバックオフソリューション
- 支払い履歴データ不整合 → スナップショット比較と整合性チェック
- プラン変更競合 → idempotency keyとロック制御

### UXリスク
- 情報過多 → カード化とセクション分割
- プラン説明不足 → 比較表とFAQ連携
- 超過警告の過小認知 → 目立つバナーとトースト

### プライバシーリスク
- 支払い情報露出 → マスク表示とアクセス制御
- プラン変更権限乱用 → ロールベース権限と監査ログ

## 6. 拡張余地

### 短期拡張
- プランアップグレードキャンペーン表示
- 支払い方法追加
- Webhookステータス表示

### 中期拡張
- 予算シミュレーション
- 使用量予測グラフ
- SLA/サポートプラン連携

### 長期拡張
- 複数通貨/地域対応
- 組織向け複数カップル管理
- AIによるプラン最適化提案

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: React Query + Zustand
- **チャート**: RechartsまたはECharts

### コンポーネント設計
~~~typescript
interface BillingDashboardProps {
  coupleId: string;
}

interface SubscriptionCardProps {
  subscription: SubscriptionResponse;
  onChangePlan: () => void;
}

interface UsageMeterProps {
  metrics: UsageMetricsResponse['metrics'];
}
~~~

### スタイリング
~~~css
.billing-page {
  @apply max-w-5xl mx-auto space-y-8 px-4 py-12;
}

.subscription-card {
  @apply bg-white rounded-2xl shadow-md border border-slate-200 p-6 flex flex-col gap-4;
}

.usage-grid {
  @apply grid grid-cols-1 md:grid-cols-2 gap-6;
}

.payment-table {
  @apply bg-white rounded-2xl shadow-sm border border-slate-200;
}
~~~

### テレメトリ
- プラン変更操作数、成功率、アップグレード率
- 支払い失敗表示率、CSVダウンロード数、使用量超過率


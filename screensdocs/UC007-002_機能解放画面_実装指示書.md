# UC007-002: 機能解放画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: マネタイズ段階に応じた機能解放状況と次のアンロック条件を可視化し、アップグレード意欲を高める
- **ビジネスゴール**: 段階的にプレミアム機能を解放し、適切なタイミングで導線を提供
- **技術ゴール**: Feature Flagシステムとの整合と分岐ロジックの一元管理

### 受け入れ基準
- 機能フラグ一覧が2秒以内に表示される
- ステージ切替が即時に反映され、差分非表示がない
- アップグレード誘導ボタンはユーザー権限に応じて制御される
- 制限状態の説明が読みやすく、WCAG 2.1 AA準拠
- キャッシュは最大5分で更新、手動更新可能

### 機能段階性
1. **基礎**: 機能フラグ取得、ステージ表示、制限説明、アップグレード導線
2. **拡張**: 機能比較表、カスタムステージ管理、通知設定
3. **制約**: 機能数上限200、更新頻度60秒、同時閲覧10,000人

## 2. 仕様の厳密化

### コア機能

#### 機能フラグ取得
- **取得**: GET /api/v1/features/{coupleId}
- **内容**: 各機能のcurrentStage、enabled状態、説明

#### 機能解放状況取得
- **取得**: GET /api/v1/features/{coupleId}/status
- **内容**: 現在のステージ、次ステージ要件、予定日
- **表示**: タイムラインとステージカード

#### アップグレード誘導
- **導線**: プラン管理画面への遷移、キャンペーン表示
- **制御**: すでに解放済みの機能は誘導非表示

#### 制限表示
- **表示**: 未解放機能にはロックアイコン、説明文、必要条件
- **通知**: クリティカルな制限はバナー表示

### 入力制約 & バリデーション

#### featureKey
- **形式**: スネークケース文字列
- **必須**: APIレスポンス
- **エラーメッセージ**: "機能キーが不正です"

#### stage
- **形式**: enum(phase_1 | phase_2 | phase_3 | experimental)
- **必須**: 必須
- **エラーメッセージ**: "ステージ情報を取得できませんでした"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface FeatureFlag {
  featureKey: string;
  displayName: string;
  description: string;
  currentStage: 'phase_1' | 'phase_2' | 'phase_3' | 'experimental';
  enabled: boolean;
  unlockPlan?: 'lite' | 'premium' | 'enterprise';
  usageLimit?: number;
  usageLimitUnit?: 'per_day' | 'per_month' | 'per_plan';
}

interface FeatureFlagResponse {
  coupleId: string;
  features: FeatureFlag[];
  updatedAt: string;
}

interface FeatureStageStatus {
  currentStage: 'phase_1' | 'phase_2' | 'phase_3';
  nextStage?: 'phase_2' | 'phase_3';
  projectedUpgradeAt?: string;
  requirements: string[];
  fulfilledRequirements: string[];
}

interface FeatureStatusResponse {
  coupleId: string;
  stageStatus: FeatureStageStatus;
  gatedFeatures: string[];
}
~~~

#### API エンドポイント
- 機能フラグ取得: GET /api/v1/features/{coupleId}
- 機能解放状況取得: GET /api/v1/features/{coupleId}/status

### UX / A11y

#### 表示構成
- ステージタイムライン、機能リスト、アップグレードアクションの3カラム
- モバイルではアコーディオン形式に自動切替

#### アクセシビリティ
- ロック状態はアイコン＋テキスト＋aria-labelで伝達
- タイムラインは有効なHTMLリスト構造で読み上げ可能
- ボタンとリンクにキーボードフォーカススタイル

#### 情緒デザイン
- 未解放機能には期待感のあるビジュアル
- 解放済み機能には達成バッジ
- キャンペーン時にはバナーで期間表示

### セキュリティ & プライバシー
- **認可**: カップル代表または管理者のみ閲覧可
- **通信**: HTTPS/TLS1.3
- **データ取り扱い**: Feature Flagは読み取り専用、書き込みは管理ツールのみ
- **ログ**: 画面アクセスとアップグレードクリックを監査ログへ

### 非機能要件
- **レスポンス**: 機能一覧2秒以内
- **キャッシュ**: 最大5分間ブラウザキャッシュ、手動更新で最新取得
- **可用性**: 99.9%
- **可観測性**: アップグレードクリック率、未解放機能閲覧率、キャッシュヒット率

## 3. 曖昧さと解決

### 機能表示順
- currentStageごとにグループ化し、解放済み→未解放の順
- experimental機能は末尾にまとめ、注意文言を明記

### 次ステージ要件
- requirementsは自然言語と数値条件を併記
- fulfilledRequirementsはチェックリスト形式

### アップグレード権限
- 権限不足時はボタンを無効化し、管理者への連絡導線を表示
- トライアル中はプラン変更ではなくトライアル延長導線

## 4. 受け入れ基準例（Gherkin風）

### 機能表示
~~~gherkin
Given phase_1の機能解放状態である
When 機能解放画面を開く
Then phase_1で利用可能な機能にチェックが表示される
And phase_2の機能にはロックアイコンと解放条件が表示される
~~~

### アップグレード誘導
~~~gherkin
Given ユーザーがpremiumプラン未加入である
When premium限定機能のアップグレードボタンを押す
Then 課金管理画面への遷移確認モーダルが表示される
And 承認後に課金管理画面へ遷移する
~~~

## 5. リスクとトレードオフ

### 技術リスク
- Feature Flagとフロントキャッシュの不整合 → ETagと手動リフレッシュ
- ステージ判定ロジックの複雑化 → サーバー側APIに集約
- 多数機能表示によるパフォーマンス低下 → 仮想リスト採用

### UXリスク
- 情報過多 → カテゴリフィルタと検索
- ロック表示のネガティブ感 → ポジティブメッセージと成功事例
- アップグレード誘導の押し付け感 → 比較表とFAQで納得感醸成

### プライバシーリスク
- ステージ条件の内部情報露出 → 必要情報に限定し抽象化
- アップグレードクリックログの扱い → 個人特定不可の形で集計

## 6. 拡張余地

### 短期拡張
- 条件達成度のパーセンテージ表示
- 通知設定との連携
- 実績バッジコレクション

### 中期拡張
- 機能のA/Bテスト表示
- 自動アップグレード提案
- Webhook経由の開発者向け通知

### 長期拡張
- 多通貨/地域別の解放条件
- 機能マーケットプレイス
- 段階別教育コンテンツ

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: React Query（Feature Flagキャッシュ） + Zustand（UI状態）
- **アニメーション**: Framer Motionでステージ遷移

### コンポーネント設計
~~~typescript
interface FeatureUnlockPageProps {
  coupleId: string;
}

interface StageTimelineProps {
  status: FeatureStatusResponse['stageStatus'];
}

interface FeatureListProps {
  features: FeatureFlag[];
  onUpgradeClick: (featureKey: string) => void;
}
~~~

### スタイリング
~~~css
.feature-unlock-page {
  @apply max-w-5xl mx-auto space-y-8 px-4 py-12;
}

.stage-timeline {
  @apply relative flex flex-col md:flex-row gap-6 bg-white rounded-2xl shadow-md border border-slate-200 p-6;
}

.feature-card {
  @apply bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex flex-col gap-3;
}

.feature-card[data-locked="true"] {
  @apply opacity-70 backdrop-grayscale;
}
~~~

### テレメトリ
- アップグレードボタンクリック率、ステージ遷移頻度、手動更新回数を計測
- 未解放機能の詳細閲覧時間をログし優先開発指標に活用


# UC001-002: AI生成中画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: AI生成処理の進捗表示とユーザーエンゲージメント維持を提供
- **ビジネスゴール**: ユーザー体験の向上とAI機能の信頼性確保
- **技術ゴール**: リアルタイム進捗表示と適切なエラーハンドリングの実現

### 受け入れ基準
- 生成進捗がリアルタイムで表示される
- 推定完了時間が正確に表示される
- 生成処理のキャンセルが可能
- モバイル・デスクトップ両対応のレスポンシブデザイン
- WCAG 2.1 AA準拠のアクセシビリティ

### 機能段階性
1. **基礎**: 進捗表示、推定時間、キャンセル機能
2. **拡張**: 詳細進捗、生成ステップ表示、ヒント表示
3. **制約**: タイムアウト処理、エラー復旧、再試行機能

## 2. 仕様の厳密化

### コア機能

#### 生成進捗取得
- **取得**: リアルタイムでの生成進捗取得
- **表示**: 進捗バーとパーセンテージ表示
- **更新**: 定期的な進捗更新
- **完了**: 生成完了の検知

#### リアルタイム更新
- **ポーリング**: 定期的な進捗取得
- **WebSocket**: リアルタイム進捗通知
- **状態管理**: 進捗状態の管理
- **UI更新**: 進捗に応じたUI更新

#### タイムアウト処理
- **監視**: 生成時間の監視
- **警告**: タイムアウト前の警告
- **処理**: タイムアウト時の処理
- **復旧**: タイムアウト後の復旧

### 入力制約 & バリデーション

#### 進捗値
- **範囲**: 0-100%
- **形式**: 数値のみ
- **更新頻度**: 1秒間隔
- **エラーメッセージ**: "進捗の取得に失敗しました"

#### 推定時間
- **範囲**: 0-300秒
- **形式**: 秒単位
- **更新頻度**: 5秒間隔
- **エラーメッセージ**: "推定時間の計算に失敗しました"

#### 生成ステップ
- **最大数**: 10ステップ
- **形式**: 文字列
- **更新頻度**: ステップ完了時
- **エラーメッセージ**: "ステップ情報の取得に失敗しました"

### データモデル & API

#### リクエストモデル
```typescript
interface ProgressRequest {
  planId: string;
  userId: string;
}

interface CancelRequest {
  planId: string;
  userId: string;
  reason?: string;
}
```

#### レスポンスモデル
```typescript
interface ProgressResponse {
  planId: string;
  status: 'generating' | 'completed' | 'failed' | 'cancelled';
  progress: number; // 0-100
  currentStep: string;
  totalSteps: number;
  completedSteps: number;
  estimatedTimeRemaining: number; // seconds
  startedAt: string;
  updatedAt: string;
}

interface CancelResponse {
  planId: string;
  status: 'cancelled';
  cancelledAt: string;
  reason?: string;
}
```

#### API エンドポイント
- **生成状況取得**: `GET /api/v1/plans/{planId}/status`
- **生成キャンセル**: `POST /api/v1/plans/{planId}/cancel`
- **進捗履歴取得**: `GET /api/v1/plans/{planId}/progress`

### UX / A11y

#### キーボード操作
- **Tab順序**: 進捗表示 → キャンセルボタン → 戻るボタン
- **Enter**: キャンセル確認
- **Escape**: キャンセル
- **Space**: 進捗詳細の表示/非表示

#### スクリーンリーダー対応
- **aria-label**: 進捗バーの説明
- **aria-live**: 進捗更新の読み上げ
- **aria-describedby**: 進捗説明の関連付け
- **role**: 進捗要素の役割定義

#### 色覚対応
- **進捗表示**: 色 + パーセンテージ + テキスト
- **警告表示**: 色 + 警告アイコン + テキスト
- **エラー表示**: 色 + エラーアイコン + テキスト

### セキュリティ & プライバシー

#### データ保護
- **進捗データ**: 暗号化された保存
- **通信**: HTTPS強制、TLS 1.3以上
- **アクセス**: 認証済みユーザーのみ
- **履歴**: 適切なデータ保持期間

#### セキュリティ検証
- **ユーザー認証**: 生成依頼者との一致確認
- **権限確認**: 進捗取得権限の確認
- **データ整合性**: 進捗データの整合性確認

### 非機能要件

#### パフォーマンス
- **進捗取得**: 1秒以内
- **UI更新**: 100ms以内
- **キャンセル処理**: 3秒以内
- **タイムアウト検知**: 5秒以内

#### 可用性
- **稼働率**: 99.9%以上
- **エラー率**: 1%以下
- **復旧時間**: 5分以内

#### スケーラビリティ
- **同時接続**: 10,000ユーザー
- **スループット**: 1,000リクエスト/秒
- **進捗更新**: 100件/秒

## 3. 曖昧さと解決

### 進捗表示
- **リアルタイム**: 1秒間隔での更新
- **スムーズ**: アニメーション付きの進捗表示
- **詳細**: 現在のステップと完了ステップの表示

### タイムアウト処理
- **警告**: タイムアウト前の警告表示
- **自動キャンセル**: タイムアウト時の自動キャンセル
- **再試行**: タイムアウト後の再試行機能

### キャンセル処理
- **確認**: キャンセル前の確認ダイアログ
- **理由**: キャンセル理由の入力
- **復旧**: キャンセル後の復旧機能

## 4. 受け入れ基準例（Gherkin風）

### 進捗表示
```gherkin
Given ユーザーがAI生成中画面にアクセス
When 生成処理が開始される
Then 進捗バーが表示される
And 1秒間隔で更新される

Given ユーザーがAI生成中画面にアクセス
When 生成処理が完了する
Then 進捗が100%になる
And 完了画面に遷移する
```

### キャンセル処理
```gherkin
Given ユーザーがAI生成中画面にアクセス
When キャンセルボタンをクリック
Then 確認ダイアログが表示される
And 確認後に生成処理がキャンセルされる

Given ユーザーがAI生成中画面にアクセス
When 生成処理がタイムアウトする
Then 警告メッセージが表示される
And 自動的にキャンセルされる
```

## 5. リスクとトレードオフ

### 技術リスク
- **進捗取得失敗**: 適切なエラーハンドリング
- **ネットワーク断**: 自動再接続機能
- **タイムアウト**: 適切なタイムアウト設定

### UXリスク
- **進捗遅延**: 適切な進捗表示
- **キャンセル**: 分かりやすいキャンセル機能
- **エラー処理**: 適切なエラーメッセージ

### パフォーマンスリスク
- **頻繁な更新**: 適切な更新頻度
- **メモリ使用量**: 効率的な状態管理
- **ネットワーク負荷**: 適切なポーリング間隔

## 6. 拡張余地

### 短期拡張
- **詳細進捗**: より詳細な進捗表示
- **生成ヒント**: 生成中のヒント表示
- **進捗履歴**: 過去の進捗履歴表示

### 中期拡張
- **予測機能**: 生成時間の予測機能
- **最適化**: 生成処理の最適化
- **分析**: 生成パターンの分析

### 長期拡張
- **AI学習**: 生成パターンの学習
- **自動調整**: 生成時間の自動調整
- **予測**: 未来の生成時間予測

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **HTTP クライアント**: Axios
- **WebSocket**: Socket.io
- **アニメーション**: Framer Motion

### コンポーネント設計
```typescript
// メインコンポーネント
interface AIGeneratingProps {
  planId: string;
  userId: string;
  onComplete: (planId: string) => void;
  onCancel: (planId: string) => void;
  onError: (error: string) => void;
}

// 進捗管理
const useProgress = (planId: string) => {
  const [progress, setProgress] = useState(0);
  const [status, setStatus] = useState<'generating' | 'completed' | 'failed' | 'cancelled'>('generating');
  const [estimatedTime, setEstimatedTime] = useState(0);
  
  useEffect(() => {
    const interval = setInterval(async () => {
      try {
        const response = await getProgress(planId);
        setProgress(response.progress);
        setStatus(response.status);
        setEstimatedTime(response.estimatedTimeRemaining);
        
        if (response.status === 'completed') {
          clearInterval(interval);
        }
      } catch (error) {
        console.error('Progress fetch failed:', error);
      }
    }, 1000);
    
    return () => clearInterval(interval);
  }, [planId]);
  
  return { progress, status, estimatedTime };
};
```

### スタイリング
```css
/* レスポンシブデザイン */
.generating-container {
  @apply max-w-2xl mx-auto p-6 bg-white rounded-lg shadow-md;
}

.progress-section {
  @apply text-center space-y-6;
}

.progress-bar {
  @apply w-full bg-gray-200 rounded-full h-4 overflow-hidden;
}

.progress-fill {
  @apply h-full bg-blue-500 transition-all duration-300 ease-out;
}

.progress-text {
  @apply text-2xl font-bold text-gray-800;
}

.estimated-time {
  @apply text-lg text-gray-600;
}

.current-step {
  @apply text-base text-gray-700;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  .generating-container {
    @apply bg-gray-800;
  }
  .progress-bar {
    @apply bg-gray-700;
  }
  .progress-text {
    @apply text-gray-200;
  }
  .estimated-time {
    @apply text-gray-400;
  }
  .current-step {
    @apply text-gray-300;
  }
}
```

## 8. 日本語サンプルデータ

### 生成進捗データ
```json
{
  "generationProgress": [
    {
      "planId": "plan_001",
      "status": "generating",
      "progress": 45,
      "currentStep": "レストラン検索中",
      "totalSteps": 8,
      "completedSteps": 3,
      "estimatedTimeRemaining": 120,
      "startedAt": "2025-01-27T10:00:00Z",
      "updatedAt": "2025-01-27T10:02:30Z"
    },
    {
      "planId": "plan_002",
      "status": "generating",
      "progress": 78,
      "currentStep": "ルート最適化中",
      "totalSteps": 8,
      "completedSteps": 6,
      "estimatedTimeRemaining": 45,
      "startedAt": "2025-01-27T10:00:00Z",
      "updatedAt": "2025-01-27T10:03:15Z"
    },
    {
      "planId": "plan_003",
      "status": "completed",
      "progress": 100,
      "currentStep": "完了",
      "totalSteps": 8,
      "completedSteps": 8,
      "estimatedTimeRemaining": 0,
      "startedAt": "2025-01-27T10:00:00Z",
      "updatedAt": "2025-01-27T10:04:00Z"
    },
    {
      "planId": "plan_004",
      "status": "failed",
      "progress": 23,
      "currentStep": "エラー発生",
      "totalSteps": 8,
      "completedSteps": 2,
      "estimatedTimeRemaining": 0,
      "startedAt": "2025-01-27T10:00:00Z",
      "updatedAt": "2025-01-27T10:01:30Z"
    },
    {
      "planId": "plan_005",
      "status": "cancelled",
      "progress": 67,
      "currentStep": "キャンセル済み",
      "totalSteps": 8,
      "completedSteps": 5,
      "estimatedTimeRemaining": 0,
      "startedAt": "2025-01-27T10:00:00Z",
      "updatedAt": "2025-01-27T10:02:45Z"
    }
  ]
}
```

### 生成ステップデータ
```json
{
  "generationSteps": [
    {
      "stepId": 1,
      "name": "要件分析",
      "description": "入力された要件を分析しています",
      "estimatedDuration": 10,
      "icon": "analyze"
    },
    {
      "stepId": 2,
      "name": "ユーザープロフィール取得",
      "description": "ユーザーのプロフィール情報を取得しています",
      "estimatedDuration": 5,
      "icon": "profile"
    },
    {
      "stepId": 3,
      "name": "過去履歴分析",
      "description": "過去のデート履歴を分析しています",
      "estimatedDuration": 15,
      "icon": "history"
    },
    {
      "stepId": 4,
      "name": "レストラン検索",
      "description": "条件に合うレストランを検索しています",
      "estimatedDuration": 20,
      "icon": "restaurant"
    },
    {
      "stepId": 5,
      "name": "アクティビティ検索",
      "description": "適切なアクティビティを検索しています",
      "estimatedDuration": 25,
      "icon": "activity"
    },
    {
      "stepId": 6,
      "name": "ルート最適化",
      "description": "最適なルートを計算しています",
      "estimatedDuration": 30,
      "icon": "route"
    },
    {
      "stepId": 7,
      "name": "予算調整",
      "description": "予算に合わせてプランを調整しています",
      "estimatedDuration": 15,
      "icon": "budget"
    },
    {
      "stepId": 8,
      "name": "最終確認",
      "description": "生成されたプランを最終確認しています",
      "estimatedDuration": 10,
      "icon": "check"
    }
  ]
}
```

### 進捗メッセージデータ
```json
{
  "progressMessages": [
    {
      "status": "generating",
      "title": "AI生成中",
      "description": "あなたに最適なデートプランを作成しています",
      "icon": "loading",
      "color": "blue"
    },
    {
      "status": "completed",
      "title": "生成完了",
      "description": "デートプランの生成が完了しました",
      "icon": "check-circle",
      "color": "green"
    },
    {
      "status": "failed",
      "title": "生成失敗",
      "description": "デートプランの生成に失敗しました",
      "icon": "error",
      "color": "red"
    },
    {
      "status": "cancelled",
      "title": "生成キャンセル",
      "description": "デートプランの生成がキャンセルされました",
      "icon": "cancel",
      "color": "gray"
    }
  ]
}
```

### タイムアウト警告データ
```json
{
  "timeoutWarnings": [
    {
      "threshold": 180,
      "message": "生成に時間がかかっています。もう少しお待ちください。",
      "icon": "clock",
      "color": "yellow"
    },
    {
      "threshold": 240,
      "message": "生成に予想以上の時間がかかっています。しばらくお待ちください。",
      "icon": "warning",
      "color": "orange"
    },
    {
      "threshold": 300,
      "message": "生成がタイムアウトしました。再試行しますか？",
      "icon": "error",
      "color": "red"
    }
  ]
}
```

### エラーメッセージ
```json
{
  "errorMessages": {
    "progressFetch": {
      "networkError": "進捗の取得に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "進捗の取得がタイムアウトしました",
      "unauthorized": "進捗の取得権限がありません"
    },
    "cancel": {
      "networkError": "キャンセル処理に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "キャンセル処理がタイムアウトしました",
      "alreadyCompleted": "生成は既に完了しています"
    },
    "general": {
      "networkError": "ネットワークエラーが発生しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "タイムアウトが発生しました",
      "unknown": "不明なエラーが発生しました"
    }
  }
}
```

### 成功メッセージ
```json
{
  "successMessages": {
    "progressUpdated": "進捗が更新されました",
    "generationCompleted": "生成が完了しました",
    "generationCancelled": "生成がキャンセルされました",
    "retryInitiated": "再試行を開始しました"
  }
}
```

## 9. 最終チェックリスト

### 機能要件
- [ ] 生成進捗取得機能が正常に動作する
- [ ] リアルタイム更新機能が正常に動作する
- [ ] タイムアウト処理機能が正常に動作する
- [ ] キャンセル機能が正常に動作する
- [ ] 進捗表示機能が正常に動作する

### 非機能要件
- [ ] レスポンシブデザインが実装されている
- [ ] アクセシビリティ（WCAG 2.1 AA）に準拠している
- [ ] パフォーマンス要件を満たしている
- [ ] セキュリティ要件が実装されている
- [ ] エラー率が許容範囲内である

### ユーザビリティ
- [ ] 直感的なUI/UXが実装されている
- [ ] 適切なフィードバックが提供されている
- [ ] 進捗表示が分かりやすい
- [ ] エラーメッセージが分かりやすい
- [ ] キーボード操作が可能である

### セキュリティ
- [ ] 進捗データが適切に保護されている
- [ ] HTTPS通信が強制されている
- [ ] 認証・認可が適切に実装されている
- [ ] データ整合性が確保されている
- [ ] セキュリティ検証が実装されている

### 技術要件
- [ ] リアルタイム更新が適切に実装されている
- [ ] タイムアウト処理が適切に実装されている
- [ ] キャンセル処理が適切に実装されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] 状態管理が適切に実装されている

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: ソフトウェアエンジニア・UX/UIデザイナー  
**承認者**: [承認者名]  
**レビュー者**: [レビュー者名]

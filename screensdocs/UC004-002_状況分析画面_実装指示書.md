# UC004-002: 状況分析画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: 仲裁依頼後の状況分析結果をリアルタイムで可視化し、カップルに共有
- **ビジネスゴール**: 分析進捗の透明化による利用継続と信頼向上
- **技術ゴール**: 複数APIからの分析結果を統合し、洞察として安定表示

### 受け入れ基準
- 最初の分析結果が30秒以内に表示される
- 感情分析指標が5秒ごとに更新される
- 進捗率は100%になるまで5%刻みで滑らかに表示
- 可視化チャートは支援技術利用でも読み取れる代替テキストを提供
- エラー発生時には自動再試行とサポート導線を表示

### 機能段階性
1. **基礎**: 分析結果取得、感情分析取得、進捗表示、可視化レンダリング
2. **拡張**: 異常検知アラート、関係性サマリー、履歴比較
3. **制約**: 更新頻度上限、チャート点数上限、表示期間フィルタ

## 2. 仕様の厳密化

### コア機能

#### 分析結果取得
- **取得**: mediationIdをもとに分析サマリー・根本原因・推奨アクションを取得
- **表示**: タブ構造でカテゴリ別に提示
- **更新**: 30秒ごとに再取得（最大10回）

#### 感情分析結果取得
- **取得**: 個別ユーザーの感情スコアとトーン推移
- **表示**: レーダーチャートと折れ線チャートで可視化
- **更新**: 5秒間隔でポーリング、最大60秒

#### 分析進捗取得
- **取得**: 現在の処理ステップと完了率
- **表示**: ステップチャートとプログレスバーを同期表示
- **完了**: 100%達成時に次画面への遷移誘導を活性化

#### ナレッジ提示
- **関連知識**: 類似ケースの成功事例をハイライト
- **アラート**: 深刻リスク時に警告を表示

### 入力制約 & バリデーション

#### mediationId
- **形式**: UUID v4
- **必須**: URLパラメータで必須
- **エラーメッセージ**: "仲裁IDを確認してください"

#### pollingInterval
- **形式**: 数値（秒）
- **範囲**: 5〜30
- **エラーメッセージ**: "更新間隔が許容範囲を超えています"

### データモデル & API

#### リクエストモデル
~~~typescript
interface AnalysisRequest {
  mediationId: string;
}

interface EmotionMetricsRequest {
  mediationId: string;
  window?: number;
}

interface ProgressRequest {
  mediationId: string;
}
~~~

#### レスポンスモデル
~~~typescript
interface ConflictAnalysisResponse {
  mediationId: string;
  summary: string;
  rootCauses: string[];
  riskLevel: 'low' | 'medium' | 'high' | 'critical';
  recommendedTopics: string[];
  generatedAt: string;
}

interface EmotionMetricPoint {
  timestamp: string;
  partnerA: number; // -1 to 1
  partnerB: number; // -1 to 1
  toneLabel: 'calm' | 'tense' | 'hostile' | 'hopeful';
}

interface EmotionMetricsResponse {
  mediationId: string;
  currentScores: {
    partnerA: number;
    partnerB: number;
  };
  trends: EmotionMetricPoint[];
}

interface AnalysisProgressResponse {
  mediationId: string;
  status: 'queued' | 'analyzing' | 'completed';
  progressPercent: number;
  currentStep: 'data_ingest' | 'conflict_mapping' | 'emotion_scoring' | 'proposal_preparation';
  estimatedCompletionAt?: string;
}
~~~

#### API エンドポイント
- **分析結果取得**: GET /api/v1/mediation/{mediationId}/analysis
- **感情分析取得**: GET /api/v1/mediation/{mediationId}/emotions
- **進捗取得**: GET /api/v1/mediation/{mediationId}/progress

### UX / A11y

#### 可視化
- 音声読み上げ用に要約テキストとデータテーブルを併設
- チャート色はコントラスト比4.5:1を満たす
- プログレスバーにはaria-valuenow / aria-valuetextを設定

#### フィードバック
- 更新中はローディングスケルトンとアニメーションインジケータを表示
- 異常検知時は警告バナーとサポートリンクを表示
- 完了時はポジティブなメッセージと次ステップボタンを活性化

#### キーボード操作
- タブでセクション間移動、矢印キーでチャート期間を変更
- Enterで詳細モーダルを開閉
- Escでモーダルを閉じる

### セキュリティ & プライバシー
- **アクセス制御**: 認証済みかつ該当カップルメンバーのみ
- **データ保持**: 分析結果ビュー履歴は7日で自動削除
- **ログ**: 感情スコアなど機密情報はPIIを含めない形で集計
- **送信制御**: HTTPS/TLS1.3以上

### 非機能要件
- **パフォーマンス**: 初期読み込み 30秒以内、再取得時 2秒以内
- **リアルタイム性**: ポーリングは最大60秒で自動停止
- **可用性**: 99.9%稼働、分析API失敗率1%未満
- **可観測性**: 進捗ステップ滞留をメトリクス化

## 3. 曖昧さと解決

### 進捗定義
- progressPercentは0〜100まで5刻み、statusと同期
- estimatedCompletionAtが空の場合は「計測中」表示

### 感情スコアの範囲
- -1: 非常にネガティブ、0: 中立、1: 非常にポジティブ
- toneLabelはヒートマップ凡例に一致させる

### 再試行制御
- 3連続でAPI失敗時は自動更新停止し手動再試行へ誘導
- 再試行成功でカウンタリセット

## 4. 受け入れ基準例（Gherkin風）

### 進捗表示
~~~gherkin
Given ユーザーが状況分析画面を開く
When 分析進捗が取得される
Then プログレスバーが現在の進捗率を表示する
And ステップ表示が現在ステップをハイライトする

Given 分析が完了状態である
When 最新進捗を取得する
Then 進捗率が100%で表示される
And 次の仲裁提案画面へのボタンが活性化される
~~~

### 感情分析
~~~gherkin
Given ユーザーが状況分析画面を開く
When 感情分析APIが5秒間隔で更新される
Then レーダーチャートと折れ線チャートが最新スコアを反映する
And 60秒経過で自動更新が停止しガイダンスが表示される
~~~

## 5. リスクとトレードオフ

### 技術リスク
- ポーリング負荷 → バックオフ制御とエッジキャッシュで緩和
- チャートレンダリング性能 → 仮想化と軽量ライブラリを採用
- APIデータ不整合 → レスポンスバリデーションとフェイルセーフ表示

### UXリスク
- 情報量過多 → タブ分割と要約カードで整理
- 分析遅延 → プログレス推察メッセージで安心感を提供
- 感情スコア誤解 → 説明ツールチップと凡例で補足

### プライバシーリスク
- 感情データの過剰共有 → 表示範囲をカップル内に限定
- ログへの機密流出 → マスキングとアクセス制御

## 6. 拡張余地

### 短期拡張
- 類似ケース比較モジュール
- 感情トレンドの自然言語サマリー
- ステップごとの説明動画

### 中期拡張
- 行動パターンとの相関分析
- 過去セッションとの差分ハイライト
- 進捗アラートの通知連携

### 長期拡張
- 多言語対応
- 専門家レビューとのハイブリッド表示
- 自動介入タイミングのパーソナライズ

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS + D3 or Recharts
- **状態管理**: Zustand（分析結果キャッシュ、ポーリング制御）
- **データ取得**: React Query互換のフェッチユーティリティ
- **リアルタイム制御**: AbortControllerによるポーリング停止

### コンポーネント設計
~~~typescript
interface AnalysisDashboardProps {
  mediationId: string;
  onCompleted: (mediationId: string) => void;
}

interface EmotionChartProps {
  data: EmotionMetricsResponse | null;
  loading: boolean;
  pollingActive: boolean;
  onStopPolling: () => void;
}

interface ProgressTrackerProps {
  progress: AnalysisProgressResponse | null;
  loading: boolean;
}
~~~

### スタイリング
~~~css
.analysis-page {
  @apply max-w-5xl mx-auto space-y-8 px-4 py-8;
}

.section-grid {
  @apply grid grid-cols-1 xl:grid-cols-2 gap-6;
}

.progress-card {
  @apply bg-white rounded-xl shadow-sm border border-indigo-100;
}

.chart-card {
  @apply bg-white rounded-xl shadow-md border border-slate-200;
}

.alert-banner {
  @apply flex items-center gap-3 px-4 py-3 rounded-lg bg-rose-50 text-rose-700;
}
~~~

### テレメトリ
- ポーリング回数、失敗回数、完了所要時間を送信
- 感情スコア変化が急激な場合はアラートイベントを記録


# UC005-005: アルバム生成画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: Date Canvasで蓄積したメディア・メモを自動レイアウトし、デート直後に共有可能なプライベートアルバムを生成
- **ビジネスゴール**: 余韻体験の強化と有料テンプレート・プリント販売への導線創出
- **技術ゴール**: バックエンド生成ジョブとの非同期連携とリアルタイム進捗可視化

### 受け入れ基準
- 生成依頼から進捗表示まで2秒以内に初期レスポンスを返す
- 生成完了時に自動でプレビューへ遷移し、失敗時はリトライ導線を表示
- プレビューはPC・モバイル双方で1秒以内に表示
- 編集保存後は差分のみ送信し2秒以内に反映
- アルバムデータはWCAG 2.1 AAに準拠しスクリーンリーダーで主要情報を読み上げ可能

### 機能段階性
1. **基礎**: アルバム生成依頼、進捗取得、結果表示、編集保存
2. **拡張**: テンプレート選択、BGM設定、共有リンク生成
3. **制約**: 生成リトライ3回まで、ページ数上限40P、メディア数上限200件

## 2. 仕様の厳密化

### コア機能

#### アルバム生成依頼
- **送信**: POST /api/v1/dates/{dateId}/album
- **入力**: テーマ、ページ数希望、ハイライト指定
- **応答**: キューイング結果とestimatedCompletionAtを返却

#### 生成進捗取得
- **取得**: GET /api/v1/dates/{dateId}/album/status
- **更新**: 5秒間隔でポーリング（最大10分）
- **状態**: queued, processing, rendering, failed, completed

#### アルバム取得
- **取得**: GET /api/v1/dates/{dateId}/album
- **内容**: ページ配列、レイアウト、本文、メディアURL
- **キャッシュ**: ETagで差分取得

#### アルバム編集
- **送信**: PUT /api/v1/dates/{dateId}/album
- **操作**: ページ順序変更、キャプション編集、メディア差し替え
- **検証**: レイアウト制約をバリデーションし、NG時は詳細メッセージ

#### プレビュー表示
- **表現**: ページめくりアニメーションとサムネイルナビゲーション
- **アクセシビリティ**: ページごとの代替テキスト、キーボード操作

### 入力制約 & バリデーション

#### theme
- **形式**: enum(default | romantic | playful | premium)
- **必須**: 必須
- **エラーメッセージ**: "テーマを選択してください"

#### highlightNodeIds
- **形式**: ノードID配列（最大20件）
- **必須**: 任意
- **エラーメッセージ**: "ハイライトは20件以内で選択してください"

#### caption
- **形式**: 0〜120文字
- **必須**: 任意
- **エラーメッセージ**: "120文字以内で入力してください"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface AlbumGenerationRequest {
  theme: 'default' | 'romantic' | 'playful' | 'premium';
  highlightNodeIds?: string[];
  preferredPageCount?: number;
}

interface AlbumStatusResponse {
  dateId: string;
  status: 'queued' | 'processing' | 'rendering' | 'failed' | 'completed';
  progressPercent: number;
  estimatedCompletionAt?: string;
  failureReason?: string;
}

interface AlbumPage {
  pageId: string;
  layout: 'full_photo' | 'collage' | 'timeline' | 'quote';
  media: AlbumMedia[];
  caption?: string;
  accentColor?: string;
}

interface AlbumMedia {
  mediaId: string;
  type: 'image' | 'video' | 'note';
  url: string;
  thumbnailUrl: string;
  altText: string;
}

interface AlbumResponse {
  albumId: string;
  dateId: string;
  theme: AlbumGenerationRequest['theme'];
  pages: AlbumPage[];
  generatedAt: string;
  version: number;
}

interface AlbumUpdatePayload {
  albumId: string;
  version: number;
  pages: AlbumPage[];
}
~~~

#### API エンドポイント
- アルバム生成依頼: POST /api/v1/dates/{dateId}/album
- 生成進捗取得: GET /api/v1/dates/{dateId}/album/status
- アルバム取得: GET /api/v1/dates/{dateId}/album
- アルバム編集: PUT /api/v1/dates/{dateId}/album

### UX / A11y

#### 進捗表示
- ステップ指標（抽出 → レイアウト → レンダリング）とプログレスバーを二重表示
- ポーリング停止後は手動更新ボタンを表示
- 失敗時はガイダンスとサポートリンク

#### プレビュー
- キーボード左右矢印でページ移動、Home/Endで先頭末尾
- ページ要約テキストをaria-describedbyで読み上げ
- 高画質モードと軽量モードを切替

#### 編集UI
- ドラッグ&ドロップでページ並び替え、フォーカス不可時は矢印操作
- カラー選択はコントラスト表示とプレビュー
- 動画ページは自動再生無効とラベル付け

### セキュリティ & プライバシー
- **認証**: dateIdと所属チェック、共有リンクは署名付きURL
- **ストレージ**: 生成アルバムはAES-256で暗号化、閲覧時に一時復号
- **ログ**: アクセスログに個人識別情報を残さない
- **保持期間**: アルバム原データは365日保持後にアーカイブ

### 非機能要件
- **生成時間**: 通常5分以内、上限10分
- **プレビュー**: 初回レンダリング1秒以内、ページ遷移200ms以内
- **耐障害性**: 失敗時はバックアップジョブへ自動フェイルオーバー
- **可観測性**: ジョブキュー滞留、失敗率、編集回数をメトリクス化

## 3. 曖昧さと解決

### 生成再依頼
- 失敗時は最大3回まで自動再試行
- テーマ変更時は新規ジョブとして扱い既存アルバムを保持

### ページ制約
- 1ページあたりメディア最大4件、テキスト500文字
- 動画は1ページ1件まで、長さは30秒以内にトリミング

### 差分保存
- PUT時にversionチェック、衝突時は比較ダイアログ
- 差分成功後に最新バージョンを再取得

## 4. 受け入れ基準例（Gherkin風）

### 生成フロー
~~~gherkin
Given ユーザーがアルバム生成画面でテーマを選択する
When 生成依頼を送信する
Then 2秒以内に進捗モジュールが表示される
And ステータスがqueuedからprocessingへ遷移する
~~~

### プレビュー編集
~~~gherkin
Given 生成済みアルバムを閲覧中のユーザー
When ページのキャプションを更新して保存する
Then 2秒以内に保存完了トーストが表示される
And 新しいキャプションがプレビューに反映される
~~~

## 5. リスクとトレードオフ

### 技術リスク
- 生成ジョブ滞留 → キュー監視と容量自動スケール
- メディア欠落 → フォールバック画像と欠損通知
- 動画処理遅延 → 事前トランスコードとタイムアウト対応

### UXリスク
- 待ち時間ストレス → 進捗ステップとメッセージで安心感提供
- レイアウト不満 → 手動編集とテンプレート変更で調整
- モバイルでの操作性 → 軽量プレビューとタッチ最適化

### プライバシーリスク
- 共有リンク漏洩 → 有効期限付きリンクとアクセスログ
- メタデータ露出 → EXIF削除と表示範囲制御

## 6. 拡張余地

### 短期拡張
- テンプレートマーケットプレイス
- オフライン閲覧用ダウンロード
- 感情キーワード自動抽出

### 中期拡張
- フォトプリント連携
- 音声ナレーション統合
- コラボ編集（同時編集）

### 長期拡張
- 3Dアルバム表示
- VR/AR再生
- AIフォトレタッチ

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: React Query + Zustand
- **アニメーション**: Framer Motionでページトランジション
- **アクセシビリティ**: Headless UI + 自前ラベル制御

### コンポーネント設計
~~~typescript
interface AlbumGenerationPageProps {
  dateId: string;
  userId: string;
}

interface AlbumProgressProps {
  status: AlbumStatusResponse;
  onRetry: () => void;
}

interface AlbumPreviewProps {
  album: AlbumResponse;
  onReorder: (pages: AlbumPage[]) => void;
  onCaptionUpdate: (pageId: string, caption: string) => void;
}
~~~

### スタイリング
~~~css
.album-page {
  @apply max-w-5xl mx-auto space-y-8 px-4 py-10;
}

.progress-panel {
  @apply bg-white rounded-2xl shadow-md border border-slate-200 p-6 space-y-4;
}

.preview-stage {
  @apply relative bg-slate-900 text-white rounded-3xl overflow-hidden shadow-2xl;
}

.page-thumbnails {
  @apply flex overflow-x-auto gap-3 py-4 px-2 bg-white/80 backdrop-blur;
}
~~~

### テレメトリ
- 生成依頼数、完了率、平均生成時間
- 編集操作数、テンプレート変更率、離脱ポイントを収集


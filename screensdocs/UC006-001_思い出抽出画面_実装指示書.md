# UC006-001: 思い出抽出画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: Date Canvasのデータからベストモーメントを自動抽出し、ユーザーに透明性のある形で提示
- **ビジネスゴール**: Memory Sparksフローの起点を強化し、感謝メッセージ送信率を高める
- **技術ゴール**: バッチ抽出ジョブとの安定した非同期連携と抽出結果の検証可能性

### 受け入れ基準
- 抽出依頼送信から初回レスポンスまで1秒以内
- 抽出進捗が5秒間隔で更新され、最大60秒で結果が表示される
- 抽出結果がゼロの場合は代替テンプレートを提示
- 抽出内容はユーザーが編集・除外できる
- WCAG 2.1 AA準拠の画面構成とスクリーンリーダー対応

### 機能段階性
1. **基礎**: 抽出依頼、進捗表示、結果表示、再抽出
2. **拡張**: 抽出理由説明、信頼度スコア、類似事例表示
3. **制約**: 抽出対象期間30日以内、最大候補数10件、再抽出上限3回

## 2. 仕様の厳密化

### コア機能

#### 抽出依頼
- **送信**: POST /api/v1/memories/extract
- **入力**: dateId、抽出タイプ（言葉、写真、出来事）
- **応答**: 抽出ジョブIDと推定完了時刻

#### 抽出進捗取得
- **取得**: GET /api/v1/memories/{dateId}/progress
- **更新**: 5秒間隔ポーリング（最大12回）
- **状態**: queued, analyzing, summarizing, completed, failed

#### 抽出結果取得
- **取得**: GET /api/v1/memories/{dateId}
- **内容**: 抽出メモ、写真サマリー、スコア、ハイライト
- **キャッシュ**: 10分間メモリキャッシュ

#### 結果調整
- **操作**: 抽出アイテムのピン留め、除外、メモ追記
- **同期**: 調整結果はUC006-002へ引き渡し

### 入力制約 & バリデーション

#### dateId
- **形式**: UUID v4
- **必須**: 必須
- **エラーメッセージ**: "デートIDを確認してください"

#### extractionType
- **形式**: enum(quote | photo | highlight)
- **必須**: 任意（未指定は総合抽出）
- **エラーメッセージ**: "抽出タイプが不正です"

#### retryCount
- **制限**: 1セッション3回まで
- **エラーメッセージ**: "再抽出回数の上限に達しました"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface MemoryExtractionRequest {
  dateId: string;
  extractionType?: 'quote' | 'photo' | 'highlight';
  includeSentiment?: boolean;
}

interface ExtractionProgressResponse {
  dateId: string;
  status: 'queued' | 'analyzing' | 'summarizing' | 'completed' | 'failed';
  progressPercent: number;
  estimatedCompletionAt?: string;
  blockingReason?: string;
}

interface MemoryHighlight {
  highlightId: string;
  type: 'quote' | 'photo' | 'moment';
  title: string;
  description: string;
  mediaUrl?: string;
  confidenceScore: number;
  sentiment: 'positive' | 'neutral' | 'mixed';
  sourceNodeId?: string;
}

interface MemoryExtractionResponse {
  dateId: string;
  highlights: MemoryHighlight[];
  generatedAt: string;
  extractionType?: MemoryExtractionRequest['extractionType'];
}
~~~

#### API エンドポイント
- 思い出抽出依頼: POST /api/v1/memories/extract
- 抽出結果取得: GET /api/v1/memories/{dateId}
- 抽出進捗取得: GET /api/v1/memories/{dateId}/progress

### UX / A11y

#### 進捗UI
- ステップと進捗バーを併記し、ステータス文言をaria-liveで通知
- 進捗完了後に自動スクロールで結果セクションをフォーカス

#### 結果リスト
- ハイライトカードはタブキーで移動可能、Enterで詳細展開
- 信頼度スコアを視覚（ゲージ）とテキストで表示
- 除外操作は確認モーダルとUndo導線

#### 再抽出
- 再抽出ボタンはサブアクションとして配置し、回数カウンタを表示
- 再抽出時のステータスをトースト通知

### セキュリティ & プライバシー
- **アクセス制御**: dateIdとユーザー所属の一致を検証
- **データ保護**: 抽出結果は匿名化された分析ログで保存
- **通信**: HTTPS/TLS1.3
- **権限**: 抽出結果の共有はパートナーのみ閲覧可

### 非機能要件
- **レスポンス**: 抽出依頼の同期レスポンス1秒以内
- **ジョブ時間**: 最大60秒、平均30秒
- **可用性**: 99.9%、失敗率5%未満
- **可観測性**: ジョブ成功率、再抽出率、失敗原因を計測

## 3. 曖昧さと解決

### 抽出ゼロ件
- 代替テンプレート（ポジティブメッセージ）を3件提示
- 再抽出ボタンを活性化し、入力支援のヒントを表示

### 信頼度表示
- confidenceScoreは0〜1を百分率で表示
- 0.6未満は黄色警告ラベル、0.8以上は推奨バッジ

### 抽出タイプ併用
- 複数タイプ選択時は優先順位をquotes → photo → highlightで処理
- ハイライト上限10件を超える場合はカテゴリ別に分割

## 4. 受け入れ基準例（Gherkin風）

### 抽出成功
~~~gherkin
Given Date Canvasに十分な記録がある
When ユーザーが思い出抽出を開始する
Then 60秒以内に抽出結果がカードとして表示される
And 各カードに信頼度スコアが表示される
~~~

### 抽出失敗
~~~gherkin
Given 抽出エンジンがエラーを返した
When ユーザーが結果表示を待つ
Then 失敗バナーと再抽出ボタンが表示される
And サポートへのリンクが提示される
~~~

## 5. リスクとトレードオフ

### 技術リスク
- 抽出時間変動 → ジョブ優先度制御とキュー監視
- 感情分析精度 → モデル評価としきい値チューニング
- データ欠落 → Date Canvasとの同期チェック

### UXリスク
- 結果の納得感不足 → 抽出理由をツールチップで説明
- 待ち時間ストレス → 心拍的なローディングアニメーション
- 過剰通知 → トースト頻度制御

### プライバシーリスク
- 個人情報抽出 → NERフィルタで人名・住所をマスク
- ハイライト共有範囲 → パートナー以外への共有を遮断

## 6. 拡張余地

### 短期拡張
- 抽出理由の自然言語説明
- ハイライトタグ付け
- 外部音楽連携（BGM候補）

### 中期拡張
- 連続デートのクロス分析
- カスタム抽出テンプレート
- 情緒変化ヒートマップ

### 長期拡張
- マルチメディア要約（動画編集）
- 音声抽出・読み上げ
- AIコーチングメッセージ

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: React Query（ジョブ管理） + Zustand（UI状態）
- **グラフ表示**: Rechartsでスコアヒストリー

### コンポーネント設計
~~~typescript
interface MemoryExtractionPageProps {
  dateId: string;
}

interface ExtractionProgressProps {
  progress: ExtractionProgressResponse | null;
  polling: boolean;
  onCancel: () => void;
}

interface HighlightListProps {
  highlights: MemoryHighlight[];
  onPin: (highlightId: string) => void;
  onDismiss: (highlightId: string) => void;
}
~~~

### スタイリング
~~~css
.memory-extraction-page {
  @apply max-w-4xl mx-auto space-y-8 px-4 py-10;
}

.progress-section {
  @apply bg-white rounded-2xl shadow-md border border-slate-200 p-6;
}

.highlight-grid {
  @apply grid grid-cols-1 md:grid-cols-2 gap-6;
}

.highlight-card {
  @apply bg-white rounded-2xl shadow-sm border border-indigo-100 p-5 flex flex-col gap-4;
}
~~~

### テレメトリ
- 抽出依頼数、成功率、平均時間、再抽出率を計測
- ハイライトのピン留め/除外アクションをログし推薦改善に活用


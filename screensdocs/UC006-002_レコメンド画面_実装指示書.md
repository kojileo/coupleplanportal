# UC006-002: レコメンド画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: 抽出されたハイライトを基に、余韻を高めるメッセージやアクションアイデアをレコメンド
- **ビジネスゴール**: 感謝メッセージ送信率と継続利用率の向上、パーソナライズ価値の最大化
- **技術ゴール**: レコメンドモデル結果の安定表示とユーザー選好フィードバックの収集

### 受け入れ基準
- レコメンドカードが3件以上、3秒以内に表示される
- カードは優先度順に並び、詳細を展開可能
- レコメンド再生成は1セッション2回まで、応答2秒以内
- 選択結果はMemory Sparks送信フローへ確実に引き渡される
- アクセシビリティ: カード操作がキーボードとスクリーンリーダーで完結

### 機能段階性
1. **基礎**: レコメンド取得、詳細表示、再生成、選択確定
2. **拡張**: ソート/フィルタ、根拠表示、マルチユーザー比較
3. **制約**: カード上限10件、再生成上限2回、選択は1件のみ

## 2. 仕様の厳密化

### コア機能

#### レコメンド取得
- **取得**: GET /api/v1/recommendations/{memoryId}
- **内容**: タイトル、説明、想定効果、実施時間、必要準備
- **失敗**: フォールバックテンプレート提示と再取得

#### レコメンド生成
- **送信**: POST /api/v1/recommendations/generate
- **入力**: memoryId、ユーザー嗜好、送信タイミング
- **制御**: 再生成上限チェック、クールダウン10秒

#### レコメンド選択
- **送信**: POST /api/v1/recommendations/{recId}/select
- **結果**: 選択結果と推奨送信タイミング、次ステップ案内

#### カード表示
- **構成**: 情緒スコア、実施難易度、準備時間メタデータ
- **操作**: 展開モーダルで詳細説明と推奨メッセージ

### 入力制約 & バリデーション

#### memoryId
- **形式**: UUID v4
- **必須**: 必須
- **エラーメッセージ**: "思い出IDを確認してください"

#### preferences
- **形式**: キー:値の配列（最大10件）
- **制約**: 各値100文字以内
- **エラーメッセージ**: "嗜好設定が不正です"

#### recId
- **形式**: UUID v4
- **必須**: 選択時に必須
- **エラーメッセージ**: "レコメンドを選択してください"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface RecommendationCard {
  recId: string;
  title: string;
  summary: string;
  rationale: string;
  estimatedImpact: 'low' | 'medium' | 'high';
  effortLevel: 'light' | 'standard' | 'deep';
  timeRequiredMinutes: number;
  suggestedMessage?: string;
  sentimentBoostScore: number;
  tags: string[];
}

interface RecommendationListResponse {
  memoryId: string;
  recommendations: RecommendationCard[];
  generatedAt: string;
  expiresAt: string;
}

interface RecommendationGeneratePayload {
  memoryId: string;
  preferences?: Record<string, string>;
  desiredTone?: 'warm' | 'playful' | 'formal';
}

interface RecommendationSelectResponse {
  recId: string;
  followUpTargetAt: string;
  nextStep: 'customize_message' | 'schedule_send';
}
~~~

#### API エンドポイント
- レコメンド取得: GET /api/v1/recommendations/{memoryId}
- レコメンド生成: POST /api/v1/recommendations/generate
- レコメンド選択: POST /api/v1/recommendations/{recId}/select

### UX / A11y

#### カード体験
- 優先度順に縦リスト表示、ホバーとフォーカスで陰影強調
- 情緒スコアをゲージとテキストで併記
- タグは読み上げ対応、aria-labelで補足

#### 操作フロー
- 再生成ボタンはヘッダーに配置し回数を表示
- 選択ボタン押下時に確認モーダル、戻る導線
- 選択完了でMemory Sparks送信ボタンを活性化

#### アクセシビリティ
- カード全体をbutton roleで提供し内部要素はaria-hidden
- 選択状態はaria-pressed、aria-liveで通知
- キーボードショートカット: 上下キーで移動、Enterで選択

### セキュリティ & プライバシー
- **アクセス制御**: memoryIdを所有するカップルのみ閲覧可
- **データ保持**: 推奨履歴は30日保持、匿名化して学習データへ
- **通信**: HTTPS/TLS1.3
- **ロギング**: 嗜好情報は暗号化されたコンテキストで保存

### 非機能要件
- **レスポンス**: 初回取得3秒以内、再生成2秒以内
- **可用性**: 99.9%、レコメンドAPI失敗率3%未満
- **スケール**: 同時生成リクエスト 2,000件/分
- **可観測性**: 推奨受諾率、拒否率、再生成率を計測

## 3. 曖昧さと解決

### レコメンドの有効期限
- expiresAtを過ぎた場合は再生成を促す
- 期限切れカードは淡色表示し選択不可

### 優先度指標
- estimatedImpactを優先ソート、同値はsentimentBoostScoreで降順
- ユーザー嗜好に合致しないカードは低優先度へ

### 再生成ポリシー
- 再生成は嗜好を再評価し新規カードを提供
- 同一カードが3回以上連続で提示された場合は除外

## 4. 受け入れ基準例（Gherkin風）

### レコメンド表示
~~~gherkin
Given 抽出結果が存在する
When レコメンド画面を開く
Then 3件以上のレコメンドカードが優先度順に表示される
And 各カードに想定効果と所要時間が表示される
~~~

### レコメンド選択
~~~gherkin
Given ユーザーがカードを選択する
When 確認モーダルで確定する
Then レコメンド選択APIが成功レスポンスを返す
And 次のメッセージカスタマイズへの誘導ボタンが活性化される
~~~

## 5. リスクとトレードオフ

### 技術リスク
- モデル応答遅延 → キャッシュと漸進レンダリングで対応
- 同期エラー → idempotency keyで重複排除
- 嗜好データ不足 → 明示的設定フォームで補完

### UXリスク
- カードの情報量過多 → 段階的開閉、アイコン化
- 期待外れなレコメンド → ブロック理由入力導線
- 再生成待ち時間 → スケルトンカードで緩和

### プライバシーリスク
- 嗜好漏洩 → 暗号化ストレージとアクセス監査
- 推奨コンテンツの外部共有 → リンク生成時に同意確認

## 6. 拡張余地

### 短期拡張
- レコメンド根拠説明
- タグ別フィルタ
- カードお気に入り機能

### 中期拡張
- 送信タイミングスケジューラ連携
- パートナー別推奨比較
- 外部ギフト連携

### 長期拡張
- 会話AIとの対話型提案
- クロスカップル分析による提案
- AR/音声提案形式

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: React Query + Zustand
- **アニメーション**: Framer Motionカードアニメーション

### コンポーネント設計
~~~typescript
interface RecommendationPageProps {
  memoryId: string;
  onSelect: (recId: string) => void;
}

interface RecommendationCardProps {
  card: RecommendationCard;
  selected: boolean;
  onSelect: (recId: string) => void;
}

interface RegenerateButtonProps {
  remaining: number;
  onRegenerate: () => void;
  loading: boolean;
}
~~~

### スタイリング
~~~css
.recommendation-page {
  @apply max-w-4xl mx-auto space-y-8 px-4 py-10;
}

.recommendation-grid {
  @apply grid grid-cols-1 md:grid-cols-2 gap-6;
}

.recommendation-card {
  @apply bg-white rounded-2xl shadow-sm border border-slate-200 p-5 flex flex-col gap-4 transition-transform hover:-translate-y-1;
}

.recommendation-card[data-selected="true"] {
  @apply border-indigo-500 shadow-lg;
}
~~~

### テレメトリ
- レコメンド表示数、クリック率、選択率、再生成回数を記録
- 拒否理由やフィードバックを分類しモデル改善へ送信


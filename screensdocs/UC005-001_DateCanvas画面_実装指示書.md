# UC005-001: Date Canvas画面 実装指示書

## 1. 画面概要

### 1.1 画面名
Date Canvas 画面

### 1.2 画面ID
UC005-001

### 1.3 目的とゴール
- デートの思い出をキャンバス上に自由に記録し、視覚化する
- パートナーとリアルタイムで共同編集できるボードを提供する
- カテゴリ別・タイムライン別に思い出を整理する
- Mapレイヤーと切り替えて思い出を地図ベースで俯瞰できる
- 位置情報ピン専用画面（UC005-002）との連携はバックログとして扱う

### 1.4 アクセス元
- ダッシュボード (COMMON-001)
- デートプラン詳細画面 (UC001-004)
- 共同編集ボード (UC002-001)

## 2. UI設計

### 2.1 レイアウト概要
```
┌────────────────────────────────────┐
│ ナビゲーションバー                                   │
├────────────────────────────────────┤
│ ヘッダー                                             │
│ - タイトル: "Date Canvas"                            │
│ - ボタン: [戻る] [マップ表示] [共有]                 │
├────────────────────────────────────┤
│         │ サイドパネル                                │
│ Canvas │ - フィルタ                                  │
│  Area  │ - メモ一覧                                  │
│         │ - タグ/カテゴリ編集                         │
├────────────────────────────────────┤
│ フッター: 操作ログ・ステータス表示                    │
└────────────────────────────────────┘
```

### 2.2 コンポーネント詳細
- **ヘッダー**
  - タイトルは固定表示
  - `戻る` ボタン: `history.back()` 相当
  - `マップ表示` ボタン: `toggleMapView()` でキャンバス ↔ マップレイヤーを切替
  - `共有` ボタン: `navigator.share` / クリップボードコピーのフォールバック
- **キャンバス領域**
  - デフォルトはボード表示。描画領域は 600px 高さ、比率 16:9
  - マップ表示時は地図コンテナを表示し、`location` カテゴリのメモをピン描画
- **サイドパネル**
  - メモ一覧: タイトル、カテゴリ、タイムスタンプ
  - メモの CRUD 操作用ボタン（編集、削除、共有）
  - フィルタチップ: `all / food / photo / gift / location`
- **フッター**
  - 操作結果のトースト表示領域（成功/警告/エラー）
  - 同期状態のインジケータ（`同期中…` など）

## 3. 遷移・ナビゲーション
| 要素 | 遷移先/動作 | 備考 |
|------|-------------|------|
| 戻るボタン | `history.back()` | 直前画面に戻る |
| マップ表示ボタン | 同一画面内でレイヤー切替 | UC005-002 は未実装のため遷移無し |
| 共有ボタン | `navigator.share` / コピーメニュー | 成功時はトースト表示 |
| メモ編集 | モーダル `#memoModal` を開く | 編集完了後にトースト |
| メモ削除 | `confirm()` → 削除 → トースト | キャンセル時は変更なし |

## 4. ステート管理
| ステート名 | 型 | 説明 |
|-------------|----|------|
| `isMapView` | boolean | キャンバス/マップ表示のフラグ |
| `activeFilters` | object | `{'category': 'all', 'tags': []}` 初期化 |
| `memoList` | array | メモオブジェクト（id, title, description, time, category, tags, location） |
| `selectedMemo` | object/null | メモ詳細モーダルで参照する対象 |

## 5. データ構造
```json
{
  "id": "memo-001",
  "title": "夕日を見た",
  "description": "ベンチで撮った写真を共有",
  "category": "photo",
  "tags": ["思い出", "夕日"],
  "time": "2025-09-30T17:30:00+09:00",
  "location": {
    "lat": 35.6586,
    "lng": 139.7454,
    "label": "東京タワー"
  },
  "media": [
    { "type": "image", "url": "https://..." }
  ]
}
```

- `location` は任意。マップ表示時のみ利用
- `media` は拡張用。現時点のプロトタイプではダミーデータで表現

## 6. バリデーション
- タイトル/本文は 1〜200 文字
- タグは最大 6 個、1 タグ 20 文字以内
- `location` の `lat/lng` は `-90〜90` / `-180〜180`
- フィルタ変更時は `activeFilters` を更新し、描画処理を再実行

## 7. イベント設計
| イベント | トリガー | ハンドラ | 備考 |
|----------|----------|----------|------|
| `toggleMapView` | マップ表示ボタン | ビュー切替、アイコン/文言更新 | `isMapView` を反転 |
| `applyFilter` | フィルタチップ押下 | メモ一覧＋キャンバス再描画 | `active` クラス更新 |
| `openMemo` | メモカードクリック | `memoModal` 表示 | `selectedMemo` セット |
| `shareMemo` | 共有ボタン | Web Share API / clipboard | 成功・失敗でトースト制御 |
| `clearCanvas` | 「キャンバスをクリア」ボタン | `confirm` → `showSuccess` | 実際の削除はダミー |

## 8. API / データ永続化
- 現プロトタイプはローカル状態のみ。実装フェーズでは以下エンドポイントを想定
  - `GET /api/v1/date-canvas/{planId}`: メモ一覧取得
  - `POST /api/v1/date-canvas/{planId}/memos`: メモ追加
  - `PATCH /api/v1/date-canvas/{planId}/memos/{memoId}`: メモ更新
  - `DELETE /api/v1/date-canvas/{planId}/memos/{memoId}`: メモ削除
- WebSocket (または SSE) によるリアルタイム同期を検討。イベント名案: `canvas.updated`

## 9. 通知/トースト仕様
| 種類 | メッセージ例 | トリガー |
|------|--------------|----------|
| success | 「メモを保存しました」 | メモ保存成功時 |
| info | 「共有リンクをコピーしました」 | 共有完了 |
| warning | 「カテゴリを選択してください」 | バリデーション失敗 |
| error | 「保存に失敗しました。再度お試しください」 | API 失敗 |

## 10. エラーハンドリング
- クリップボード・WebShare が未対応の場合はコピー欄に URL を表示
- マップライブラリ読み込み失敗時は `isMapView` を `False` に戻し、アラートを表示
- 画像読み込み失敗時は `onerror` で代替テキスト化

## 11. 非機能要件メモ
- キャンバス描画は 60fps を維持（アニメーション最適化）
- 同時接続 2 名を前提に楽観ロックを採用
- オフライン時はローカルキャッシュ（IndexedDB）に保存し、再接続時に同期

## 12. 位置情報連携（バックログ）
- バックログ項目: 専用画面 (UC005-002) 実装時に切り出し予定
- ヘッダーの「マップ表示」トグルから同画面内でマップレイヤーを表示
- `location` カテゴリのメモはマップ上でピン描画。座標が無い場合は一覧のみ
- 専用画面追加時は API スキーマの `LocationPin` モデルを拡張予定（`Docs/画面-API-データマッピング.md` を参照）

## 13. テスト観点
- マップ表示トグルの表示文言・アイコン更新
- フィルタ適用時にキャンバス/サイド両方が同期されること
- 共有ボタンのフォールバック挙動
- 同期インジケータの切替タイミング
- オフラインモード時の操作制限（書き込み禁止、再接続で同期）

## 14. 実装メモ
- `Prototype/screens/uc005/UC005-001.html` に存在する `toggleMapView`, `navigateTo`, `showToast` をベースに SPA 化する
- CSS トークンは `css/components.css` の `.canvas-*` クラスを継承
- 位置情報ピン導線用のプレースホルダはコメントアウトで維持し、将来の実装で有効化する

# UC005-001: Date Canvas画面 実装指示書

## 1. 画面概要

### 1.1 画面名
Date Canvas画面

### 1.2 画面ID
UC005-001

### 1.3 目的とゴール
- デートの思い出をキャンバス上に自由に記録
- パートナーとリアルタイムで協働編集
- 位置情報ピンと連携した思い出の可視化
- カテゴリ別の整理された思い出管理

### 1.4 アクセス元
- ダッシュボード (COMMON-001)
- デートプラン詳細画面 (UC001-004)
- 位置情報ピン画面 (UC005-002)

## 2. UI設計

### 2.1 レイアウト構成

```
┌─────────────────────────────────────────────────────┐
│ ナビゲーションバー                                    │
├─────────────────────────────────────────────────────┤
│ ヘッダー                                             │
│ - タイトル: "Date Canvas"                            │
│ - ボタン: [戻る] [位置情報ピン]                      │
├──────────────────────────┬─────────────────────────┤
│                          │                         │
│  キャンバスエリア          │   サイドパネル          │
│                          │                         │
│  - メモマーカー表示       │   - メモ一覧           │
│  - プレースホルダー       │   - メモ追加           │
│  - コントロールパネル     │   - フィルター         │
│                          │                         │
└──────────────────────────┴─────────────────────────┘
```

### 2.2 主要コンポーネント

#### 2.2.1 ヘッダー
- **タイトル**: "Date Canvas"
- **サブタイトル**: "デートの思い出をキャンバスに記録しましょう"
- **戻るボタン**: 前の画面に戻る
- **位置情報ピンボタン**: UC005-002に遷移

#### 2.2.2 キャンバスエリア (左側・メイン)
- **サイズ**: 幅60%、高さ600px
- **背景**: 淡いグラデーション (#f8f9fa)
- **プレースホルダー**: 初期表示時のガイド
- **メモマーカー**: カテゴリ別に色分けされた円形マーカー
- **メモラベル**: マーカー下部の簡潔なテキスト

#### 2.2.3 コントロールパネル (キャンバス右上)
- **配置**: キャンバス右上に固定
- **ツールボタン**:
  - メモ追加 (付箋アイコン)
  - 写真追加 (カメラアイコン)
  - 位置情報 (マップピンアイコン)
  - 描画 (ペンアイコン)
- **操作ボタン**:
  - 元に戻す (アンドゥアイコン)
  - クリア (ゴミ箱アイコン)

#### 2.2.4 サイドパネル (右側)
**メモ一覧パネル**:
- メモカードのリスト表示
- カード構成: アイコン + タイトル + 時間 + タグ
- アクティブ状態の視覚的フィードバック

**メモ追加パネル**:
- クイックメモボタン (2x2グリッド)
  - グルメ (食器アイコン、#FF6B6B)
  - 写真 (カメラアイコン、#4ECDC4)
  - プレゼント (ギフトアイコン、#FFE66D)
  - お気に入り (ハートアイコン、#F8B195)

**フィルターパネル**:
- カテゴリフィルター (チップ形式)
  - すべて / グルメ / 写真 / プレゼント

### 2.3 メモマーカー仕様

#### カテゴリ別カラー
- **グルメ**: #FF6B6B (赤系)
- **写真**: #4ECDC4 (青緑系)
- **プレゼント**: #FFE66D (黄色系)
- **お気に入り**: #F8B195 (オレンジ系)

#### サイズとスタイル
- **マーカーサイズ**: 48x48px (円形)
- **ラベル**: 12pxフォント、白背景、影付き
- **ホバー効果**: 1.1倍に拡大
- **アクティブ状態**: 影を強調

## 3. インタラクション設計

### 3.1 メモ操作

#### メモ追加
1. クイックメモボタンをクリック
2. カテゴリに応じたメモがキャンバス中央に追加
3. メモカードがサイドパネルに追加される
4. 成功メッセージを表示

#### メモ選択
1. キャンバス上のマーカーをクリック
2. メモ詳細モーダルを表示
3. サイドパネルの対応カードをハイライト

#### メモ編集
1. メモ詳細モーダルで「編集」ボタンをクリック
2. 編集フォームを表示
3. 変更を保存
4. リアルタイムで反映

#### メモ削除
1. メモ詳細モーダルで「削除」ボタンをクリック
2. 確認ダイアログを表示
3. 削除実行
4. キャンバスとリストから削除

### 3.2 ツール操作

#### ツール選択
1. コントロールパネルでツールボタンをクリック
2. ボタンがアクティブ状態になる
3. キャンバス上でツールが有効化
4. ステータスメッセージを表示

#### 元に戻す
1. アンドゥボタンをクリック
2. 最後の操作を取り消し
3. キャンバスを更新
4. 通知メッセージを表示

#### クリア
1. クリアボタンをクリック
2. 確認ダイアログを表示
3. 確定後、すべてのメモを削除
4. 成功メッセージを表示

### 3.3 フィルター操作

1. フィルターチップをクリック
2. チップがアクティブ状態になる
3. 該当カテゴリのメモのみ表示
4. キャンバスとリストが更新

## 4. データフロー

### 4.1 初期ロード
```
1. ページ読み込み
2. GET /api/v1/canvas/{canvasId}
3. キャンバス情報とメモ一覧を取得
4. キャンバスに描画
5. サイドパネルに表示
```

### 4.2 メモ追加
```
1. クイックメモボタンをクリック
2. POST /api/v1/canvas/{canvasId}/memos
3. サーバーで保存
4. WebSocketで他ユーザーに通知
5. キャンバスとリストを更新
```

### 4.3 リアルタイム同期
```
1. WebSocket接続確立
2. memo_added/updated/deletedイベントを受信
3. ローカル状態を更新
4. UIを再描画
5. 通知メッセージを表示（オプション）
```

## 5. API仕様

### 5.1 キャンバス取得
```typescript
GET /api/v1/canvas/{canvasId}

Response:
{
  canvasId: string;
  dateId: string;
  coupleId: string;
  status: 'active' | 'completed';
  memos: CanvasMemo[];
  createdAt: string;
  updatedAt: string;
}

interface CanvasMemo {
  memoId: string;
  category: 'food' | 'photo' | 'gift' | 'heart';
  title: string;
  description: string;
  positionX: number;
  positionY: number;
  color: string;
  iconType: string;
  photos: CanvasPhoto[];
  createdBy: string;
  createdAt: string;
  updatedAt: string;
}
```

### 5.2 メモ追加
```typescript
POST /api/v1/canvas/{canvasId}/memos

Request:
{
  category: 'food' | 'photo' | 'gift' | 'heart';
  title: string;
  description?: string;
  positionX: number;
  positionY: number;
  color: string;
  iconType: string;
}

Response:
{
  memoId: string;
  // ... メモ情報
}
```

### 5.3 メモ更新
```typescript
PUT /api/v1/canvas/{canvasId}/memos/{memoId}

Request:
{
  title?: string;
  description?: string;
  positionX?: number;
  positionY?: number;
}

Response:
{
  // 更新されたメモ情報
}
```

### 5.4 メモ削除
```typescript
DELETE /api/v1/canvas/{canvasId}/memos/{memoId}

Response: 204 No Content
```

### 5.5 WebSocket同期
```typescript
WebSocket /api/v1/canvas/{canvasId}/sync

Events:
- memo_added: { memo: CanvasMemo }
- memo_updated: { memoId: string, changes: Partial<CanvasMemo> }
- memo_deleted: { memoId: string }
- presence_update: { userId: string, status: 'online' | 'offline' }
```

## 6. 状態管理

### 6.1 ローカル状態
```typescript
interface CanvasState {
  canvasId: string;
  dateId: string;
  memos: CanvasMemo[];
  selectedMemo: string | null;
  currentTool: 'memo' | 'photo' | 'location' | 'draw';
  activeFilters: string[];
  isLoading: boolean;
  error: string | null;
}
```

### 6.2 状態遷移
```
初期状態 → ローディング → データ取得完了
         ↓
      エラー発生
         ↓
      エラー状態

メモ選択 → メモ詳細表示 → メモ編集 → 保存完了
                      ↓
                    削除確認 → 削除完了
```

## 7. エラーハンドリング

### 7.1 ネットワークエラー
- **エラーメッセージ**: "ネットワークエラーが発生しました"
- **リトライボタン**: 再読み込み可能
- **ローカル保存**: オフライン時もローカルに保存

### 7.2 認証エラー
- **エラーメッセージ**: "認証が必要です"
- **リダイレクト**: ログイン画面に遷移

### 7.3 バリデーションエラー
- **エラーメッセージ**: "入力内容を確認してください"
- **フィールド強調**: エラー箇所を赤色で強調

## 8. パフォーマンス最適化

### 8.1 初期ロード
- **遅延ロード**: 画像は遅延ロード
- **キャッシュ**: APIレスポンスをキャッシュ
- **プレースホルダー**: ローディング中は骨組みを表示

### 8.2 リアルタイム同期
- **デバウンス**: 頻繁な更新を制限
- **バッチ処理**: 複数の変更をまとめて処理
- **楽観的更新**: UI更新を先に実行

### 8.3 レンダリング
- **仮想化**: メモ一覧の仮想化
- **メモ化**: コンポーネントのメモ化
- **最適化**: 不要な再レンダリングを防止

## 9. アクセシビリティ

### 9.1 キーボード操作
- **Tab**: フォーカス移動
- **Enter**: メモ選択・実行
- **Escape**: モーダル閉じる
- **Delete**: メモ削除

### 9.2 スクリーンリーダー
- **ARIA属性**: 適切なARIA属性を設定
- **代替テキスト**: 画像に適切なalt属性
- **ラベル**: フォーム要素にラベルを関連付け

## 10. レスポンシブ対応

### 10.1 モバイル (< 768px)
- **レイアウト**: 1カラムに変更
- **キャンバス高さ**: 400pxに縮小
- **サイドパネル**: キャンバス下部に配置
- **コントロール**: 下部に固定

### 10.2 タブレット (768px - 1024px)
- **レイアウト**: 2カラム維持
- **キャンバス幅**: 55%に調整
- **サイドパネル**: 45%に調整

## 11. テスト要件

### 11.1 単体テスト
- メモ追加/更新/削除機能
- フィルター機能
- ツール選択機能

### 11.2 統合テスト
- API通信
- WebSocket同期
- 位置情報ピン連携

### 11.3 E2Eテスト
- ユーザーフロー全体
- リアルタイム協働編集
- エラーハンドリング

## 12. 位置情報ピンとの連携

### 12.1 遷移
- ヘッダーの「位置情報ピン」ボタンから遷移
- Date CanvasとLocationPinは同じDateIdを共有

### 12.2 データ連携
- LocationPinで追加した位置情報をCanvasMemoとして表示
- category='location'のメモは位置情報ピンとして扱う

### 12.3 シームレスな体験
- 両画面間の遷移は即座に完了
- データは常に同期されている
- ユーザーは違和感なく切り替え可能


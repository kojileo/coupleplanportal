# UC002-002: 編集競合解決画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: 共同編集で発生した競合の解決と編集継続を提供
- **ビジネスゴール**: ユーザー体験の向上と協働編集の信頼性確保
- **技術ゴール**: 直感的な競合解決と編集データ整合性の実現

### 受け入れ基準
- 競合情報取得が2秒以内に完了する
- 競合解決が3秒以内に完了する
- 解決選択UIが1秒以内に表示される
- モバイル・デスクトップ両対応のレスポンシブデザイン
- WCAG 2.1 AA準拠のアクセシビリティ

### 機能段階性
1. **基礎**: 競合情報表示、解決選択、解決実行
2. **拡張**: 解決履歴、解決テンプレート、自動解決
3. **制約**: 解決制限、履歴制限、テンプレート制限

## 2. 仕様の厳密化

### コア機能

#### 競合情報取得
- **取得**: 競合の詳細情報取得
- **表示**: 競合情報の表示
- **更新**: 競合情報の更新
- **完了**: 取得完了の通知

#### 競合解決
- **選択**: 解決方法の選択
- **実行**: 解決の実行
- **確認**: 解決結果の確認
- **完了**: 解決完了の通知

#### 解決選択UI
- **表示**: 解決選択肢の表示
- **選択**: 解決方法の選択
- **確認**: 選択内容の確認
- **実行**: 選択に基づく解決実行

### 入力制約 & バリデーション

#### 競合ID
- **形式**: UUID形式
- **必須**: 必須項目
- **エラーメッセージ**: "有効な競合IDを入力してください"

#### 解決方法
- **選択肢**: 事前定義された解決方法
- **必須**: 必須項目
- **エラーメッセージ**: "解決方法を選択してください"

#### 解決理由
- **長さ**: 最大500文字
- **必須**: 任意項目
- **エラーメッセージ**: "500文字以内で入力してください"

### データモデル & API

#### リクエストモデル
```typescript
interface ConflictInfoRequest {
  sessionId: string;
  conflictId: string;
}

interface ConflictResolutionRequest {
  sessionId: string;
  conflictId: string;
  resolution: ConflictResolution;
  userId: string;
  reason?: string;
}

interface ConflictResolution {
  type: 'accept_first' | 'accept_second' | 'merge' | 'custom';
  selectedOperation?: EditOperation;
  customContent?: string;
  mergeStrategy?: 'first_wins' | 'second_wins' | 'both' | 'neither';
}
```

#### レスポンスモデル
```typescript
interface ConflictInfoResponse {
  conflictId: string;
  sessionId: string;
  conflictType: 'content' | 'position' | 'format';
  severity: 'low' | 'medium' | 'high';
  conflictingOperations: ConflictingOperation[];
  context: ConflictContext;
  detectedAt: string;
  status: 'pending' | 'resolved' | 'dismissed';
}

interface ConflictingOperation {
  operationId: string;
  operation: EditOperation;
  userId: string;
  userName: string;
  timestamp: string;
  description: string;
}

interface ConflictContext {
  beforeContent: string;
  afterContent: string;
  affectedRange: {
    start: number;
    end: number;
  };
  lineNumber?: number;
}

interface ConflictResolutionResponse {
  resolutionId: string;
  conflictId: string;
  sessionId: string;
  resolution: ConflictResolution;
  resolvedBy: string;
  resolvedAt: string;
  status: 'applied' | 'failed' | 'pending';
  result?: string;
}
```

#### API エンドポイント
- **競合情報取得**: `GET /api/v1/sessions/{sessionId}/conflicts`
- **競合解決**: `POST /api/v1/sessions/{sessionId}/conflicts/{conflictId}/resolve`

### UX / A11y

#### キーボード操作
- **Tab順序**: 競合情報 → 解決選択肢 → 解決理由 → 解決ボタン
- **Enter**: 解決実行
- **Escape**: 解決キャンセル
- **矢印キー**: 解決選択肢の切り替え

#### スクリーンリーダー対応
- **aria-label**: 各解決選択肢の説明
- **aria-live**: 解決状態の読み上げ
- **aria-describedby**: 解決説明の関連付け
- **role**: 解決要素の役割定義

#### 色覚対応
- **競合表示**: 色 + アイコン + テキスト
- **解決選択**: 色 + 選択アイコン + テキスト
- **フォーカス**: 色 + アウトライン + 影

### セキュリティ & プライバシー

#### データ保護
- **競合データ**: 暗号化された保存
- **通信**: HTTPS強制、TLS 1.3以上
- **アクセス**: 認証済みユーザーのみ
- **解決履歴**: 適切なデータ保持期間

#### セキュリティ検証
- **ユーザー認証**: 競合解決者との一致確認
- **権限確認**: 解決権限の確認
- **データ整合性**: 解決結果の整合性確認

### 非機能要件

#### パフォーマンス
- **競合情報取得**: 2秒以内
- **競合解決**: 3秒以内
- **解決選択UI**: 1秒以内
- **解決履歴**: 5秒以内

#### 可用性
- **稼働率**: 99.9%以上
- **エラー率**: 1%以下
- **復旧時間**: 5分以内

#### スケーラビリティ
- **同時接続**: 10,000ユーザー
- **スループット**: 1,000リクエスト/秒
- **競合解決**: 100件/秒

## 3. 曖昧さと解決

### 競合解決方法
- **最初の操作を採用**: 最初の操作を優先
- **2番目の操作を採用**: 2番目の操作を優先
- **マージ**: 両方の操作を統合
- **カスタム**: ユーザー定義の解決

### 解決結果
- **適用**: 解決結果の適用
- **確認**: 解決結果の確認
- **通知**: 解決完了の通知
- **履歴**: 解決履歴の記録

### 解決テンプレート
- **事前定義**: 事前定義された解決テンプレート
- **カスタム**: ユーザー定義の解決テンプレート
- **学習**: 解決パターンの学習
- **推奨**: 解決方法の推奨

## 4. 受け入れ基準例（Gherkin風）

### 競合情報取得
```gherkin
Given ユーザーが編集競合解決画面にアクセス
When 競合情報が取得される
Then 競合情報が表示される
And 2秒以内に表示される

Given ユーザーが編集競合解決画面にアクセス
When 競合情報の取得に失敗
Then エラーメッセージが表示される
And 再試行ボタンが表示される
```

### 競合解決
```gherkin
Given ユーザーが編集競合解決画面にアクセス
When 解決方法を選択
And 解決ボタンをクリック
Then 競合が解決される
And 3秒以内に完了する

Given ユーザーが編集競合解決画面にアクセス
When 解決方法を選択せずに解決ボタンをクリック
Then エラーメッセージが表示される
And 解決が阻止される
```

## 5. リスクとトレードオフ

### 技術リスク
- **競合解決失敗**: 適切なエラーハンドリング
- **データ整合性**: 適切な整合性チェック
- **解決履歴**: 適切な履歴管理

### UXリスク
- **複雑な解決**: 分かりやすい解決インターフェース
- **解決選択**: 直感的な解決選択
- **解決結果**: 分かりやすい解決結果表示

### パフォーマンスリスク
- **大量競合**: 適切な競合管理
- **解決処理**: 適切な解決処理
- **履歴表示**: 適切な履歴表示

## 6. 拡張余地

### 短期拡張
- **解決履歴**: 解決履歴の表示
- **解決テンプレート**: 解決テンプレート機能
- **自動解決**: 自動解決機能

### 中期拡張
- **AI支援**: AIによる解決支援
- **解決分析**: 解決パターンの分析
- **予測**: 競合の予測

### 長期拡張
- **VR対応**: VR環境での競合解決
- **音声解決**: 音声による解決
- **予測**: 未来の競合予測

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **HTTP クライアント**: Axios
- **UI コンポーネント**: Headless UI
- **アニメーション**: Framer Motion

### コンポーネント設計
```typescript
// メインコンポーネント
interface ConflictResolverProps {
  sessionId: string;
  conflictId: string;
  userId: string;
  onResolve: (resolution: ConflictResolution) => void;
  onDismiss: () => void;
  onError: (error: string) => void;
}

// 競合情報表示
interface ConflictInfoProps {
  conflict: ConflictInfo;
  onResolutionSelect: (resolution: ConflictResolution) => void;
}

// 解決選択肢
interface ResolutionOptionsProps {
  conflict: ConflictInfo;
  onSelect: (resolution: ConflictResolution) => void;
  selectedResolution?: ConflictResolution;
}
```

### スタイリング
```css
/* レスポンシブデザイン */
.conflict-resolver {
  @apply max-w-4xl mx-auto p-6 bg-white rounded-lg shadow-md;
}

.conflict-header {
  @apply mb-6;
}

.conflict-title {
  @apply text-2xl font-bold text-gray-800 mb-2;
}

.conflict-description {
  @apply text-gray-600 mb-4;
}

.conflict-meta {
  @apply flex items-center space-x-4 text-sm text-gray-500 mb-6;
}

.conflict-content {
  @apply mb-8;
}

.conflict-operations {
  @apply space-y-4 mb-6;
}

.operation-card {
  @apply border border-gray-200 rounded-lg p-4;
}

.operation-header {
  @apply flex items-center justify-between mb-2;
}

.operation-user {
  @apply flex items-center space-x-2;
}

.operation-avatar {
  @apply w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-semibold;
}

.operation-name {
  @apply text-sm font-medium text-gray-800;
}

.operation-timestamp {
  @apply text-xs text-gray-500;
}

.operation-content {
  @apply text-sm text-gray-700 mb-2;
}

.operation-description {
  @apply text-xs text-gray-500;
}

.resolution-options {
  @apply space-y-3 mb-6;
}

.resolution-option {
  @apply border border-gray-200 rounded-lg p-4 cursor-pointer hover:border-blue-300 transition-colors;
}

.resolution-option.selected {
  @apply border-blue-500 bg-blue-50;
}

.resolution-option-header {
  @apply flex items-center space-x-3 mb-2;
}

.resolution-option-radio {
  @apply w-4 h-4 text-blue-600;
}

.resolution-option-title {
  @apply text-sm font-medium text-gray-800;
}

.resolution-option-description {
  @apply text-xs text-gray-600;
}

.resolution-reason {
  @apply mb-6;
}

.resolution-reason-label {
  @apply block text-sm font-medium text-gray-700 mb-2;
}

.resolution-reason-input {
  @apply w-full p-3 border border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none;
}

.resolution-actions {
  @apply flex items-center justify-end space-x-3;
}

.resolution-button {
  @apply px-4 py-2 text-sm font-medium rounded-lg;
}

.resolution-button.resolve {
  @apply bg-blue-600 text-white hover:bg-blue-700;
}

.resolution-button.cancel {
  @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  .conflict-resolver {
    @apply bg-gray-800;
  }
  .conflict-title {
    @apply text-gray-200;
  }
  .conflict-description {
    @apply text-gray-400;
  }
  .conflict-meta {
    @apply text-gray-500;
  }
  .operation-card {
    @apply border-gray-600;
  }
  .operation-name {
    @apply text-gray-200;
  }
  .operation-timestamp {
    @apply text-gray-500;
  }
  .operation-content {
    @apply text-gray-300;
  }
  .operation-description {
    @apply text-gray-500;
  }
  .resolution-option {
    @apply border-gray-600 hover:border-blue-400;
  }
  .resolution-option.selected {
    @apply border-blue-400 bg-blue-900;
  }
  .resolution-option-title {
    @apply text-gray-200;
  }
  .resolution-option-description {
    @apply text-gray-400;
  }
  .resolution-reason-label {
    @apply text-gray-300;
  }
  .resolution-reason-input {
    @apply border-gray-600 bg-gray-700 text-white;
  }
  .resolution-button.cancel {
    @apply bg-gray-700 text-gray-200 hover:bg-gray-600;
  }
}
```

## 8. 日本語サンプルデータ

### 競合情報データ
```json
{
  "conflictInfos": [
    {
      "conflictId": "conflict_001",
      "sessionId": "session_001",
      "conflictType": "content",
      "severity": "medium",
      "conflictingOperations": [
        {
          "operationId": "op_001",
          "operation": {
            "type": "replace",
            "position": 150,
            "content": "新しいテキスト",
            "length": 10
          },
          "userId": "usr_001",
          "userName": "山田太郎",
          "timestamp": "2025-01-27T10:00:00Z",
          "description": "テキストを「新しいテキスト」に置換"
        },
        {
          "operationId": "op_002",
          "operation": {
            "type": "insert",
            "position": 150,
            "content": "挿入テキスト"
          },
          "userId": "usr_002",
          "userName": "佐藤花子",
          "timestamp": "2025-01-27T10:00:30Z",
          "description": "位置150に「挿入テキスト」を挿入"
        }
      ],
      "context": {
        "beforeContent": "元のテキスト内容",
        "afterContent": "新しいテキスト内容",
        "affectedRange": {
          "start": 150,
          "end": 160
        },
        "lineNumber": 5
      },
      "detectedAt": "2025-01-27T10:00:30Z",
      "status": "pending"
    },
    {
      "conflictId": "conflict_002",
      "sessionId": "session_002",
      "conflictType": "position",
      "severity": "high",
      "conflictingOperations": [
        {
          "operationId": "op_003",
          "operation": {
            "type": "delete",
            "position": 100,
            "length": 20
          },
          "userId": "usr_003",
          "userName": "田中次郎",
          "timestamp": "2025-01-27T10:01:00Z",
          "description": "位置100から20文字を削除"
        },
        {
          "operationId": "op_004",
          "operation": {
            "type": "replace",
            "position": 100,
            "content": "置換内容",
            "length": 20
          },
          "userId": "usr_004",
          "userName": "渡辺雪",
          "timestamp": "2025-01-27T10:01:15Z",
          "description": "位置100から20文字を「置換内容」に置換"
        }
      ],
      "context": {
        "beforeContent": "削除対象のテキスト",
        "afterContent": "置換後のテキスト",
        "affectedRange": {
          "start": 100,
          "end": 120
        },
        "lineNumber": 3
      },
      "detectedAt": "2025-01-27T10:01:15Z",
      "status": "pending"
    }
  ]
}
```

### 解決方法データ
```json
{
  "resolutionOptions": [
    {
      "type": "accept_first",
      "title": "最初の操作を採用",
      "description": "山田太郎の操作を採用します",
      "icon": "user",
      "color": "blue"
    },
    {
      "type": "accept_second",
      "title": "2番目の操作を採用",
      "description": "佐藤花子の操作を採用します",
      "icon": "user",
      "color": "green"
    },
    {
      "type": "merge",
      "title": "両方の操作をマージ",
      "description": "両方の操作を統合します",
      "icon": "merge",
      "color": "purple"
    },
    {
      "type": "custom",
      "title": "カスタム解決",
      "description": "独自の解決方法を指定します",
      "icon": "edit",
      "color": "orange"
    }
  ]
}
```

### 解決履歴データ
```json
{
  "resolutionHistory": [
    {
      "resolutionId": "res_001",
      "conflictId": "conflict_001",
      "sessionId": "session_001",
      "resolution": {
        "type": "accept_first",
        "selectedOperation": {
          "operationId": "op_001",
          "operation": {
            "type": "replace",
            "position": 150,
            "content": "新しいテキスト",
            "length": 10
          }
        }
      },
      "resolvedBy": "usr_001",
      "resolvedAt": "2025-01-27T10:02:00Z",
      "status": "applied",
      "result": "競合が解決されました"
    },
    {
      "resolutionId": "res_002",
      "conflictId": "conflict_002",
      "sessionId": "session_002",
      "resolution": {
        "type": "merge",
        "mergeStrategy": "both"
      },
      "resolvedBy": "usr_003",
      "resolvedAt": "2025-01-27T10:03:00Z",
      "status": "applied",
      "result": "競合がマージされました"
    }
  ]
}
```

### エラーメッセージ
```json
{
  "errorMessages": {
    "conflictInfo": {
      "networkError": "競合情報の取得に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "競合情報の取得がタイムアウトしました",
      "notFound": "競合情報が見つかりません"
    },
    "resolution": {
      "required": "解決方法を選択してください",
      "networkError": "競合解決に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "競合解決がタイムアウトしました",
      "invalidResolution": "無効な解決方法です"
    },
    "reason": {
      "tooLong": "500文字以内で入力してください",
      "invalid": "使用できない文字が含まれています"
    },
    "general": {
      "networkError": "ネットワークエラーが発生しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "タイムアウトが発生しました",
      "unknown": "不明なエラーが発生しました"
    }
  }
}
```

### 成功メッセージ
```json
{
  "successMessages": {
    "conflictInfoLoaded": "競合情報が読み込まれました",
    "resolutionApplied": "競合が解決されました",
    "resolutionSaved": "解決方法が保存されました",
    "resolutionHistoryLoaded": "解決履歴が読み込まれました"
  }
}
```

## 9. 最終チェックリスト

### 機能要件
- [ ] 競合情報取得機能が正常に動作する
- [ ] 競合解決機能が正常に動作する
- [ ] 解決選択UI機能が正常に動作する
- [ ] 解決履歴機能が正常に動作する
- [ ] 競合表示機能が正常に動作する

### 非機能要件
- [ ] レスポンシブデザインが実装されている
- [ ] アクセシビリティ（WCAG 2.1 AA）に準拠している
- [ ] パフォーマンス要件を満たしている
- [ ] セキュリティ要件が実装されている
- [ ] エラー率が許容範囲内である

### ユーザビリティ
- [ ] 直感的なUI/UXが実装されている
- [ ] 適切なフィードバックが提供されている
- [ ] 競合表示が分かりやすい
- [ ] エラーメッセージが分かりやすい
- [ ] キーボード操作が可能である

### セキュリティ
- [ ] 競合データが適切に保護されている
- [ ] HTTPS通信が強制されている
- [ ] 認証・認可が適切に実装されている
- [ ] 解決履歴が適切に管理されている
- [ ] データ整合性が確保されている

### 技術要件
- [ ] 競合情報取得が適切に実装されている
- [ ] 競合解決が適切に実装されている
- [ ] 解決選択UIが適切に実装されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] 状態管理が適切に実装されている

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: ソフトウェアエンジニア・UX/UIデザイナー  
**承認者**: [承認者名]  
**レビュー者**: [レビュー者名]

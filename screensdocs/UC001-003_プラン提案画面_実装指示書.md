# UC001-003: プラン提案画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: AI生成されたデートプランの提案と選択機能を提供
- **ビジネスゴール**: ユーザー満足度向上とAI機能の価値実証
- **技術ゴール**: 直感的なプラン選択とフィードバック収集の実現

### 受け入れ基準
- 提案プランが3秒以内に表示される
- プラン選択が1秒以内に完了する
- フィードバック送信が2秒以内に完了する
- モバイル・デスクトップ両対応のレスポンシブデザイン
- WCAG 2.1 AA準拠のアクセシビリティ

### 機能段階性
1. **基礎**: プラン表示、選択機能、フィードバック送信
2. **拡張**: 詳細表示、比較機能、お気に入り機能
3. **制約**: 表示制限、選択制限、フィードバック制限

## 2. 仕様の厳密化

### コア機能

#### 提案プラン取得
- **取得**: AI生成されたプラン提案の取得
- **表示**: プラン一覧の表示
- **更新**: プラン情報の更新
- **完了**: プラン取得完了の通知

#### プラン選択
- **選択**: ユーザーによるプラン選択
- **確認**: 選択プランの確認
- **保存**: 選択プランの保存
- **完了**: 選択完了の通知

#### フィードバック送信
- **入力**: フィードバックの入力
- **送信**: フィードバックの送信
- **保存**: フィードバックの保存
- **完了**: 送信完了の通知

#### 詳細表示切り替え
- **表示**: プラン詳細の表示
- **非表示**: プラン詳細の非表示
- **切り替え**: 表示/非表示の切り替え
- **アニメーション**: スムーズな切り替え

### 入力制約 & バリデーション

#### プラン選択
- **選択数**: 1つのみ
- **必須**: 必須項目
- **エラーメッセージ**: "プランを選択してください"

#### フィードバック
- **長さ**: 最大1,000文字
- **必須**: 任意項目
- **エラーメッセージ**: "1,000文字以内で入力してください"

#### 評価
- **範囲**: 1-5星
- **必須**: 任意項目
- **エラーメッセージ**: "1-5星で評価してください"

### データモデル & API

#### リクエストモデル
```typescript
interface PlanProposalRequest {
  planId: string;
  userId: string;
}

interface PlanSelectionRequest {
  planId: string;
  selectedProposalId: string;
  userId: string;
}

interface FeedbackRequest {
  planId: string;
  proposalId: string;
  rating: number; // 1-5
  comment?: string;
  userId: string;
}
```

#### レスポンスモデル
```typescript
interface PlanProposalResponse {
  planId: string;
  proposals: PlanProposal[];
  totalCount: number;
  generatedAt: string;
}

interface PlanProposal {
  proposalId: string;
  title: string;
  description: string;
  activities: Activity[];
  estimatedCost: number;
  estimatedDuration: number;
  difficulty: 'easy' | 'medium' | 'hard';
  rating: number;
  tags: string[];
  imageUrl?: string;
}

interface Activity {
  activityId: string;
  name: string;
  description: string;
  location: string;
  duration: number; // minutes
  cost: number;
  category: string;
  imageUrl?: string;
}

interface SelectionResponse {
  planId: string;
  selectedProposalId: string;
  status: 'selected';
  selectedAt: string;
}

interface FeedbackResponse {
  feedbackId: string;
  planId: string;
  proposalId: string;
  rating: number;
  comment?: string;
  submittedAt: string;
}
```

#### API エンドポイント
- **提案プラン取得**: `GET /api/v1/plans/{planId}/proposals`
- **プラン選択**: `POST /api/v1/plans/{planId}/select`
- **フィードバック登録**: `POST /api/v1/plans/{planId}/feedback`

### UX / A11y

#### キーボード操作
- **Tab順序**: プラン一覧 → 選択ボタン → フィードバック → 送信ボタン
- **Enter**: プラン選択
- **Escape**: 詳細表示の閉じる
- **矢印キー**: プラン間の移動

#### スクリーンリーダー対応
- **aria-label**: 各プランの説明
- **aria-live**: 選択状態の読み上げ
- **aria-describedby**: プラン詳細の関連付け
- **role**: プラン要素の役割定義

#### 色覚対応
- **選択状態**: 色 + アイコン + テキスト
- **評価表示**: 色 + 星アイコン + テキスト
- **フォーカス**: 色 + アウトライン + 影

### セキュリティ & プライバシー

#### データ保護
- **プランデータ**: 暗号化された保存
- **通信**: HTTPS強制、TLS 1.3以上
- **アクセス**: 認証済みユーザーのみ
- **履歴**: 適切なデータ保持期間

#### プライバシー保護
- **個人情報**: 最小限の情報収集
- **フィードバック**: 匿名化された分析
- **AI学習**: 個人を特定できない形での学習
- **データ削除**: ユーザー要求による削除

### 非機能要件

#### パフォーマンス
- **プラン取得**: 3秒以内
- **プラン選択**: 1秒以内
- **フィードバック送信**: 2秒以内
- **詳細表示**: 500ms以内

#### 可用性
- **稼働率**: 99.9%以上
- **エラー率**: 1%以下
- **復旧時間**: 5分以内

#### スケーラビリティ
- **同時接続**: 10,000ユーザー
- **スループット**: 1,000リクエスト/秒
- **プラン表示**: 100件/秒

## 3. 曖昧さと解決

### プラン表示
- **一覧表示**: 3-5個のプランを一覧表示
- **詳細表示**: クリックで詳細表示
- **比較表示**: 複数プランの比較表示

### 選択処理
- **選択確認**: 選択前の確認ダイアログ
- **選択保存**: 選択プランの保存
- **選択完了**: 選択完了の通知

### フィードバック
- **評価**: 1-5星の評価
- **コメント**: 自由記述のコメント
- **送信**: フィードバックの送信

## 4. 受け入れ基準例（Gherkin風）

### プラン提案表示
```gherkin
Given ユーザーがプラン提案画面にアクセス
When プラン提案が取得される
Then 3-5個のプランが表示される
And 3秒以内に表示される

Given ユーザーがプラン提案画面にアクセス
When プラン提案の取得に失敗
Then エラーメッセージが表示される
And 再試行ボタンが表示される
```

### プラン選択
```gherkin
Given ユーザーがプラン提案画面にアクセス
When プランを選択
And 選択ボタンをクリック
Then プランが選択される
And 1秒以内に完了する

Given ユーザーがプラン提案画面にアクセス
When プランを選択せずに選択ボタンをクリック
Then エラーメッセージが表示される
And 選択が阻止される
```

## 5. リスクとトレードオフ

### 技術リスク
- **プラン取得失敗**: 適切なエラーハンドリング
- **選択処理失敗**: 適切なエラーハンドリング
- **フィードバック送信失敗**: 適切なエラーハンドリング

### UXリスク
- **プラン表示**: 分かりやすいプラン表示
- **選択処理**: 直感的な選択処理
- **フィードバック**: 簡単なフィードバック入力

### パフォーマンスリスク
- **大量データ**: 適切なページネーション
- **画像表示**: 適切な画像最適化
- **ネットワーク**: 適切なキャッシュ戦略

## 6. 拡張余地

### 短期拡張
- **プラン比較**: 複数プランの比較機能
- **お気に入り**: プランのお気に入り機能
- **共有**: プランの共有機能

### 中期拡張
- **カスタマイズ**: プランのカスタマイズ機能
- **予約**: プランに基づく予約機能
- **ナビゲーション**: プランに基づくナビゲーション

### 長期拡張
- **VR対応**: VR環境でのプラン表示
- **AI学習**: ユーザー好みの学習
- **予測**: 未来のプラン予測

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **フォーム管理**: React Hook Form + Zod
- **HTTP クライアント**: Axios
- **アニメーション**: Framer Motion

### コンポーネント設計
```typescript
// メインコンポーネント
interface PlanProposalProps {
  planId: string;
  userId: string;
  onSelect: (proposalId: string) => void;
  onFeedback: (feedback: Feedback) => void;
  onError: (error: string) => void;
}

// プラン提案カード
interface PlanProposalCardProps {
  proposal: PlanProposal;
  isSelected: boolean;
  onSelect: (proposalId: string) => void;
  onToggleDetail: (proposalId: string) => void;
}

// フォームバリデーション
const feedbackSchema = z.object({
  rating: z.number().min(1, '1星以上で評価してください').max(5, '5星以下で評価してください'),
  comment: z.string().max(1000, '1,000文字以内で入力してください').optional()
});
```

### スタイリング
```css
/* レスポンシブデザイン */
.proposal-container {
  @apply max-w-6xl mx-auto p-6 bg-white rounded-lg shadow-md;
}

.proposal-grid {
  @apply grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6;
}

.proposal-card {
  @apply bg-white border-2 border-gray-200 rounded-lg p-6 hover:border-blue-300 transition-colors cursor-pointer;
}

.proposal-card.selected {
  @apply border-blue-500 bg-blue-50;
}

.proposal-title {
  @apply text-xl font-bold text-gray-800 mb-2;
}

.proposal-description {
  @apply text-gray-600 mb-4;
}

.proposal-meta {
  @apply flex items-center justify-between text-sm text-gray-500 mb-4;
}

.proposal-actions {
  @apply flex items-center justify-between;
}

.rating-stars {
  @apply flex items-center space-x-1;
}

.star {
  @apply w-5 h-5 text-yellow-400;
}

.star.empty {
  @apply text-gray-300;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  .proposal-container {
    @apply bg-gray-800;
  }
  .proposal-card {
    @apply bg-gray-700 border-gray-600 hover:border-blue-400;
  }
  .proposal-card.selected {
    @apply border-blue-400 bg-blue-900;
  }
  .proposal-title {
    @apply text-gray-200;
  }
  .proposal-description {
    @apply text-gray-400;
  }
  .proposal-meta {
    @apply text-gray-500;
  }
}
```

## 8. 日本語サンプルデータ

### プラン提案データ
```json
{
  "planProposals": [
    {
      "proposalId": "prop_001",
      "title": "渋谷で過ごすロマンチックなデート",
      "description": "渋谷の街を散策しながら、おしゃれなカフェとレストランで過ごすロマンチックなデートプランです。",
      "activities": [
        {
          "activityId": "act_001",
          "name": "渋谷スカイ展望",
          "description": "渋谷の街を一望できる展望台で記念写真を撮影",
          "location": "渋谷スカイ",
          "duration": 60,
          "cost": 2000,
          "category": "観光",
          "imageUrl": "https://example.com/images/shibuya-sky.jpg"
        },
        {
          "activityId": "act_002",
          "name": "おしゃれカフェでランチ",
          "description": "渋谷の人気カフェで美味しいランチを楽しむ",
          "location": "カフェ・ド・パリ",
          "duration": 90,
          "cost": 3000,
          "category": "食事",
          "imageUrl": "https://example.com/images/cafe-de-paris.jpg"
        },
        {
          "activityId": "act_003",
          "name": "渋谷の街を散策",
          "description": "渋谷の街をゆっくりと散策しながらショッピング",
          "location": "渋谷センター街",
          "duration": 120,
          "cost": 5000,
          "category": "ショッピング",
          "imageUrl": "https://example.com/images/shibuya-street.jpg"
        }
      ],
      "estimatedCost": 10000,
      "estimatedDuration": 270,
      "difficulty": "easy",
      "rating": 4.5,
      "tags": ["ロマンチック", "渋谷", "カフェ", "ショッピング"],
      "imageUrl": "https://example.com/images/romantic-date.jpg"
    },
    {
      "proposalId": "prop_002",
      "title": "新宿で楽しむアクティブデート",
      "description": "新宿で映画鑑賞と美味しいディナーを楽しむアクティブなデートプランです。",
      "activities": [
        {
          "activityId": "act_004",
          "name": "映画鑑賞",
          "description": "最新の映画を鑑賞して楽しむ",
          "location": "新宿ピカデリー",
          "duration": 120,
          "cost": 3000,
          "category": "エンターテイメント",
          "imageUrl": "https://example.com/images/movie-theater.jpg"
        },
        {
          "activityId": "act_005",
          "name": "美味しいディナー",
          "description": "新宿の人気レストランで美味しいディナーを楽しむ",
          "location": "レストラン・ル・シェフ",
          "duration": 90,
          "cost": 8000,
          "category": "食事",
          "imageUrl": "https://example.com/images/restaurant-le-chef.jpg"
        }
      ],
      "estimatedCost": 11000,
      "estimatedDuration": 210,
      "difficulty": "medium",
      "rating": 4.2,
      "tags": ["アクティブ", "新宿", "映画", "ディナー"],
      "imageUrl": "https://example.com/images/active-date.jpg"
    },
    {
      "proposalId": "prop_003",
      "title": "上野で過ごす文化的デート",
      "description": "上野の美術館と公園で過ごす文化的で落ち着いたデートプランです。",
      "activities": [
        {
          "activityId": "act_006",
          "name": "美術館鑑賞",
          "description": "上野の美術館でアートを鑑賞",
          "location": "上野の森美術館",
          "duration": 120,
          "cost": 1500,
          "category": "文化",
          "imageUrl": "https://example.com/images/art-museum.jpg"
        },
        {
          "activityId": "act_007",
          "name": "公園散策",
          "description": "上野公園を散策しながら自然を楽しむ",
          "location": "上野公園",
          "duration": 60,
          "cost": 0,
          "category": "自然",
          "imageUrl": "https://example.com/images/ueno-park.jpg"
        },
        {
          "activityId": "act_008",
          "name": "カフェでお茶",
          "description": "公園内のカフェでお茶を楽しむ",
          "location": "上野公園カフェ",
          "duration": 60,
          "cost": 1500,
          "category": "食事",
          "imageUrl": "https://example.com/images/park-cafe.jpg"
        }
      ],
      "estimatedCost": 3000,
      "estimatedDuration": 240,
      "difficulty": "easy",
      "rating": 4.0,
      "tags": ["文化的", "上野", "美術館", "公園"],
      "imageUrl": "https://example.com/images/cultural-date.jpg"
    }
  ]
}
```

### フィードバックデータ
```json
{
  "feedbacks": [
    {
      "feedbackId": "fb_001",
      "planId": "plan_001",
      "proposalId": "prop_001",
      "rating": 5,
      "comment": "とても楽しいデートプランでした。渋谷スカイからの景色が最高でした！",
      "submittedAt": "2025-01-27T10:00:00Z"
    },
    {
      "feedbackId": "fb_002",
      "planId": "plan_002",
      "proposalId": "prop_002",
      "rating": 4,
      "comment": "映画も美味しいディナーも楽しめました。また利用したいです。",
      "submittedAt": "2025-01-27T10:00:00Z"
    },
    {
      "feedbackId": "fb_003",
      "planId": "plan_003",
      "proposalId": "prop_003",
      "rating": 3,
      "comment": "美術館は良かったですが、もう少しアクティビティがあると良かったです。",
      "submittedAt": "2025-01-27T10:00:00Z"
    },
    {
      "feedbackId": "fb_004",
      "planId": "plan_004",
      "proposalId": "prop_004",
      "rating": 5,
      "comment": "完璧なデートプランでした。パートナーもとても喜んでいました。",
      "submittedAt": "2025-01-27T10:00:00Z"
    },
    {
      "feedbackId": "fb_005",
      "planId": "plan_005",
      "proposalId": "prop_005",
      "rating": 4,
      "comment": "予算内で楽しめるプランでした。また利用したいです。",
      "submittedAt": "2025-01-27T10:00:00Z"
    }
  ]
}
```

### プラン選択データ
```json
{
  "planSelections": [
    {
      "planId": "plan_001",
      "selectedProposalId": "prop_001",
      "status": "selected",
      "selectedAt": "2025-01-27T10:00:00Z"
    },
    {
      "planId": "plan_002",
      "selectedProposalId": "prop_002",
      "status": "selected",
      "selectedAt": "2025-01-27T10:00:00Z"
    },
    {
      "planId": "plan_003",
      "selectedProposalId": "prop_003",
      "status": "selected",
      "selectedAt": "2025-01-27T10:00:00Z"
    },
    {
      "planId": "plan_004",
      "selectedProposalId": "prop_004",
      "status": "selected",
      "selectedAt": "2025-01-27T10:00:00Z"
    },
    {
      "planId": "plan_005",
      "selectedProposalId": "prop_005",
      "status": "selected",
      "selectedAt": "2025-01-27T10:00:00Z"
    }
  ]
}
```

### エラーメッセージ
```json
{
  "errorMessages": {
    "proposalFetch": {
      "networkError": "プラン提案の取得に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "プラン提案の取得がタイムアウトしました",
      "notFound": "プラン提案が見つかりません"
    },
    "selection": {
      "required": "プランを選択してください",
      "networkError": "プラン選択に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "プラン選択がタイムアウトしました"
    },
    "feedback": {
      "ratingRequired": "評価を入力してください",
      "ratingInvalid": "1-5星で評価してください",
      "commentTooLong": "1,000文字以内で入力してください",
      "networkError": "フィードバックの送信に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "フィードバックの送信がタイムアウトしました"
    },
    "general": {
      "networkError": "ネットワークエラーが発生しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "タイムアウトが発生しました",
      "unknown": "不明なエラーが発生しました"
    }
  }
}
```

### 成功メッセージ
```json
{
  "successMessages": {
    "proposalsLoaded": "プラン提案が読み込まれました",
    "planSelected": "プランが選択されました",
    "feedbackSubmitted": "フィードバックが送信されました",
    "detailToggled": "詳細表示が切り替わりました"
  }
}
```

## 9. 最終チェックリスト

### 機能要件
- [ ] プラン提案取得機能が正常に動作する
- [ ] プラン選択機能が正常に動作する
- [ ] フィードバック送信機能が正常に動作する
- [ ] 詳細表示切り替え機能が正常に動作する
- [ ] プラン表示機能が正常に動作する

### 非機能要件
- [ ] レスポンシブデザインが実装されている
- [ ] アクセシビリティ（WCAG 2.1 AA）に準拠している
- [ ] パフォーマンス要件を満たしている
- [ ] セキュリティ要件が実装されている
- [ ] エラー率が許容範囲内である

### ユーザビリティ
- [ ] 直感的なUI/UXが実装されている
- [ ] 適切なフィードバックが提供されている
- [ ] プラン表示が分かりやすい
- [ ] エラーメッセージが分かりやすい
- [ ] キーボード操作が可能である

### セキュリティ
- [ ] プランデータが適切に保護されている
- [ ] HTTPS通信が強制されている
- [ ] 認証・認可が適切に実装されている
- [ ] プライバシー保護が実装されている
- [ ] データ削除機能が実装されている

### 技術要件
- [ ] プラン提案取得が適切に実装されている
- [ ] プラン選択が適切に実装されている
- [ ] フィードバック送信が適切に実装されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] 状態管理が適切に実装されている

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: ソフトウェアエンジニア・UX/UIデザイナー  
**承認者**: [承認者名]  
**レビュー者**: [レビュー者名]

# UC004-001: 仲裁依頼画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: カップルが対立状況を安全かつ正確に共有し、AI仲裁を依頼できるフォームを提供
- **ビジネスゴール**: 仲裁利用率の向上と関係悪化の早期防止による継続率改善
- **技術ゴール**: 信頼性の高いデータ収集と仲裁プロセス起動のトレーサビリティ確保

### 受け入れ基準
- 既存関係性データが3秒以内に表示される
- 仲裁依頼送信が2秒以内に完了する
- 必須入力の未入力時に即時バリデーションを表示
- フォームはモバイル・デスクトップ両対応でWCAG 2.1 AAを満たす
- 送信結果は成功・失敗に応じたトースト通知でフィードバック

### 機能段階性
1. **基礎**: 関係性データ読込、対立履歴表示、仲裁依頼送信、バリデーション
2. **拡張**: 自動トーン分析プレビュー、テンプレート入力補助、依頼進捗表示
3. **制約**: 深刻度の入力上限、添付ファイルサイズ制限、依頼頻度制御

## 2. 仕様の厳密化

### コア機能

#### 関係性データ取得
- **取得**: 既存の関係性スコア・最近のイベント履歴を取得
- **表示**: 読み取り専用カードで直近の関係性状況を表示
- **失敗**: 再試行ボタンとサポートメッセージを表示

#### 過去対立履歴取得
- **取得**: 最新3件の対立ログを取得
- **表示**: タイムライン形式で概要と対応状況を表示
- **フィルタ**: 深刻度でフィルタリング

#### 仲裁依頼フォーム
- **入力**: 対立概要、希望スタンス、緊急度、連絡可能時間帯
- **ガイド**: 入力補助のプレースホルダーと例文を表示
- **バリデーション**: リアルタイムで必須項目と文字数制限を確認
- **送信**: POST /api/v1/mediation/request
- **完了**: 成功時に状況分析画面への遷移準備とイベント送信を行う

#### 安心設計要素
- **トラストバッジ**: データ保護説明を常時表示
- **匿名化オプション**: 表示名を非公開化するトグルを提供
- **確認モーダル**: 送信前に要約を確認するダイアログ

### 入力制約 & バリデーション

#### coupleId
- **形式**: UUID v4
- **必須**: 隠しフィールドで必須
- **エラーメッセージ**: "カップルIDが取得できません。再読み込みしてください"

#### conflictSummary
- **形式**: 50〜1000文字のテキスト
- **必須**: 必須項目
- **エラーメッセージ**: "対立内容を具体的に入力してください（50文字以上）"

#### severity
- **形式**: enum(low | medium | high | critical)
- **必須**: 必須項目
- **エラーメッセージ**: "深刻度を選択してください"

#### preferredOutcome
- **形式**: 0〜200文字
- **必須**: 任意
- **エラーメッセージ**: "200文字以内で入力してください"

#### availabilitySlots
- **形式**: ISO 8601形式の日時配列
- **必須**: 任意だが最少1件推奨
- **エラーメッセージ**: "有効な日時を選択してください"

### データモデル & API

#### リクエストモデル
~~~typescript
interface MediationRequestPayload {
  coupleId: string;
  conflictSummary: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  triggers?: string[];
  preferredOutcome?: string;
  availabilitySlots?: string[];
  allowPartnerNotification: boolean;
  anonymousSubmission: boolean;
}

interface RelationshipDataRequest {
  coupleId: string;
}

interface ConflictHistoryRequest {
  coupleId: string;
  limit?: number;
}
~~~

#### レスポンスモデル
~~~typescript
interface RelationshipDataResponse {
  coupleId: string;
  relationshipScore: number;
  trend: 'improving' | 'stable' | 'declining';
  lastInteractionAt?: string;
  sharedGoals?: string[];
}

interface ConflictHistoryItem {
  conflictId: string;
  occurredAt: string;
  summary: string;
  severity: 'low' | 'medium' | 'high' | 'critical';
  resolutionStatus: 'open' | 'in_progress' | 'resolved';
}

interface ConflictHistoryResponse {
  items: ConflictHistoryItem[];
  totalCount: number;
}

interface MediationRequestResponse {
  mediationId: string;
  status: 'queued' | 'processing';
  estimatedStartAt: string;
}
~~~

#### API エンドポイント
- **仲裁依頼送信**: POST /api/v1/mediation/request
- **関係性データ取得**: GET /api/v1/relationships/{coupleId}
- **対立履歴取得**: GET /api/v1/conflicts/history

### UX / A11y

#### キーボード操作
- **Tab順序**: インサイトカード → フォーム入力 → プライバシー設定 → 送信ボタン
- **Enter**: フォーム送信・モーダル確定
- **Space**: トグル切替
- **Esc**: 確認モーダルを閉じる

#### スクリーンリーダー対応
- aria-live="polite": バリデーションメッセージ
- aria-describedby: 各入力の補足説明
- role="status": 送信成功・失敗トースト
- aria-controls: 匿名化トグルと説明文の関連付け

#### 情緒デザイン
- 低彩度のカラーパレットで安心感を演出
- ステップ表示で入力負荷を軽減
- 完了メッセージに肯定的なコピーを使用

### セキュリティ & プライバシー
- **通信**: HTTPS/TLS1.3以上
- **保存**: 対立概要は暗号化ストレージ
- **ロギング**: 個人情報を含めない構造化ログ
- **アクセス制御**: 認証 + カップル所属チェック + RBAC

### 非機能要件
- **レスポンス**: データ取得3秒以内、送信2秒以内
- **耐障害性**: API失敗時は指数バックオフで最大3回再試行
- **スケール**: 同時接続 5,000 セッション
- **可観測性**: 送信イベントとエラー率を計測しダッシュボード化

## 3. 曖昧さと解決

### 深刻度定義
- low: 軽い口論、双方冷静
- medium: 感情的だが対話可能
- high: 強い感情対立で第三者介入が望ましい
- critical: 早急な対応が必要な高リスクケース

### 匿名化オプション
- デフォルトOFF
- ON時は仲裁レポートから表示名と顔写真を除外
- システム内部では監査用に関連付けを保持

### 添付情報
- 画像・音声添付は初期リリースでは非対応
- 将来対応時に向けフォールバックテキストの表示領域を確保

## 4. 受け入れ基準例（Gherkin風）

### 仲裁依頼送信
~~~gherkin
Given カップルユーザーが仲裁依頼画面を開く
And 必須項目を正しく入力する
When 仲裁依頼を送信する
Then 2秒以内に送信成功メッセージが表示される
And 状況分析画面への遷移ボタンが活性化される

Given 必須項目が未入力である
When 仲裁依頼送信ボタンを押す
Then 当該項目にバリデーションメッセージが表示される
And APIリクエストは送信されない
~~~

### データ取得
~~~gherkin
Given カップルユーザーが仲裁依頼画面を開く
When 関係性データの取得に失敗する
Then エラーアラートと再試行ボタンが表示される
And 依頼送信フォームは読み込み状態のままとなる
~~~

## 5. リスクとトレードオフ

### 技術リスク
- API応答遅延によるUX低下 → スケルトンUIと再試行導線で緩和
- 重複送信 → 前回送信完了までボタンを非活性化
- 履歴APIの大量レスポンス → ページングとフィルタを適用

### UXリスク
- 入力負荷が高い → ステップ別フォームとテンプレート案内を提供
- ネガティブ感情の喚起 → 共感的コピーと安心感のある色使い
- 深刻度の誤選択 → ツールチップで定義を提示

### プライバシーリスク
- 機密情報の誤共有 → 匿名化トグルと注意喚起を常时表示
- ログへの生データ混入 → サニタイズ処理を徹底

## 6. 拡張余地

### 短期拡張
- 感情トーン自動解析サマリー
- 依頼テンプレートのプリセット
- 音声入力サポート

### 中期拡張
- AIチャットによる入力支援
- 対立カテゴリ別のFAQ表示
- リアルタイム共同入力モード

### 長期拡張
- 外部専門家との連携オプション
- 法的アドバイス連携
- 自動再発防止プラン提案

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand（フォーム状態・APIレスポンスキャッシュ）
- **フォーム管理**: React Hook Form + Zodスキーマ
- **HTTPクライアント**: Axios（リトライ設定付き）

### コンポーネント設計
~~~typescript
interface MediationRequestFormProps {
  coupleId: string;
  onSubmitted: (mediationId: string) => void;
  onError: (message: string) => void;
}

interface RelationshipSnapshotProps {
  data: RelationshipDataResponse | null;
  loading: boolean;
  onRetry: () => void;
}

interface ConflictHistoryTimelineProps {
  items: ConflictHistoryItem[];
  loading: boolean;
  filter: 'all' | 'low' | 'medium' | 'high' | 'critical';
  onFilterChange: (filter: 'all' | 'low' | 'medium' | 'high' | 'critical') => void;
}
~~~

### スタイリング
~~~css
.mediation-request-page {
  @apply max-w-3xl mx-auto space-y-6 px-4 py-8;
}

.section-card {
  @apply bg-white rounded-xl shadow-sm border border-slate-200;
}

.section-header {
  @apply flex items-center justify-between px-6 py-4 border-b border-slate-100;
}

.form-grid {
  @apply grid grid-cols-1 md:grid-cols-2 gap-6 px-6 pb-6;
}

.validation-message {
  @apply text-sm text-rose-600 mt-2;
}

.submit-area {
  @apply flex flex-col md:flex-row md:items-center md:justify-between gap-4 px-6 pb-6;
}
~~~

### テレメトリ
- 送信成功/失敗、匿名化トグル、再試行イベントを計測
- APIレイテンシとバリデーションエラー率をダッシュボード化


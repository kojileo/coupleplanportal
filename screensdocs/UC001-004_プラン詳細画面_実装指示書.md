# UC001-004: プラン詳細画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: 選択されたデートプランの詳細情報表示と外部情報連携を提供
- **ビジネスゴール**: ユーザー体験の向上と外部サービス連携による価値提供
- **技術ゴール**: 高品質なプラン詳細表示と地図・予算計算機能の実現

### 受け入れ基準
- プラン詳細が2秒以内に表示される
- 外部情報取得が5秒以内に完了する
- 地図表示が3秒以内に完了する
- モバイル・デスクトップ両対応のレスポンシブデザイン
- WCAG 2.1 AA準拠のアクセシビリティ

### 機能段階性
1. **基礎**: プラン詳細表示、地図表示、予算計算
2. **拡張**: 外部情報連携、予約機能、ナビゲーション
3. **制約**: 表示制限、外部API制限、地図制限

## 2. 仕様の厳密化

### コア機能

#### プラン詳細取得
- **取得**: 選択されたプランの詳細情報取得
- **表示**: プラン詳細の表示
- **更新**: プラン情報の更新
- **完了**: 詳細取得完了の通知

#### 外部情報取得
- **取得**: 外部サービスからの情報取得
- **表示**: 外部情報の表示
- **更新**: 外部情報の更新
- **完了**: 外部情報取得完了の通知

#### 地図表示
- **表示**: インタラクティブな地図表示
- **マーカー**: 場所のマーカー表示
- **ルート**: ルートの表示
- **操作**: 地図の操作機能

#### 予算計算
- **計算**: リアルタイム予算計算
- **表示**: 予算内訳の表示
- **更新**: 予算の更新
- **完了**: 計算完了の通知

### 入力制約 & バリデーション

#### プランID
- **形式**: UUID形式
- **必須**: 必須項目
- **エラーメッセージ**: "有効なプランIDを入力してください"

#### 場所ID
- **形式**: 文字列
- **必須**: 必須項目
- **エラーメッセージ**: "有効な場所IDを入力してください"

#### 予算
- **範囲**: 0-100,000円
- **形式**: 数値のみ
- **エラーメッセージ**: "0円以上100,000円以下で入力してください"

### データモデル & API

#### リクエストモデル
```typescript
interface PlanDetailRequest {
  planId: string;
  userId: string;
}

interface ExternalInfoRequest {
  placeId: string;
  category: string;
}

interface MapRequest {
  locations: Location[];
  routeType: 'walking' | 'driving' | 'transit';
}
```

#### レスポンスモデル
```typescript
interface PlanDetailResponse {
  planId: string;
  title: string;
  description: string;
  activities: ActivityDetail[];
  estimatedCost: number;
  estimatedDuration: number;
  difficulty: 'easy' | 'medium' | 'hard';
  rating: number;
  tags: string[];
  imageUrl?: string;
  createdAt: string;
  updatedAt: string;
}

interface ActivityDetail {
  activityId: string;
  name: string;
  description: string;
  location: Location;
  duration: number; // minutes
  cost: number;
  category: string;
  imageUrl?: string;
  externalInfo?: ExternalInfo;
}

interface Location {
  placeId: string;
  name: string;
  address: string;
  latitude: number;
  longitude: number;
  phone?: string;
  website?: string;
  rating?: number;
  priceLevel?: number;
}

interface ExternalInfo {
  placeId: string;
  name: string;
  description: string;
  rating: number;
  priceLevel: number;
  openingHours: string[];
  photos: string[];
  reviews: Review[];
}

interface Review {
  author: string;
  rating: number;
  text: string;
  date: string;
}

interface BudgetCalculation {
  totalCost: number;
  breakdown: CostBreakdown[];
  savings: number;
  recommendations: string[];
}

interface CostBreakdown {
  category: string;
  amount: number;
  percentage: number;
}
```

#### API エンドポイント
- **プラン詳細取得**: `GET /api/v1/plans/{planId}`
- **外部情報取得**: `GET /api/v1/external/places`
- **地図情報取得**: `GET /api/v1/maps/locations`

### UX / A11y

#### キーボード操作
- **Tab順序**: プラン詳細 → 地図 → 予算計算 → アクションボタン
- **Enter**: アクション実行
- **Escape**: モーダル閉じる
- **矢印キー**: 地図操作

#### スクリーンリーダー対応
- **aria-label**: 各要素の説明
- **aria-live**: 動的コンテンツの読み上げ
- **aria-describedby**: 詳細説明の関連付け
- **role**: 要素の役割定義

#### 色覚対応
- **地図マーカー**: 色 + アイコン + テキスト
- **予算表示**: 色 + 数値 + テキスト
- **フォーカス**: 色 + アウトライン + 影

### セキュリティ & プライバシー

#### データ保護
- **プランデータ**: 暗号化された保存
- **通信**: HTTPS強制、TLS 1.3以上
- **アクセス**: 認証済みユーザーのみ
- **外部API**: 適切なAPIキー管理

#### プライバシー保護
- **位置情報**: 最小限の位置情報収集
- **外部データ**: 適切なデータ保護
- **ユーザー情報**: 匿名化された分析
- **データ削除**: ユーザー要求による削除

### 非機能要件

#### パフォーマンス
- **プラン詳細取得**: 2秒以内
- **外部情報取得**: 5秒以内
- **地図表示**: 3秒以内
- **予算計算**: 1秒以内

#### 可用性
- **稼働率**: 99.9%以上
- **エラー率**: 1%以下
- **復旧時間**: 5分以内

#### スケーラビリティ
- **同時接続**: 10,000ユーザー
- **スループット**: 1,000リクエスト/秒
- **地図表示**: 100件/秒

## 3. 曖昧さと解決

### 地図表示
- **マーカー**: 各場所のマーカー表示
- **ルート**: 場所間のルート表示
- **ズーム**: 適切なズームレベル
- **操作**: パン・ズーム操作

### 外部情報
- **取得**: 外部APIからの情報取得
- **表示**: 外部情報の表示
- **更新**: 外部情報の更新
- **エラー**: 外部情報取得失敗時の処理

### 予算計算
- **リアルタイム**: リアルタイム予算計算
- **内訳**: 予算内訳の表示
- **推奨**: 予算最適化の推奨
- **更新**: 予算の更新

## 4. 受け入れ基準例（Gherkin風）

### プラン詳細表示
```gherkin
Given ユーザーがプラン詳細画面にアクセス
When プラン詳細が取得される
Then プラン詳細が表示される
And 2秒以内に表示される

Given ユーザーがプラン詳細画面にアクセス
When プラン詳細の取得に失敗
Then エラーメッセージが表示される
And 再試行ボタンが表示される
```

### 地図表示
```gherkin
Given ユーザーがプラン詳細画面にアクセス
When 地図が読み込まれる
Then 地図が表示される
And 3秒以内に表示される
And 場所のマーカーが表示される

Given ユーザーがプラン詳細画面にアクセス
When 地図の読み込みに失敗
Then エラーメッセージが表示される
And 地図の代替表示が表示される
```

## 5. リスクとトレードオフ

### 技術リスク
- **外部API失敗**: 適切なエラーハンドリング
- **地図表示失敗**: 適切なエラーハンドリング
- **予算計算失敗**: 適切なエラーハンドリング

### UXリスク
- **複雑な表示**: 分かりやすい情報表示
- **地図操作**: 直感的な地図操作
- **予算表示**: 分かりやすい予算表示

### パフォーマンスリスク
- **外部API遅延**: 適切なタイムアウト設定
- **地図描画**: 適切な地図最適化
- **大量データ**: 適切なデータ管理

## 6. 拡張余地

### 短期拡張
- **予約機能**: プランに基づく予約機能
- **ナビゲーション**: プランに基づくナビゲーション
- **共有機能**: プランの共有機能

### 中期拡張
- **リアルタイム更新**: リアルタイムでの情報更新
- **カスタマイズ**: プランのカスタマイズ機能
- **分析**: プラン使用パターンの分析

### 長期拡張
- **VR対応**: VR環境でのプラン表示
- **AI最適化**: AIによるプラン最適化
- **予測**: 未来のプラン予測

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **HTTP クライアント**: Axios
- **地図**: MapBox API
- **アニメーション**: Framer Motion

### コンポーネント設計
```typescript
// メインコンポーネント
interface PlanDetailProps {
  planId: string;
  userId: string;
  onEdit: (planId: string) => void;
  onShare: (planId: string) => void;
  onError: (error: string) => void;
}

// 地図コンポーネント
interface MapComponentProps {
  locations: Location[];
  routeType: 'walking' | 'driving' | 'transit';
  onLocationClick: (location: Location) => void;
}

// 予算計算コンポーネント
interface BudgetCalculatorProps {
  activities: ActivityDetail[];
  onBudgetChange: (budget: BudgetCalculation) => void;
}
```

### スタイリング
```css
/* レスポンシブデザイン */
.plan-detail-container {
  @apply max-w-6xl mx-auto p-6 bg-white rounded-lg shadow-md;
}

.plan-header {
  @apply mb-6;
}

.plan-title {
  @apply text-3xl font-bold text-gray-800 mb-2;
}

.plan-description {
  @apply text-gray-600 mb-4;
}

.plan-meta {
  @apply flex items-center space-x-4 text-sm text-gray-500 mb-6;
}

.activities-section {
  @apply mb-8;
}

.activity-card {
  @apply bg-white border border-gray-200 rounded-lg p-6 mb-4 hover:shadow-md transition-shadow;
}

.activity-header {
  @apply flex items-center justify-between mb-3;
}

.activity-name {
  @apply text-xl font-semibold text-gray-800;
}

.activity-cost {
  @apply text-lg font-bold text-green-600;
}

.activity-description {
  @apply text-gray-600 mb-3;
}

.activity-location {
  @apply text-sm text-gray-500 mb-3;
}

.map-section {
  @apply mb-8;
}

.map-container {
  @apply w-full h-96 bg-gray-100 rounded-lg overflow-hidden;
}

.budget-section {
  @apply bg-gray-50 rounded-lg p-6;
}

.budget-total {
  @apply text-2xl font-bold text-gray-800 mb-4;
}

.budget-breakdown {
  @apply space-y-2;
}

.budget-item {
  @apply flex items-center justify-between text-sm;
}

.budget-category {
  @apply text-gray-600;
}

.budget-amount {
  @apply font-semibold text-gray-800;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  .plan-detail-container {
    @apply bg-gray-800;
  }
  .plan-title {
    @apply text-gray-200;
  }
  .plan-description {
    @apply text-gray-400;
  }
  .plan-meta {
    @apply text-gray-500;
  }
  .activity-card {
    @apply bg-gray-700 border-gray-600;
  }
  .activity-name {
    @apply text-gray-200;
  }
  .activity-description {
    @apply text-gray-400;
  }
  .activity-location {
    @apply text-gray-500;
  }
  .map-container {
    @apply bg-gray-700;
  }
  .budget-section {
    @apply bg-gray-700;
  }
  .budget-total {
    @apply text-gray-200;
  }
  .budget-category {
    @apply text-gray-400;
  }
  .budget-amount {
    @apply text-gray-200;
  }
}
```

## 8. 日本語サンプルデータ

### プラン詳細データ
```json
{
  "planDetails": [
    {
      "planId": "plan_001",
      "title": "渋谷で過ごすロマンチックなデート",
      "description": "渋谷の街を散策しながら、おしゃれなカフェとレストランで過ごすロマンチックなデートプランです。",
      "activities": [
        {
          "activityId": "act_001",
          "name": "渋谷スカイ展望",
          "description": "渋谷の街を一望できる展望台で記念写真を撮影",
          "location": {
            "placeId": "place_001",
            "name": "渋谷スカイ",
            "address": "東京都渋谷区渋谷2-1-1",
            "latitude": 35.6581,
            "longitude": 139.7016,
            "phone": "03-1234-5678",
            "website": "https://www.shibuya-sky.com",
            "rating": 4.5,
            "priceLevel": 2
          },
          "duration": 60,
          "cost": 2000,
          "category": "観光",
          "imageUrl": "https://example.com/images/shibuya-sky.jpg",
          "externalInfo": {
            "placeId": "place_001",
            "name": "渋谷スカイ",
            "description": "渋谷の新ランドマーク。地上229mの展望台から東京の街を一望できます。",
            "rating": 4.5,
            "priceLevel": 2,
            "openingHours": [
              "月曜日: 10:00-22:30",
              "火曜日: 10:00-22:30",
              "水曜日: 10:00-22:30",
              "木曜日: 10:00-22:30",
              "金曜日: 10:00-22:30",
              "土曜日: 10:00-22:30",
              "日曜日: 10:00-22:30"
            ],
            "photos": [
              "https://example.com/photos/shibuya-sky-1.jpg",
              "https://example.com/photos/shibuya-sky-2.jpg",
              "https://example.com/photos/shibuya-sky-3.jpg"
            ],
            "reviews": [
              {
                "author": "田中太郎",
                "rating": 5,
                "text": "景色が最高でした！東京の街が一望できて感動しました。",
                "date": "2025-01-20"
              },
              {
                "author": "佐藤花子",
                "rating": 4,
                "text": "混雑していましたが、景色は素晴らしかったです。",
                "date": "2025-01-19"
              }
            ]
          }
        },
        {
          "activityId": "act_002",
          "name": "おしゃれカフェでランチ",
          "description": "渋谷の人気カフェで美味しいランチを楽しむ",
          "location": {
            "placeId": "place_002",
            "name": "カフェ・ド・パリ",
            "address": "東京都渋谷区渋谷1-2-3",
            "latitude": 35.6598,
            "longitude": 139.7006,
            "phone": "03-2345-6789",
            "website": "https://www.cafe-de-paris.com",
            "rating": 4.2,
            "priceLevel": 3
          },
          "duration": 90,
          "cost": 3000,
          "category": "食事",
          "imageUrl": "https://example.com/images/cafe-de-paris.jpg",
          "externalInfo": {
            "placeId": "place_002",
            "name": "カフェ・ド・パリ",
            "description": "渋谷の人気カフェ。フレンチスタイルの料理とコーヒーが自慢です。",
            "rating": 4.2,
            "priceLevel": 3,
            "openingHours": [
              "月曜日: 8:00-20:00",
              "火曜日: 8:00-20:00",
              "水曜日: 8:00-20:00",
              "木曜日: 8:00-20:00",
              "金曜日: 8:00-20:00",
              "土曜日: 8:00-20:00",
              "日曜日: 8:00-20:00"
            ],
            "photos": [
              "https://example.com/photos/cafe-de-paris-1.jpg",
              "https://example.com/photos/cafe-de-paris-2.jpg",
              "https://example.com/photos/cafe-de-paris-3.jpg"
            ],
            "reviews": [
              {
                "author": "山田次郎",
                "rating": 4,
                "text": "料理が美味しく、雰囲気も良かったです。",
                "date": "2025-01-18"
              },
              {
                "author": "鈴木三郎",
                "rating": 5,
                "text": "コーヒーが最高でした！また来たいです。",
                "date": "2025-01-17"
              }
            ]
          }
        }
      ],
      "estimatedCost": 10000,
      "estimatedDuration": 270,
      "difficulty": "easy",
      "rating": 4.5,
      "tags": ["ロマンチック", "渋谷", "カフェ", "ショッピング"],
      "imageUrl": "https://example.com/images/romantic-date.jpg",
      "createdAt": "2025-01-27T10:00:00Z",
      "updatedAt": "2025-01-27T10:00:00Z"
    }
  ]
}
```

### 予算計算データ
```json
{
  "budgetCalculations": [
    {
      "totalCost": 10000,
      "breakdown": [
        {
          "category": "観光",
          "amount": 2000,
          "percentage": 20
        },
        {
          "category": "食事",
          "amount": 3000,
          "percentage": 30
        },
        {
          "category": "ショッピング",
          "amount": 5000,
          "percentage": 50
        }
      ],
      "savings": 2000,
      "recommendations": [
        "ランチを少し控えめにすると500円節約できます",
        "ショッピングで割引クーポンを使用すると1000円節約できます",
        "交通費を事前に調べると500円節約できます"
      ]
    }
  ]
}
```

### 地図データ
```json
{
  "mapData": [
    {
      "locations": [
        {
          "placeId": "place_001",
          "name": "渋谷スカイ",
          "address": "東京都渋谷区渋谷2-1-1",
          "latitude": 35.6581,
          "longitude": 139.7016,
          "type": "観光"
        },
        {
          "placeId": "place_002",
          "name": "カフェ・ド・パリ",
          "address": "東京都渋谷区渋谷1-2-3",
          "latitude": 35.6598,
          "longitude": 139.7006,
          "type": "食事"
        },
        {
          "placeId": "place_003",
          "name": "渋谷センター街",
          "address": "東京都渋谷区道玄坂2-1",
          "latitude": 35.6595,
          "longitude": 139.7005,
          "type": "ショッピング"
        }
      ],
      "routeType": "walking",
      "totalDistance": 1.2,
      "totalDuration": 15
    }
  ]
}
```

### エラーメッセージ
```json
{
  "errorMessages": {
    "planDetail": {
      "networkError": "プラン詳細の取得に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "プラン詳細の取得がタイムアウトしました",
      "notFound": "プラン詳細が見つかりません"
    },
    "externalInfo": {
      "networkError": "外部情報の取得に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "外部情報の取得がタイムアウトしました",
      "notFound": "外部情報が見つかりません"
    },
    "map": {
      "loadError": "地図の読み込みに失敗しました",
      "renderError": "地図の表示に失敗しました",
      "apiError": "地図APIエラーが発生しました",
      "permissionError": "地図の使用権限がありません"
    },
    "budget": {
      "calculationError": "予算計算に失敗しました",
      "dataError": "予算データにエラーがあります",
      "validationError": "予算データの検証に失敗しました"
    },
    "general": {
      "networkError": "ネットワークエラーが発生しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "タイムアウトが発生しました",
      "unknown": "不明なエラーが発生しました"
    }
  }
}
```

### 成功メッセージ
```json
{
  "successMessages": {
    "planDetailLoaded": "プラン詳細が読み込まれました",
    "externalInfoLoaded": "外部情報が読み込まれました",
    "mapLoaded": "地図が読み込まれました",
    "budgetCalculated": "予算が計算されました"
  }
}
```

## 9. 最終チェックリスト

### 機能要件
- [ ] プラン詳細取得機能が正常に動作する
- [ ] 外部情報取得機能が正常に動作する
- [ ] 地図表示機能が正常に動作する
- [ ] 予算計算機能が正常に動作する
- [ ] プラン詳細表示機能が正常に動作する

### 非機能要件
- [ ] レスポンシブデザインが実装されている
- [ ] アクセシビリティ（WCAG 2.1 AA）に準拠している
- [ ] パフォーマンス要件を満たしている
- [ ] セキュリティ要件が実装されている
- [ ] エラー率が許容範囲内である

### ユーザビリティ
- [ ] 直感的なUI/UXが実装されている
- [ ] 適切なフィードバックが提供されている
- [ ] プラン詳細表示が分かりやすい
- [ ] エラーメッセージが分かりやすい
- [ ] キーボード操作が可能である

### セキュリティ
- [ ] プランデータが適切に保護されている
- [ ] HTTPS通信が強制されている
- [ ] 認証・認可が適切に実装されている
- [ ] 外部APIが適切に管理されている
- [ ] プライバシー保護が実装されている

### 技術要件
- [ ] プラン詳細取得が適切に実装されている
- [ ] 外部情報取得が適切に実装されている
- [ ] 地図表示が適切に実装されている
- [ ] 予算計算が適切に実装されている
- [ ] エラーハンドリングが適切に実装されている

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: ソフトウェアエンジニア・UX/UIデザイナー  
**承認者**: [承認者名]  
**レビュー者**: [レビュー者名]

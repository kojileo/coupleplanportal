# UC002-001: 共同編集画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: カップルでのリアルタイム協働編集と競合解決機能を提供
- **ビジネスゴール**: ユーザーエンゲージメント向上と協働体験の価値提供
- **技術ゴール**: 高品質なリアルタイム同期と競合解決システムの実現

### 受け入れ基準
- 編集セッション開始が3秒以内に完了する
- リアルタイム同期が100ms以内に反映される
- 競合検出が500ms以内に完了する
- モバイル・デスクトップ両対応のレスポンシブデザイン
- WCAG 2.1 AA準拠のアクセシビリティ

### 機能段階性
1. **基礎**: セッション開始、リアルタイム同期、競合検出
2. **拡張**: カーソル位置同期、編集履歴、協働状態表示
3. **制約**: 同時編集制限、セッション制限、競合解決制限

## 2. 仕様の厳密化

### コア機能

#### 編集セッション開始
- **開始**: 新しい編集セッションの開始
- **参加**: 既存セッションへの参加
- **状態**: セッション状態の管理
- **完了**: セッション開始完了の通知

#### リアルタイム同期
- **送信**: 編集操作の送信
- **受信**: 他ユーザーの編集操作受信
- **適用**: 編集操作の適用
- **完了**: 同期完了の通知

#### 編集操作送信
- **操作**: 編集操作の記録
- **送信**: 操作の送信
- **確認**: 送信確認
- **完了**: 送信完了の通知

#### 競合検出
- **検出**: 編集競合の検出
- **通知**: 競合通知
- **解決**: 競合解決
- **完了**: 解決完了の通知

#### カーソル位置同期
- **追跡**: カーソル位置の追跡
- **送信**: カーソル位置の送信
- **表示**: 他ユーザーのカーソル表示
- **更新**: カーソル位置の更新

### 入力制約 & バリデーション

#### セッションID
- **形式**: UUID形式
- **必須**: 必須項目
- **エラーメッセージ**: "有効なセッションIDを入力してください"

#### 編集操作
- **形式**: JSON形式
- **必須**: 必須項目
- **エラーメッセージ**: "有効な編集操作を入力してください"

#### 競合ID
- **形式**: UUID形式
- **必須**: 必須項目
- **エラーメッセージ**: "有効な競合IDを入力してください"

### データモデル & API

#### リクエストモデル
```typescript
interface SessionStartRequest {
  planId: string;
  userId: string;
  sessionType: 'create' | 'join';
}

interface EditOperationRequest {
  sessionId: string;
  operation: EditOperation;
  userId: string;
  timestamp: string;
}

interface EditOperation {
  type: 'insert' | 'delete' | 'replace' | 'move';
  position: number;
  content?: string;
  length?: number;
  metadata?: any;
}

interface ConflictDetectionRequest {
  sessionId: string;
  operation: EditOperation;
  userId: string;
}
```

#### レスポンスモデル
```typescript
interface SessionStartResponse {
  sessionId: string;
  planId: string;
  participants: Participant[];
  status: 'active' | 'inactive';
  createdAt: string;
}

interface Participant {
  userId: string;
  name: string;
  profileImage?: string;
  cursorPosition?: number;
  isActive: boolean;
  lastSeen: string;
}

interface EditOperationResponse {
  operationId: string;
  sessionId: string;
  operation: EditOperation;
  userId: string;
  timestamp: string;
  status: 'applied' | 'conflict' | 'pending';
}

interface ConflictDetectionResponse {
  conflictId: string;
  sessionId: string;
  conflictingOperations: EditOperation[];
  conflictType: 'content' | 'position' | 'format';
  severity: 'low' | 'medium' | 'high';
  detectedAt: string;
}
```

#### API エンドポイント
- **セッション開始**: `POST /api/v1/sessions`
- **編集同期**: `WebSocket /api/v1/sessions/{sessionId}/sync`
- **編集操作登録**: `POST /api/v1/sessions/{sessionId}/operations`

### UX / A11y

#### キーボード操作
- **Tab順序**: 編集エリア → ツールバー → 参加者一覧 → セッション設定
- **Enter**: 編集操作の実行
- **Escape**: 競合解決ダイアログの閉じる
- **矢印キー**: カーソル移動

#### スクリーンリーダー対応
- **aria-label**: 各編集要素の説明
- **aria-live**: 編集操作の読み上げ
- **aria-describedby**: 編集説明の関連付け
- **role**: 編集要素の役割定義

#### 色覚対応
- **参加者表示**: 色 + アイコン + テキスト
- **競合表示**: 色 + 警告アイコン + テキスト
- **カーソル表示**: 色 + カーソルアイコン + テキスト

### セキュリティ & プライバシー

#### データ保護
- **編集データ**: 暗号化された保存
- **通信**: HTTPS強制、TLS 1.3以上
- **アクセス**: 認証済みユーザーのみ
- **セッション**: 適切なセッション管理

#### セキュリティ検証
- **ユーザー認証**: セッション参加者との一致確認
- **権限確認**: 編集権限の確認
- **データ整合性**: 編集データの整合性確認

### 非機能要件

#### パフォーマンス
- **セッション開始**: 3秒以内
- **リアルタイム同期**: 100ms以内
- **競合検出**: 500ms以内
- **カーソル同期**: 50ms以内

#### 可用性
- **稼働率**: 99.9%以上
- **エラー率**: 1%以下
- **復旧時間**: 5分以内

#### スケーラビリティ
- **同時接続**: 10,000ユーザー
- **スループット**: 1,000リクエスト/秒
- **リアルタイム同期**: 100件/秒

## 3. 曖昧さと解決

### リアルタイム同期
- **WebSocket**: リアルタイム通信
- **Operational Transform**: 競合解決アルゴリズム
- **状態管理**: 編集状態の管理
- **エラー処理**: 同期エラーの処理

### 競合解決
- **自動解決**: 自動的な競合解決
- **手動解決**: 手動での競合解決
- **優先度**: 競合解決の優先度
- **履歴**: 競合解決履歴

### セッション管理
- **開始**: セッション開始
- **参加**: セッション参加
- **終了**: セッション終了
- **復旧**: セッション復旧

## 4. 受け入れ基準例（Gherkin風）

### セッション開始
```gherkin
Given ユーザーが共同編集画面にアクセス
When セッション開始ボタンをクリック
Then セッションが開始される
And 3秒以内に完了する

Given ユーザーが共同編集画面にアクセス
When 既存セッションに参加
Then セッションに参加される
And 参加者一覧が更新される
```

### リアルタイム同期
```gherkin
Given ユーザーが共同編集画面にアクセス
When テキストを編集
Then 編集操作が送信される
And 100ms以内に同期される

Given ユーザーが共同編集画面にアクセス
When 他ユーザーが編集
Then 編集操作が受信される
And リアルタイムで反映される
```

## 5. リスクとトレードオフ

### 技術リスク
- **WebSocket接続**: 適切な接続管理
- **競合解決**: 適切な競合解決アルゴリズム
- **状態管理**: 適切な状態管理

### UXリスク
- **複雑な編集**: 分かりやすい編集インターフェース
- **競合表示**: 分かりやすい競合表示
- **同期遅延**: 適切な同期状態表示

### パフォーマンスリスク
- **大量操作**: 適切な操作バッチング
- **ネットワーク遅延**: 適切なタイムアウト設定
- **メモリ使用量**: 効率的な状態管理

## 6. 拡張余地

### 短期拡張
- **編集履歴**: 編集履歴の表示
- **コメント機能**: 編集に対するコメント
- **バージョン管理**: バージョン管理機能

### 中期拡張
- **AI支援**: AIによる編集支援
- **テンプレート**: 編集テンプレート機能
- **分析**: 編集パターンの分析

### 長期拡張
- **VR対応**: VR環境での協働編集
- **音声入力**: 音声による編集
- **予測**: 編集内容の予測

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand
- **WebSocket**: Socket.io
- **編集エディタ**: Monaco Editor
- **競合解決**: Operational Transform

### コンポーネント設計
```typescript
// メインコンポーネント
interface CollaborativeEditorProps {
  planId: string;
  userId: string;
  onSessionStart: (sessionId: string) => void;
  onSessionEnd: (sessionId: string) => void;
  onError: (error: string) => void;
}

// 編集エディタ
interface EditorComponentProps {
  content: string;
  onContentChange: (content: string) => void;
  onOperation: (operation: EditOperation) => void;
  participants: Participant[];
  conflicts: Conflict[];
}

// 競合解決
interface ConflictResolverProps {
  conflict: Conflict;
  onResolve: (resolution: ConflictResolution) => void;
  onDismiss: () => void;
}
```

### スタイリング
```css
/* レスポンシブデザイン */
.collaborative-editor {
  @apply flex flex-col h-screen bg-white;
}

.editor-header {
  @apply flex items-center justify-between p-4 border-b border-gray-200;
}

.editor-toolbar {
  @apply flex items-center space-x-2 p-2 border-b border-gray-200;
}

.editor-content {
  @apply flex-1 flex;
}

.editor-main {
  @apply flex-1 p-4;
}

.editor-sidebar {
  @apply w-64 border-l border-gray-200 p-4;
}

.participants-list {
  @apply space-y-2 mb-6;
}

.participant-item {
  @apply flex items-center space-x-2 p-2 rounded-lg hover:bg-gray-100;
}

.participant-avatar {
  @apply w-8 h-8 rounded-full bg-blue-500 text-white flex items-center justify-center text-sm font-semibold;
}

.participant-name {
  @apply text-sm font-medium text-gray-800;
}

.participant-status {
  @apply w-2 h-2 rounded-full bg-green-500;
}

.participant-status.inactive {
  @apply bg-gray-400;
}

.conflicts-list {
  @apply space-y-2;
}

.conflict-item {
  @apply p-3 border border-red-200 rounded-lg bg-red-50;
}

.conflict-header {
  @apply flex items-center justify-between mb-2;
}

.conflict-title {
  @apply text-sm font-semibold text-red-800;
}

.conflict-description {
  @apply text-sm text-red-600 mb-2;
}

.conflict-actions {
  @apply flex space-x-2;
}

.conflict-button {
  @apply px-3 py-1 text-xs font-medium rounded-md;
}

.conflict-button.resolve {
  @apply bg-red-600 text-white hover:bg-red-700;
}

.conflict-button.dismiss {
  @apply bg-gray-200 text-gray-800 hover:bg-gray-300;
}

/* ダークモード対応 */
@media (prefers-color-scheme: dark) {
  .collaborative-editor {
    @apply bg-gray-900;
  }
  .editor-header {
    @apply border-gray-700;
  }
  .editor-toolbar {
    @apply border-gray-700;
  }
  .editor-sidebar {
    @apply border-gray-700;
  }
  .participant-item {
    @apply hover:bg-gray-800;
  }
  .participant-name {
    @apply text-gray-200;
  }
  .conflict-item {
    @apply border-red-800 bg-red-900;
  }
  .conflict-title {
    @apply text-red-200;
  }
  .conflict-description {
    @apply text-red-300;
  }
  .conflict-button.dismiss {
    @apply bg-gray-700 text-gray-200 hover:bg-gray-600;
  }
}
```

## 8. 日本語サンプルデータ

### 編集セッションデータ
```json
{
  "editSessions": [
    {
      "sessionId": "session_001",
      "planId": "plan_001",
      "participants": [
        {
          "userId": "usr_001",
          "name": "山田太郎",
          "profileImage": "https://example.com/avatars/usr_001.jpg",
          "cursorPosition": 150,
          "isActive": true,
          "lastSeen": "2025-01-27T10:00:00Z"
        },
        {
          "userId": "usr_002",
          "name": "佐藤花子",
          "profileImage": "https://example.com/avatars/usr_002.jpg",
          "cursorPosition": 200,
          "isActive": true,
          "lastSeen": "2025-01-27T10:00:00Z"
        }
      ],
      "status": "active",
      "createdAt": "2025-01-27T10:00:00Z"
    },
    {
      "sessionId": "session_002",
      "planId": "plan_002",
      "participants": [
        {
          "userId": "usr_003",
          "name": "田中次郎",
          "profileImage": "https://example.com/avatars/usr_003.jpg",
          "cursorPosition": 75,
          "isActive": true,
          "lastSeen": "2025-01-27T10:00:00Z"
        },
        {
          "userId": "usr_004",
          "name": "渡辺雪",
          "profileImage": "https://example.com/avatars/usr_004.jpg",
          "cursorPosition": 100,
          "isActive": false,
          "lastSeen": "2025-01-27T09:45:00Z"
        }
      ],
      "status": "active",
      "createdAt": "2025-01-27T09:30:00Z"
    }
  ]
}
```

### 編集操作データ
```json
{
  "editOperations": [
    {
      "operationId": "op_001",
      "sessionId": "session_001",
      "operation": {
        "type": "insert",
        "position": 150,
        "content": "新しいテキスト",
        "metadata": {
          "userId": "usr_001",
          "timestamp": "2025-01-27T10:00:00Z"
        }
      },
      "userId": "usr_001",
      "timestamp": "2025-01-27T10:00:00Z",
      "status": "applied"
    },
    {
      "operationId": "op_002",
      "sessionId": "session_001",
      "operation": {
        "type": "delete",
        "position": 200,
        "length": 10,
        "metadata": {
          "userId": "usr_002",
          "timestamp": "2025-01-27T10:00:30Z"
        }
      },
      "userId": "usr_002",
      "timestamp": "2025-01-27T10:00:30Z",
      "status": "applied"
    },
    {
      "operationId": "op_003",
      "sessionId": "session_001",
      "operation": {
        "type": "replace",
        "position": 180,
        "content": "置換テキスト",
        "length": 5,
        "metadata": {
          "userId": "usr_001",
          "timestamp": "2025-01-27T10:01:00Z"
        }
      },
      "userId": "usr_001",
      "timestamp": "2025-01-27T10:01:00Z",
      "status": "conflict"
    }
  ]
}
```

### 競合データ
```json
{
  "conflicts": [
    {
      "conflictId": "conflict_001",
      "sessionId": "session_001",
      "conflictingOperations": [
        {
          "operationId": "op_003",
          "operation": {
            "type": "replace",
            "position": 180,
            "content": "置換テキスト",
            "length": 5
          },
          "userId": "usr_001"
        },
        {
          "operationId": "op_004",
          "operation": {
            "type": "insert",
            "position": 180,
            "content": "挿入テキスト"
          },
          "userId": "usr_002"
        }
      ],
      "conflictType": "position",
      "severity": "medium",
      "detectedAt": "2025-01-27T10:01:00Z"
    },
    {
      "conflictId": "conflict_002",
      "sessionId": "session_002",
      "conflictingOperations": [
        {
          "operationId": "op_005",
          "operation": {
            "type": "delete",
            "position": 100,
            "length": 20
          },
          "userId": "usr_003"
        },
        {
          "operationId": "op_006",
          "operation": {
            "type": "replace",
            "position": 100,
            "content": "新しい内容",
            "length": 20
          },
          "userId": "usr_004"
        }
      ],
      "conflictType": "content",
      "severity": "high",
      "detectedAt": "2025-01-27T10:02:00Z"
    }
  ]
}
```

### 参加者状態データ
```json
{
  "participantStates": [
    {
      "userId": "usr_001",
      "sessionId": "session_001",
      "cursorPosition": 150,
      "selectionStart": 150,
      "selectionEnd": 160,
      "isTyping": true,
      "lastActivity": "2025-01-27T10:00:00Z",
      "connectionStatus": "connected"
    },
    {
      "userId": "usr_002",
      "sessionId": "session_001",
      "cursorPosition": 200,
      "selectionStart": 200,
      "selectionEnd": 200,
      "isTyping": false,
      "lastActivity": "2025-01-27T10:00:30Z",
      "connectionStatus": "connected"
    },
    {
      "userId": "usr_003",
      "sessionId": "session_002",
      "cursorPosition": 75,
      "selectionStart": 75,
      "selectionEnd": 85,
      "isTyping": true,
      "lastActivity": "2025-01-27T10:01:00Z",
      "connectionStatus": "connected"
    },
    {
      "userId": "usr_004",
      "sessionId": "session_002",
      "cursorPosition": 100,
      "selectionStart": 100,
      "selectionEnd": 100,
      "isTyping": false,
      "lastActivity": "2025-01-27T09:45:00Z",
      "connectionStatus": "disconnected"
    }
  ]
}
```

### エラーメッセージ
```json
{
  "errorMessages": {
    "sessionStart": {
      "networkError": "セッション開始に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "セッション開始がタイムアウトしました",
      "unauthorized": "セッション開始権限がありません"
    },
    "editOperation": {
      "networkError": "編集操作の送信に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "編集操作の送信がタイムアウトしました",
      "invalidOperation": "無効な編集操作です"
    },
    "conflictDetection": {
      "networkError": "競合検出に失敗しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "競合検出がタイムアウトしました",
      "detectionFailed": "競合検出に失敗しました"
    },
    "websocket": {
      "connectionFailed": "WebSocket接続に失敗しました",
      "connectionLost": "WebSocket接続が切断されました",
      "reconnectionFailed": "再接続に失敗しました",
      "messageSendFailed": "メッセージ送信に失敗しました"
    },
    "general": {
      "networkError": "ネットワークエラーが発生しました",
      "serverError": "サーバーエラーが発生しました",
      "timeout": "タイムアウトが発生しました",
      "unknown": "不明なエラーが発生しました"
    }
  }
}
```

### 成功メッセージ
```json
{
  "successMessages": {
    "sessionStarted": "セッションが開始されました",
    "sessionJoined": "セッションに参加しました",
    "operationApplied": "編集操作が適用されました",
    "conflictResolved": "競合が解決されました",
    "cursorSynced": "カーソル位置が同期されました"
  }
}
```

## 9. 最終チェックリスト

### 機能要件
- [ ] 編集セッション開始機能が正常に動作する
- [ ] リアルタイム同期機能が正常に動作する
- [ ] 編集操作送信機能が正常に動作する
- [ ] 競合検出機能が正常に動作する
- [ ] カーソル位置同期機能が正常に動作する

### 非機能要件
- [ ] レスポンシブデザインが実装されている
- [ ] アクセシビリティ（WCAG 2.1 AA）に準拠している
- [ ] パフォーマンス要件を満たしている
- [ ] セキュリティ要件が実装されている
- [ ] エラー率が許容範囲内である

### ユーザビリティ
- [ ] 直感的なUI/UXが実装されている
- [ ] 適切なフィードバックが提供されている
- [ ] 編集インターフェースが分かりやすい
- [ ] エラーメッセージが分かりやすい
- [ ] キーボード操作が可能である

### セキュリティ
- [ ] 編集データが適切に保護されている
- [ ] HTTPS通信が強制されている
- [ ] 認証・認可が適切に実装されている
- [ ] セッション管理が適切に実装されている
- [ ] データ整合性が確保されている

### 技術要件
- [ ] リアルタイム同期が適切に実装されている
- [ ] 競合解決が適切に実装されている
- [ ] WebSocket接続が適切に管理されている
- [ ] エラーハンドリングが適切に実装されている
- [ ] 状態管理が適切に実装されている

---

**作成日**: 2025年1月27日  
**バージョン**: 1.0  
**作成者**: ソフトウェアエンジニア・UX/UIデザイナー  
**承認者**: [承認者名]  
**レビュー者**: [レビュー者名]

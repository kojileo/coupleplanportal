# UC006-003: メッセージカスタマイズ画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: レコメンドの提案を基に感謝メッセージを編集・保存し、送信準備を整える
- **ビジネスゴール**: 感謝メッセージ送信率の最大化とプレミアムテンプレート提供による収益化
- **技術ゴール**: リッチテキスト編集の安定性とテンプレート管理の柔軟性確保

### 受け入れ基準
- テンプレート一覧が2秒以内に表示される
- エディタの入力遅延が100ms以内
- プレビューは編集内容と完全一致し、1クリックで表示切替
- 保存・送信操作が2秒以内に応答
- アクセシビリティ: エディタの主要操作がキーボードと支援技術で利用可能

### 機能段階性
1. **基礎**: テンプレート取得、メッセージ編集、プレビュー、保存
2. **拡張**: トーン調整AI、スタンプ挿入、音声読み上げ
3. **制約**: 文字数上限600、スタンプ3個まで、テンプレートお気に入り20件まで

## 2. 仕様の厳密化

### コア機能

#### テンプレート取得
- **取得**: GET /api/v1/messages/templates
- **フィルタ**: カテゴリ（感謝、励まし、記念日）、トーン
- **表示**: テンプレートカードとプレビュー

#### エディタ機能
- **編集**: リッチテキスト（太字、斜体、改行、絵文字）
- **整形**: 自動敬語チェック、絵文字候補
- **制限**: 600文字、絵文字は30個まで

#### メッセージ保存
- **送信**: POST /api/v1/messages
- **入力**: content、recipientId、recId（任意）
- **応答**: messageId、提案された送信タイミング

#### プレビュー表示
- **切替**: エディタとプレビューをタブで切替
- **レンダリング**: 実際の送信先と同一スタイル

### 入力制約 & バリデーション

#### content
- **形式**: リッチテキスト（HTMLサニタイズ後）
- **制限**: 600文字以内、禁止タグ（script等）
- **エラーメッセージ**: "600文字以内で入力してください"

#### recipientId
- **形式**: UUID v4
- **必須**: 必須
- **エラーメッセージ**: "送信先が選択されていません"

#### templateId
- **形式**: UUID v4
- **必須**: 任意（テンプレート未使用時 null）
- **エラーメッセージ**: "テンプレートIDが不正です"

### データモデル & API

#### リクエスト / レスポンスモデル
~~~typescript
interface MessageTemplate {
  templateId: string;
  category: 'gratitude' | 'cheer' | 'anniversary' | 'custom';
  tone: 'warm' | 'playful' | 'formal';
  preview: string;
  recommendedLength: number;
  premium: boolean;
}

interface TemplateListResponse {
  templates: MessageTemplate[];
  featuredTemplateId?: string;
}

interface MessageSavePayload {
  recipientId: string;
  content: string;
  templateId?: string;
  recId?: string;
  sendLaterAt?: string;
}

interface MessageSaveResponse {
  messageId: string;
  status: 'draft' | 'scheduled' | 'sent';
  nextAction: 'schedule_send' | 'send_now';
  previewUrl?: string;
}
~~~

#### API エンドポイント
- テンプレート取得: GET /api/v1/messages/templates
- メッセージ保存: POST /api/v1/messages

### UX / A11y

#### エディタ
- ツールバーはボタンにaria-label付与、ショートカット表示
- リアルタイム文字数カウンタ、しきい値を色で示す
- 読み上げモードでプレーンテキストを提供

#### テンプレート一覧
- カテゴリタブと検索ボックス
- プレミアムテンプレートはロックアイコンと説明文を表示
- キーボード上下でカード移動、Enterで適用

#### プレビュー
- 送信者名、受信者名、送信予定時刻を明確化
- フォントサイズ調整オプション、ハイコントラストモード

### セキュリティ & プライバシー
- **データ保護**: 保存メッセージをAES-256暗号化
- **サニタイズ**: HTMLサニタイズでXSS防止
- **アクセス制御**: 自分のカップルIDに紐づく受信者のみ保存可
- **ログ**: 変更履歴は監査用途に匿名化して保持

### 非機能要件
- **レスポンス**: テンプレート取得2秒以内、保存2秒以内
- **可用性**: 99.9%
- **耐障害性**: 保存失敗時にローカルドラフトとして保持
- **可観測性**: 保存成功率、プレミアム利用率、平均文字数トラッキング

## 3. 曖昧さと解決

### テンプレート適用
- 適用時は差分ハイライトを表示しユーザー確認
- 適用後も元の内容に戻せるUndoを提供

### プレミアム制御
- premium=trueはサブスクプランで解放、未加入はプレビューのみ
- 課金誘導モーダルでプラン比較を提示

### 送信スケジュール
- sendLaterAt未設定時は下流フローで時刻選択を促す
- 過去日時はバリデーションエラー

## 4. 受け入れ基準例（Gherkin風）

### テンプレート適用
~~~gherkin
Given ユーザーがテンプレートを選択する
When 適用ボタンを押す
Then エディタにテンプレート内容が挿入される
And 既存テキストは置き換え前に一時保存される
~~~

### メッセージ保存
~~~gherkin
Given ユーザーがメッセージを編集した
When 保存ボタンを押す
Then 2秒以内に保存成功トーストが表示される
And messageIdがレスポンスとして返る
~~~

## 5. リスクとトレードオフ

### 技術リスク
- リッチテキスト処理の互換性 → Slate.jsやTipTap等の安定ライブラリ採用
- サニタイズ不足 → DOMPurifyで厳格な許可リスト
- 同時編集 → ローカルドラフトと変更検知

### UXリスク
- 編集負荷 → テンプレートとAIヒントで補助
- 誤送信 → 下流で再確認モーダル
- プレミアム誘導のストレス → フリーユーザーへ代替テンプレート提供

### プライバシーリスク
- メッセージ内容の漏洩 → 暗号化とアクセス監査
- サードパーティ絵文字 → ローカルホストとライセンス確認

## 6. 拡張余地

### 短期拡張
- トーン微調整スライダー
- 自動敬語チェッカー
- 送信前の音声読み上げ

### 中期拡張
- 双方コメント機能
- 添付画像スタンプ
- マルチメッセージテンプレート管理

### 長期拡張
- AIチャットコパイロット
- 翻訳・多言語テンプレート
- 動画メッセージ生成

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **エディタ**: TipTap + 自前プラグイン
- **状態管理**: Zustand（エディタ状態） + React Query（テンプレート）

### コンポーネント設計
~~~typescript
interface MessageCustomizePageProps {
  memoryId: string;
  recipientId: string;
  defaultTemplateId?: string;
}

interface TemplatePickerProps {
  templates: MessageTemplate[];
  onSelect: (templateId: string) => void;
  selectedId?: string;
}

interface MessageEditorProps {
  content: string;
  onChange: (content: string) => void;
  characterLimit: number;
}
~~~

### スタイリング
~~~css
.message-customize-page {
  @apply max-w-3xl mx-auto space-y-8 px-4 py-10;
}

.template-grid {
  @apply grid grid-cols-1 md:grid-cols-2 gap-4;
}

.editor-surface {
  @apply bg-white rounded-2xl shadow-sm border border-slate-200 p-6 min-h-[18rem];
}

.preview-surface {
  @apply bg-slate-900 text-white rounded-2xl shadow-lg p-6 space-y-4;
}
~~~

### テレメトリ
- テンプレート選択率、保存成功率、平均編集時間、プレミアム利用率を収集
- エラーログはカテゴリー別に分類し改善計画へ反映


# UC004-003: 仲裁提案画面 実装指示書

## 1. 全体評価

### 目的とゴール
- **主要目的**: AIが生成した仲裁提案を比較検討し、最適な解決策を選択・フィードバックできるようにする
- **ビジネスゴール**: 仲裁成功率とユーザー満足度の最大化、提案品質向上のための学習データ蓄積
- **技術ゴール**: 提案取得・選択・フィードバック処理を堅牢に実装し、レコメンドロジックに還元

### 受け入れ基準
- 提案一覧が5秒以内に表示される
- 推奨優先度順に最大5件の提案を表示
- 提案選択後は即座に確認モーダルが表示され、完了通知を返す
- フィードバック送信は2秒以内に応答し、重複送信を防止
- アクセシビリティ: 各提案カードはキーボード・スクリーンリーダーで操作可能

### 機能段階性
1. **基礎**: 提案取得表示、提案詳細、選択、フィードバック
2. **拡張**: 並び替え、比較モード、推奨度の根拠表示
3. **制約**: 選択できる提案は1件のみ、フィードバックは1セッション最大3回

## 2. 仕様の厳密化

### コア機能

#### 提案取得
- **取得**: mediationIdをキーに提案リストを取得
- **表示**: 優先度タグ、概要、所要時間、期待効果をカード表示
- **失敗**: 再試行導線とサポートメッセージを表示

#### 提案詳細表示
- **展開**: 各提案の詳細項目（対立ポイント、推奨アクション、必要リソースなど）をアコーディオンで表示
- **比較**: 選択中提案を固定し比較枠で差分を表示

#### 提案選択
- **操作**: カードの主ボタンから選択
- **確認**: モーダルで概要と仮スケジュールを提示
- **送信**: POST /api/v1/mediation/{mediationId}/select
- **完了**: 状況追跡へ進むボタンを活性化し、仲裁セッションIDを返却

#### 提案フィードバック
- **入力**: 満足度スコア、自由記述、改善ポイントのチェックボックス
- **送信**: POST /api/v1/mediation/{mediationId}/feedback
- **制御**: 送信後は編集不可、成功時に感謝メッセージ

### 入力制約 & バリデーション

#### mediationId
- **形式**: UUID v4
- **必須**: 必須
- **エラーメッセージ**: "仲裁IDを確認してください"

#### proposalId
- **形式**: UUID v4
- **必須**: 選択処理で必須
- **エラーメッセージ**: "提案を選択してください"

#### satisfactionScore
- **形式**: 整数1〜5
- **必須**: フィードバック時に必須
- **エラーメッセージ**: "1〜5で評価してください"

#### comments
- **形式**: 0〜500文字
- **必須**: 任意
- **エラーメッセージ**: "500文字以内で入力してください"

### データモデル & API

#### リクエストモデル
~~~typescript
interface ProposalSelectRequest {
  mediationId: string;
  proposalId: string;
}

interface ProposalFeedbackRequest {
  mediationId: string;
  proposalId: string;
  satisfactionScore: 1 | 2 | 3 | 4 | 5;
  helpfulElements?: string[];
  improvementAreas?: string[];
  comments?: string;
}
~~~

#### レスポンスモデル
~~~typescript
interface MediationProposal {
  proposalId: string;
  title: string;
  summary: string;
  priority: number;
  impactLevel: 'low' | 'medium' | 'high';
  estimatedDurationMinutes: number;
  successProbability: number;
  focusAreas: string[];
  requiredCommitments: string[];
}

interface ProposalListResponse {
  mediationId: string;
  proposals: MediationProposal[];
  generatedAt: string;
}

interface ProposalSelectResponse {
  mediationId: string;
  proposalId: string;
  sessionId: string;
  status: 'scheduled' | 'active';
}

interface ProposalFeedbackResponse {
  mediationId: string;
  proposalId: string;
  thankYouMessage: string;
  acceptedAt: string;
}
~~~

#### API エンドポイント
- **仲裁提案取得**: GET /api/v1/mediation/{mediationId}/proposals
- **提案選択**: POST /api/v1/mediation/{mediationId}/select
- **提案フィードバック**: POST /api/v1/mediation/{mediationId}/feedback

### UX / A11y

#### インタラクション
- カードはボタン要素を内包し、role="button"を明示
- 比較モードはチェックボックスで切り替え、差分テーブルを表示
- 選択済みカードには視覚（色・アイコン）と音声フィードバックを提供

#### キーボード操作
- 上下矢印でカード間移動、Enterで詳細展開、Spaceで選択
- モーダル内はTabサイクルとEscによる閉鎖を保証

#### スクリーンリーダー
- 提案カードにaria-labelledbyとaria-describedbyを付与
- 選択状態の変更はaria-live="polite"で通知
- フィードバックフォームのエラーをrole="alert"で告知

### セキュリティ & プライバシー
- **アクセス制御**: 関係者のみ閲覧できるRBAC
- **整合性**: 提案選択時にCSRFトークンを付与
- **ロギング**: 選択ログはPIIをマスクして保存
- **監査**: フィードバックは追跡IDとともに監査テーブルへ記録

### 非機能要件
- **パフォーマンス**: 提案取得5秒以内、選択/フィードバック2秒以内
- **信頼性**: 重複選択防止のためIdempotency-Keyを利用
- **可用性**: 99.9%稼働、失敗時はフォールバック提案を提示
- **分析**: 選択率・満足度をメトリクス送信

## 3. 曖昧さと解決

### 提案数
- 初期表示は推奨度上位3件、詳細表示で最大5件展開
- 5件を超える場合はロードモアボタンで追加

### 優先度指標
- priorityは1が最優先、impactLevelと併記
- successProbabilityは0〜1で表示し、百分率に変換

### フィードバックカテゴリ
- helpfulElements: communication, empathy, actionPlan などプリセット
- improvementAreas: clarity, feasibility, tone などプリセット + その他

## 4. 受け入れ基準例（Gherkin風）

### 提案選択
~~~gherkin
Given ユーザーが仲裁提案画面を開く
When 提案一覧が取得される
Then 優先度順に提案カードが表示される
And 最低3件の提案が表示される

Given ユーザーが提案を選択する
When 確認モーダルで選択を確定する
Then 提案選択APIが呼び出され成功レスポンスが返る
And 完了トーストと次のアクション案内が表示される
~~~

### フィードバック送信
~~~gherkin
Given 提案選択を完了したユーザー
When フィードバックフォームに評価を入力して送信する
Then 2秒以内に完了メッセージが表示される
And 同じ提案に対する追加送信はブロックされる
~~~

## 5. リスクとトレードオフ

### 技術リスク
- 提案取得遅延 → ローディングプレースホルダーとタイムアウト処理
- 選択API競合 → Idempotency-Keyと重複検知で防止
- フィードバックスパム → レートリミットとreCAPTCHA相当の実装

### UXリスク
- 情報量過多 → 折りたたみと比較機能で整理
- 選択プレッシャー → 相談導線と延期オプション追加
- フィードバック離脱 → プログレッシブフォームとプリセット選択で軽減

### プライバシーリスク
- 機密提案の共有 → 表示対象をカップル内に限定
- フィードバック漏洩 → 暗号化保存とアクセス監査

## 6. 拡張余地

### 短期拡張
- 提案の根拠データ表示
- パートナー別の推奨アクション比較
- フィードバックのサマリー表示

### 中期拡張
- AIチャットによるリアルタイム質疑応答
- 提案実施スケジューリング連携
- 過去提案との比較履歴

### 長期拡張
- 専門家レビューの併載
- 自動フォローアップ提案生成
- 他言語対応と文化適応ロジック

## 7. 実装ガイドライン

### 技術スタック
- **フロントエンド**: React 18 + TypeScript + Tailwind CSS
- **状態管理**: Zustand + React Query（提案キャッシュ）
- **アニメーション**: Framer Motionでカード表示・モーダル遷移
- **HTTPクライアント**: Axios（Idempotency-Key付与）

### コンポーネント設計
~~~typescript
interface ProposalListProps {
  mediationId: string;
  onSelect: (proposalId: string) => void;
  onFeedbackSubmitted: (proposalId: string) => void;
}

interface ProposalCardProps {
  proposal: MediationProposal;
  selected: boolean;
  onSelect: (proposalId: string) => void;
  onExpand: (proposalId: string) => void;
}

interface ProposalFeedbackFormProps {
  mediationId: string;
  proposalId: string;
  onSubmitted: () => void;
}
~~~

### スタイリング
~~~css
.proposal-page {
  @apply max-w-5xl mx-auto space-y-8 px-4 py-8;
}

.proposal-grid {
  @apply grid grid-cols-1 lg:grid-cols-2 gap-6;
}

.proposal-card {
  @apply relative bg-white rounded-2xl shadow-sm border border-slate-200 transition-all;
}

.proposal-card[data-selected="true"] {
  @apply border-indigo-500 shadow-lg;
}

.feedback-panel {
  @apply bg-white rounded-xl shadow-md border border-slate-100 p-6 space-y-4;
}
~~~

### テレメトリ
- 提案閲覧時間、選択率、フィードバック送信率をトラッキング
- 提案拒否理由を分類しモデル改善に活用


# CouplePlan ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹ ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒƒãƒ—

## æ¦‚è¦

CouplePlanãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ã®8ã¤ã®ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é–¢ä¿‚æ€§ã‚’ã€ãƒ‰ãƒ¡ã‚¤ãƒ³é§†å‹•è¨­è¨ˆï¼ˆDDDï¼‰ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒƒãƒ—ã¨ã—ã¦å›³å¼åŒ–ã—ã¦ã„ã¾ã™ã€‚å„ã‚µãƒ¼ãƒ“ã‚¹ã¯æ˜ç¢ºãªè²¬å‹™ã‚’æŒã¡ã€é©åˆ‡ãªçµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³ã§é€£æºã—ã¦ã„ã¾ã™ã€‚

## ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒãƒƒãƒ—å›³

```mermaid
graph TB
    %% å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ 
    subgraph "External Systems"
        EXT_AUTH[External Auth<br/>Supabase Auth]
        EXT_AI[AI Services<br/>OpenAI API]
        EXT_PAY[Payment<br/>Stripe API]
        EXT_MAP[Location<br/>MapBox API]
        EXT_REST[Restaurants<br/>External APIs]
    end

    %% ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹å±¤
    subgraph "User Interface Layer"
        WEB_PORTAL[Web Portal<br/>Next.js]
        MOBILE_APP[Mobile App<br/>PWA]
        ADMIN_PANEL[Admin Panel<br/>Management UI]
    end

    %% ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹å±¤
    subgraph "Microservices Layer"
        %% ã‚³ã‚¢ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
        subgraph "Core Domain Services"
            MS001[MS-001: User Management Service<br/>ğŸ” Authentication & Authorization<br/>ğŸ‘¥ User & Couple Management]
            MS002[MS-002: Date Planning Service<br/>ğŸ¤– AI Plan Generation<br/>ğŸ“‹ Template Management]
            MS003[MS-003: Collaboration Service<br/>ğŸ‘¥ Real-time Collaboration<br/>âš¡ Conflict Resolution]
            MS004[MS-004: Relationship Management Service<br/>ğŸ’• Relationship Analysis<br/>ğŸ¤ Conflict Mediation]
        end

        %% æ”¯æ´ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚µãƒ¼ãƒ“ã‚¹
        subgraph "Supporting Domain Services"
            MS007[MS-007: Platform Integration Service<br/>ğŸ”— Portal Integration<br/>ğŸŒ External Service Integration]
            MS008[MS-008: Monetization Service<br/>ğŸ’° Subscription Management<br/>ğŸš© Feature Flag Control]
        end
    end

    %% ãƒ‡ãƒ¼ã‚¿å±¤
    subgraph "Data Layer"
        DB_AUTH[(Auth Database<br/>Supabase Auth)]
        DB_CORE[(Core Database<br/>PostgreSQL)]
        DB_CACHE[(Cache Layer<br/>Redis)]
        DB_STORAGE[(File Storage<br/>Supabase Storage)]
        DB_ANALYTICS[(Analytics DB<br/>PostgreSQL)]
    end

    %% ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£å±¤
    subgraph "Infrastructure Layer"
        API_GATEWAY[API Gateway<br/>Vercel Edge]
        EVENT_BUS[Event Bus<br/>Supabase Realtime]
        CDN[CDN<br/>Vercel Edge Network]
        MONITORING[Monitoring<br/>Vercel Analytics]
    end

    %% ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¤ãƒ³ã‚¿ãƒ¼ãƒ•ã‚§ãƒ¼ã‚¹ â†’ ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹
    WEB_PORTAL --> MS007
    WEB_PORTAL --> MS001
    MOBILE_APP --> MS001
    MOBILE_APP --> MS002
    MOBILE_APP --> MS003
    MOBILE_APP --> MS004
    MOBILE_APP --> MS005
    ADMIN_PANEL --> MS008

    %% ãƒã‚¤ã‚¯ãƒ­ã‚µãƒ¼ãƒ“ã‚¹é–“ã®é–¢ä¿‚æ€§
    %% Published Language (PL) - ã‚¤ãƒ™ãƒ³ãƒˆé…ä¿¡
    MS001 -.->|UserRegistered<br/>CoupleFormed| MS002
    MS001 -.->|UserRegistered<br/>CoupleFormed| MS003
    MS001 -.->|UserRegistered<br/>CoupleFormed| MS004
    MS001 -.->|UserRegistered<br/>CoupleFormed| MS005
    MS001 -.->|UserRegistered<br/>CoupleFormed| MS008

    MS002 -.->|DatePlanCreated| MS003
    MS003 -.->|CollaborationCompleted| MS004
    MS004 -.->|DateCompleted| MS005

    %% Customer-Supplier (CS) - ç›´æ¥å‘¼ã³å‡ºã—
    MS003 -->|Plan Request| MS002
    MS004 -->|Session Info| MS003
    MS005 -->|Relationship Data| MS001

    %% Open Host Service (OHS) - çµ±åˆAPI
    MS007 -->|Integration API| MS001
    MS007 -->|Integration API| MS002
    MS007 -->|Integration API| MS003
    MS007 -->|Integration API| MS004
    MS007 -->|Integration API| MS005

    %% Published Language (PL) - æ©Ÿèƒ½åˆ¶å¾¡
    MS008 -.->|FeatureUnlocked<br/>SubscriptionActivated| MS001
    MS008 -.->|FeatureUnlocked<br/>SubscriptionActivated| MS002
    MS008 -.->|FeatureUnlocked<br/>SubscriptionActivated| MS003
    MS008 -.->|FeatureUnlocked<br/>SubscriptionActivated| MS004
    MS008 -.->|FeatureUnlocked<br/>SubscriptionActivated| MS005

    %% å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ çµ±åˆ
    MS001 <--> EXT_AUTH
    MS002 <--> EXT_AI
    MS004 <--> EXT_MAP
    MS007 <--> EXT_REST
    MS008 <--> EXT_PAY

    %% ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹
    MS001 --> DB_AUTH
    MS001 --> DB_CORE
    MS002 --> DB_CORE
    MS002 --> DB_CACHE
    MS003 --> DB_CACHE
    MS003 --> DB_CORE
    MS004 --> DB_CORE
    MS004 --> DB_STORAGE
    MS005 --> DB_CORE
    MS005 --> DB_ANALYTICS
    MS007 --> DB_CORE
    MS008 --> DB_CORE
    MS008 --> DB_CACHE

    %% ã‚¤ãƒ³ãƒ•ãƒ©ã‚¹ãƒˆãƒ©ã‚¯ãƒãƒ£çµ±åˆ
    API_GATEWAY --> MS001
    API_GATEWAY --> MS002
    API_GATEWAY --> MS003
    API_GATEWAY --> MS004
    API_GATEWAY --> MS005
    API_GATEWAY --> MS007
    API_GATEWAY --> MS008

    EVENT_BUS -.-> MS001
    EVENT_BUS -.-> MS002
    EVENT_BUS -.-> MS003
    EVENT_BUS -.-> MS004
    EVENT_BUS -.-> MS005
    EVENT_BUS -.-> MS007
    EVENT_BUS -.-> MS008

    %% ã‚¹ã‚¿ã‚¤ãƒªãƒ³ã‚°
    classDef coreDomain fill:#e1f5fe,stroke:#01579b,stroke-width:2px
    classDef supportingDomain fill:#f3e5f5,stroke:#4a148c,stroke-width:2px
    classDef externalSystem fill:#fff3e0,stroke:#e65100,stroke-width:2px
    classDef dataLayer fill:#e8f5e8,stroke:#1b5e20,stroke-width:2px
    classDef infrastructure fill:#fce4ec,stroke:#880e4f,stroke-width:2px
    classDef uiLayer fill:#f1f8e9,stroke:#33691e,stroke-width:2px

    class MS001,MS002,MS003,MS004,MS005 coreDomain
    class MS007,MS008 supportingDomain
    class EXT_AUTH,EXT_AI,EXT_PAY,EXT_MAP,EXT_REST externalSystem
    class DB_AUTH,DB_CORE,DB_CACHE,DB_STORAGE,DB_ANALYTICS dataLayer
    class API_GATEWAY,EVENT_BUS,CDN,MONITORING infrastructure
    class WEB_PORTAL,MOBILE_APP,ADMIN_PANEL uiLayer
```

## çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³è©³ç´°

### 1. Published Language (PL) - ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•çµ±åˆ
**èª¬æ˜**: éåŒæœŸã‚¤ãƒ™ãƒ³ãƒˆã«ã‚ˆã‚‹ç–çµåˆãªçµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³

| ã‚¤ãƒ™ãƒ³ãƒˆç™ºè¡Œè€… | ã‚¤ãƒ™ãƒ³ãƒˆå | ã‚¤ãƒ™ãƒ³ãƒˆè³¼èª­è€… | ç”¨é€” |
|---|---|---|---|
| MS-001 | UserRegistered, CoupleFormed | MS-002, MS-003, MS-004, MS-008 | ãƒ¦ãƒ¼ã‚¶ãƒ¼çŠ¶æ…‹åŒæœŸ |
| MS-002 | DatePlanCreated | MS-003 | ãƒ—ãƒ©ãƒ³ç·¨é›†é–‹å§‹ |
| MS-003 | CollaborationCompleted | MS-004 | ãƒ‡ãƒ¼ãƒˆå®Ÿè¡Œæº–å‚™ |
| MS-004 | DateCompleted | MS-004 | é–¢ä¿‚æ€§åˆ†æ |
| MS-008 | FeatureUnlocked, SubscriptionActivated | å…¨ã‚µãƒ¼ãƒ“ã‚¹ | æ©Ÿèƒ½åˆ¶å¾¡ |

### 2. Customer-Supplier (CS) - ç›´æ¥APIå‘¼ã³å‡ºã—
**èª¬æ˜**: ä¸Šæµã‚µãƒ¼ãƒ“ã‚¹ãŒä¸‹æµã‚µãƒ¼ãƒ“ã‚¹ã®APIã‚’ç›´æ¥å‘¼ã³å‡ºã™çµ±åˆãƒ‘ã‚¿ãƒ¼ãƒ³

| é¡§å®¢ã‚µãƒ¼ãƒ“ã‚¹ | ä¾›çµ¦è€…ã‚µãƒ¼ãƒ“ã‚¹ | å‘¼ã³å‡ºã—å†…å®¹ | é€šä¿¡æ–¹å¼ |
|---|---|---|---|
| MS-003 | MS-002 | ãƒ—ãƒ©ãƒ³æƒ…å ±å–å¾— | REST API |
| MS-004 | MS-003 | ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±å–å¾— | REST API |
| MS-004 | MS-001 | é–¢ä¿‚æ€§ãƒ‡ãƒ¼ã‚¿å–å¾— | REST API |
| MS-006 | MS-004 | ãƒ¡ãƒ¢ãƒªæƒ…å ±å–å¾— | REST API |

### 3. Open Host Service (OHS) - çµ±åˆAPIæä¾›
**èª¬æ˜**: MS-007ãŒå…¨ã‚µãƒ¼ãƒ“ã‚¹ã®çµ±åˆAPIã‚’æä¾›ã™ã‚‹ãƒ‘ã‚¿ãƒ¼ãƒ³

| çµ±åˆæ©Ÿèƒ½ | å¯¾è±¡ã‚µãƒ¼ãƒ“ã‚¹ | æä¾›API |
|---|---|---|
| ãƒãƒ¼ã‚¿ãƒ«çµ±åˆ | MS-001, MS-002, MS-003, MS-004 | çµ±åˆã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æº | å…¨ã‚µãƒ¼ãƒ“ã‚¹ | å¤–éƒ¨API ãƒ—ãƒ­ã‚­ã‚· |
| ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡ | å…¨ã‚µãƒ¼ãƒ“ã‚¹ | ã‚³ãƒ³ãƒ†ãƒ³ãƒ„é…ä¿¡API |

## ãƒ‡ãƒ¼ã‚¿ãƒ•ãƒ­ãƒ¼

### ä¸»è¦ãªãƒ“ã‚¸ãƒã‚¹ãƒ•ãƒ­ãƒ¼

```mermaid
sequenceDiagram
    participant U as User
    participant UI as Web/Mobile UI
    participant MS001 as User Management
    participant MS002 as Date Planning
    participant MS003 as Collaboration
    participant MS004 as Date Execution
    participant MS005 as Relationship Management

    %% ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ãƒ»èªè¨¼ãƒ•ãƒ­ãƒ¼
    U->>UI: ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²
    UI->>MS001: Register User
    MS001->>MS001: Create User Account
    MS001-->>MS002: UserRegistered Event
    MS001-->>MS003: UserRegistered Event
    MS001-->>MS004: UserRegistered Event
    MS001-->>MS005: UserRegistered Event

    %% ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ä½œæˆãƒ•ãƒ­ãƒ¼
    U->>UI: ãƒ‡ãƒ¼ãƒˆãƒ—ãƒ©ãƒ³ä½œæˆè¦æ±‚
    UI->>MS002: Generate Date Plan
    MS002->>MS002: AI Plan Generation
    MS002-->>MS003: DatePlanCreated Event
    MS002->>UI: ãƒ—ãƒ©ãƒ³ææ¡ˆ

    %% å”åƒç·¨é›†ãƒ•ãƒ­ãƒ¼
    U->>UI: ãƒ—ãƒ©ãƒ³ç·¨é›†é–‹å§‹
    UI->>MS003: Start Collaboration
    MS003->>MS002: Get Plan Details
    MS002->>MS003: Plan Information
    MS003->>MS003: Real-time Collaboration
    MS003-->>MS004: CollaborationCompleted Event

    %% ãƒ‡ãƒ¼ãƒˆå®Ÿè¡Œãƒ•ãƒ­ãƒ¼
    U->>UI: ãƒ‡ãƒ¼ãƒˆé–‹å§‹
    UI->>MS004: Start Date
    MS004->>MS004: Date Tracking
    MS004->>MS004: Canvas Management
    MS004-->>MS005: DateCompleted Event

    %% é–¢ä¿‚æ€§åˆ†æãƒ»æ€ã„å‡ºæŠ½å‡ºãƒ•ãƒ­ãƒ¼
    MS005->>MS005: Relationship Analysis
```

## æŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯

### å…±é€šæŠ€è¡“ã‚¹ã‚¿ãƒƒã‚¯
- **ãƒ©ãƒ³ã‚¿ã‚¤ãƒ **: Node.js (TypeScript)
- **ãƒ‡ãƒ—ãƒ­ã‚¤**: Vercel Serverless Functions
- **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹**: Supabase (PostgreSQL)
- **ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: Redis (Supabase)
- **ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸**: Supabase Storage
- **èªè¨¼**: Supabase Auth
- **ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ **: Supabase Realtime
- **ç›£è¦–**: Vercel Analytics

### ã‚µãƒ¼ãƒ“ã‚¹å›ºæœ‰æŠ€è¡“
- **MS-002**: Python, OpenAI API (AIå‡¦ç†)
- **MS-004**: Python, scikit-learn (æ©Ÿæ¢°å­¦ç¿’)
- **MS-008**: Stripe API (æ±ºæ¸ˆå‡¦ç†)

## ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£è€ƒæ…®äº‹é …

### èªè¨¼ãƒ»èªå¯
- **èªè¨¼**: Supabase Auth (JWT)
- **èªå¯**: RBAC (Role-Based Access Control)
- **APIä¿è­·**: API Gateway + JWTæ¤œè¨¼

### ãƒ‡ãƒ¼ã‚¿ä¿è­·
- **æš—å·åŒ–**: AES-256 (ä¿å­˜æ™‚), TLS 1.3 (é€šä¿¡æ™‚)
- **ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼**: PIIåŒ¿ååŒ–ã€GDPR/APPIæº–æ‹ 
- **ç›£æŸ»**: å…¨APIå‘¼ã³å‡ºã—ãƒ­ã‚°

### ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å¢ƒç•Œ
- **å¤–éƒ¨API**: API Keyç®¡ç†ã€ãƒ¬ãƒ¼ãƒˆåˆ¶é™
- **å†…éƒ¨é€šä¿¡**: ã‚µãƒ¼ãƒ“ã‚¹é–“èªè¨¼ã€ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯åˆ†é›¢
- **ãƒ‡ãƒ¼ã‚¿ã‚¢ã‚¯ã‚»ã‚¹**: æœ€å°æ¨©é™ã®åŸå‰‡

## é‹ç”¨ãƒ»ç›£è¦–

### å¯ç”¨æ€§ç›®æ¨™
- **SLO**: 99.9% (ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹), 99.5% (æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹)
- **RTO**: 1æ™‚é–“ä»¥å†… (ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹), 4æ™‚é–“ä»¥å†… (æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹)
- **RPO**: 15åˆ†ä»¥å†… (ã‚³ã‚¢ã‚µãƒ¼ãƒ“ã‚¹), 1æ™‚é–“ä»¥å†… (æ”¯æ´ã‚µãƒ¼ãƒ“ã‚¹)

### ç›£è¦–æŒ‡æ¨™
- **å¯ç”¨æ€§**: ã‚µãƒ¼ãƒ“ã‚¹ç¨¼åƒç‡ã€ã‚¨ãƒ©ãƒ¼ç‡
- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹**: ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ™‚é–“ã€ã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆ
- **ãƒ“ã‚¸ãƒã‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç‡ã€åç›ŠæŒ‡æ¨™

### éšœå®³å¯¾å¿œ
- **è‡ªå‹•å¾©æ—§**: Circuit Breakerã€ãƒªãƒˆãƒ©ã‚¤æ©Ÿæ§‹
- **æ‰‹å‹•å¯¾å¿œ**: Runbookã€ã‚¨ã‚¹ã‚«ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ‰‹é †
- **ç½å®³å¾©æ—§**: ãƒãƒ«ãƒãƒªãƒ¼ã‚¸ãƒ§ãƒ³ã€ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—æˆ¦ç•¥

---

**ä½œæˆæ—¥**: 2025å¹´1æœˆ27æ—¥  
**ãƒãƒ¼ã‚¸ãƒ§ãƒ³**: 1.0  
**ä½œæˆè€…**: ã‚½ãƒ•ãƒˆã‚¦ã‚§ã‚¢ã‚¢ãƒ¼ã‚­ãƒ†ã‚¯ãƒˆ  
**æ‰¿èªè€…**: [æ‰¿èªè€…å]  
**ãƒ¬ãƒ“ãƒ¥ãƒ¼è€…**: [ãƒ¬ãƒ“ãƒ¥ãƒ¼è€…å]

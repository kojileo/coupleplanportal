# CouplePlan マイクロサービスアプリケーション定義書

## 1. ドキュメント概要
- **目的**: ビジネス要件、ドメインコンテキスト、データ構造、UX/画面設計、API構成、非機能要件を横断的に統合し、CouplePlanプラットフォームのマイクロサービスアーキテクチャを一つの資料として定義する。
- **適用範囲**: Webポータル、モバイルPWA、管理UIを含む全チャネル、およびMS-001〜MS-008のバックエンドサービス。



- **参照資料**: Docs/ビジネス要件定義書.md、Docs/コンテキストマップ.md、Docs/データモデル図.md、Docs/画面-API-データマッピング.md、Docs/画面一覧・遷移図.md。

## 2. ビジネスビジョンと戦略ゴール
### 2.1 ターゲットと市場洞察
- 日本国内の「男女カップル」向けデジタルサービス市場を主眼とし、デート前・中・後の体験をフルカバーする統合プラットフォームを目指す。
- 競合優位は「特別な二人空間」と利便性の両立、ポータル＋アプリのハイブリッド導線でトラフィックと継続利用を獲得する。

### 2.2 価値提案
- デートライフサイクル支援: AIプラン生成、共同編集、当日進行、思い出化まで一気通貫で支援。
- 関係性強化: AI仲裁と関係修復プランで継続的な絆を醸成。
- 段階的マネタイズ: 価値検証期は無料＋提携収益、成長期に軽課金、成熟期に高度サブスクと提携送客を実装。

### 2.3 主要課題と対応戦略
| 課題 | 戦略アプローチ |
|------|----------------|
| ユーザー獲得と継続率 | ポータルで情報提供→アプリで日常協働ツール、個人でも価値を感じる導線を整備 |
| 差別化不足 | AI仲裁など感情体験に踏み込む機能で差別化 |
| 収益化難易度 | マネタイズ段階制御（UC-007）でUXを損なわずに収益実験 |
| カップル解消時の離脱 | 個人利用でも価値ある機能と復縁/新パートナー onboarding を設計 |

### 2.4 ロードマップとマイルストーン
- 短期 (0-12ヶ月): MVP開発、AIプラン生成＋共同編集、ポータル連携、ユーザーテスト。主要KPI: MAUペア、継続率(1/3/6ヶ月)。
- 中期 (1-3年): 仲裁機能拡充、パートナー提携、国内トップクラス追随。主要KPI: 共同編集率、仲裁成功率。
- 長期 (3年以上): 収益モデル確立、段階的マネタイズ、シリーズB以降の資金調達。主要KPI: ARPU、LTV/CAC、収益性指標。

### 2.5 KPIとモニタリング
- 成長系: 月間アクティブカップル数、ポータル→アプリ転換率、新規登録数。
- エンゲージメント: デートプラン生成数、共同編集完了率、位置情報ピン利用時間。
- 関係性改善: 仲裁依頼→提案採択率、関係性スコア改善幅、仲裁後継続率。
- 収益系: 有料プラン加入率、ARPU、機能解放率、Stripe決済成功率。
- 運用体制: 月次経営レビュー＋OKR展開、Vercel/Supabaseダッシュボードでリアルタイム監視、異常時はエスカレーションルールを適用。

## 3. ステークホルダーと利用者像
| ステークホルダー | 期待価値 |
|-------------------|----------|
| カップルユーザー | デート計画〜思い出化までのシームレス体験、関係性の質向上 |
| 個人ユーザー | パートナー未連携でも利用可能なプラン提案・ポータル価値 |
| 運営チーム | KPIモニタリング、機能段階制御、カスタマーサポート効率化 |
| 外部パートナー | 提携送客・広告枠・有料テンプレート等による収益連携 |
| 経営/投資家 | 成長KPIと収益KPIのトラッキング、ガバナンスとコンプライアンス確保 |

## 4. ユースケーススコープ
- UC-001: AIデートプラン提案・生成 — 要件入力、AI生成、提案提示、詳細確認、カスタマイズ。
- UC-002: カップル共同デートプラン編集 — リアルタイム共同編集、競合解消、履歴管理、プレビュー。
- UC-003: ポータル起点統合プラットフォーム — デート情報提供、検索、記事閲覧、アプリ誘導。
- UC-004: AI喧嘩仲裁・関係修復 — 仲裁依頼、状況分析、提案提示、修復プラン、進捗追跡。
- UC-007: 段階的マネタイズ制御 — サブスク/課金管理、機能解放、履歴確認、通知。
- COMMON-001: ダッシュボード — 全機能へのエントリーポイント、KPI表示、通知、クイックアクション。

## 5. マイクロサービスアーキテクチャ
### 5.1 サービス責務一覧
| サービス | 主な責務 |
|-----------|-----------|
| MS-001: User Management | 認証・認可、ユーザー/カップル管理、プロフィール、セッション、招待管理 |
| MS-002: Date Planning | AIプラン生成、テンプレート、プラン推薦、フィードバック管理 |
| MS-003: Collaboration | プラン共同編集、編集操作/競合管理、コラボレーション状態保持 |
| MS-004: Relationship Management | 関係性スコア算出、対立検知、仲裁プロセス、提案管理 |
| MS-007: Platform Integration | ポータル/外部API統合、コンテンツ配信、統合エンドポイント提供 |
| MS-008: Monetization | サブスクリプション、決済、Feature Flag、利用計測、課金段階制御 |

### 5.2 統合パターン
- Published Language (イベント駆動): UserRegistered、DatePlanCreated、CollaborationCompleted、DateCompleted、FeatureUnlocked などでサービス間連携。
- Customer-Supplier (直接API): Collaboration→Planning、Execution→Collaboration、Relationship→User など REST 連携。
- Open Host Service: MS-007 が統合APIと外部サービスプロキシを提供し、ポータルや外部連携を集約。

### 5.3 外部連携とインフラ
- 外部依存: Supabase Auth、OpenAI API、Stripe API、MapBox、外部レストランAPI など。
- インフラ構成: API Gateway (Vercel Edge)、Event Bus (Supabase Realtime)、CDN、Monitoring (Vercel Analytics)。
- 技術スタック: Node.js + TypeScript（共通）、Python（AI/MLサービス）、Supabase PostgreSQL、Redis、Supabase Storage。

### 5.4 セキュリティ境界
- 認証: Supabase Auth (JWT)。
- 認可: RBAC、最小権限のAPIスコープ。
- 通信: TLS 1.3、サービス間認証。
- データ保護: AES-256 at rest、PII匿名化、監査ログ全API。
- 外部API: API Key管理、レート制限、ネットワーク分離。

## 6. データアーキテクチャ
### 6.1 ドメイン別主要エンティティ
- ユーザードメイン (MS-001): User、Couple、UserProfile、UserSession、CoupleInvitation。
- プランニングドメイン (MS-002): DatePlan、PlanItem、PlanTemplate、PlanRecommendation、PlanFeedback。
- コラボレーション (MS-003): PlanSession、EditOperation、EditConflict、CollaborationState。
- 関係管理 (MS-004): Relationship、Conflict、Mediation、MediationProposal、RelationshipMetric。
- 統合 (MS-007): PortalContent、ExternalService、IntegrationConfig、ContentDelivery。
- マネタイズ (MS-008): Subscription、Payment、FeatureFlag、UsageMetrics、BillingCycle。

### 6.2 交差リレーション
- User は PlanFeedback、EditOperation、DateMemory、GratitudeMessage、MediationProposal など他サービスへFK参照。
- DatePlan → PlanSession → Date が体験フローを形成し、Date 完了で Relationship にイベント連携。
- Couple は Relationship、Subscription、UsageMetrics を跨いで利用され、Feature Flag で機能制御。

### 6.3 データ管理方針
- 分散データストア: サービス毎に独立したPostgreSQLスキーマで最終的整合性をイベントで確保。
- キャッシュ戦略: 高頻度読み取りはRedisで保管（テンプレート、コラボ状態、Feature Flag等）。
- 分析基盤: Relationship分析やKPIはAnalytics DBに集約し、BIダッシュボードで可視化。

## 7. エクスペリエンスと画面構成
### 7.1 画面カテゴリと件数
- 合計34画面。認証/設定4、ユースケースUC-001〜UC-007で各5前後、共通画面5。
- 詳細一覧は Docs/画面一覧・遷移図.md を参照。

### 7.2 主要ユーザーフロー
1. 新規登録フロー: AUTH-001 → AUTH-002 → AUTH-003 → COMMON-001。
2. AIデートプラン生成フロー: COMMON-001 → UC001-001〜UC001-005 → UC002-001。
3. 共同編集完了: UC002-001〜005。
4. 仲裁・関係修復: COMMON-001 → UC004-001〜005 → UC001-001。
5. マネタイズ制御: COMMON-001 → UC007-001〜005。
6. ポータル経由導線: UC003-001〜005 → AUTH-001 → COMMON-001。

### 7.3 画面機能の要点
- COMMON-001 ダッシュボード: KPIカード、通知センター、クイックアクション、関係スコア表示。
- 課金管理 (UC007-001): プラン概要、使用量チャート、支払い履歴、プラン変更導線。

## 8. 画面-API-データマッピング概要
- AUTH系: API-AUTH-001/002 で登録・ログイン、API-UM-001〜008 でプロフィールやプライバシー、連携管理。
- デートプラン (UC-001): API-DE-001 (履歴)、AI生成APIで計画策定。
- 仲裁 (UC-004): API-RM-001〜009 が仲裁依頼から提案選択までをカバー。
- マネタイズ (UC-007): API-MON-001〜006 がサブスク、決済、Feature Flag取得に対応。
- 詳細は Docs/画面-API-データマッピング.md を参照。

## 9. 非機能要件と運用
### 9.1 パフォーマンスと可用性
- レスポンス目標: ダッシュボード1.5秒以内、主要API2秒以内、AI生成はバックグラウンドで進行。
- リアルタイム: SSE/WS遅延300ms以内、フォールバックポーリング15秒。
- SLO: コアサービス99.9%、支援サービス99.5%。RTO 1h/4h、RPO 15min/1h。

### 9.2 セキュリティとプライバシー
- Supabase Auth + RBAC、JWT検証を必須としアクセス制御を徹底。
- データ暗号化、PII匿名化、監査ログ整備、プライバシー設定画面での利用者制御。
- 外部APIはAPI Key管理、レート制限、ネットワーク分離を実施。

### 9.3 運用・監視
- Vercel Analytics と Supabase テレメトリで稼働率、レイテンシ、ビジネスKPIを監視。
- Circuit Breaker/リトライによる自動復旧とRunbook・エスカレーション手順による有人対応。
- バックアップ: PostgreSQLおよびSupabase Storageのスナップショット、マルチリージョン冗長構成。

## 10. リスクとトレードオフ
- 技術的複雑性: OTベースのリアルタイム編集やイベント整合性により実装負荷が高い → ライブラリ活用と包括的テストで軽減。
- UX過負荷: 多機能ゆえの情報過多 → カード分類、折りたたみ、ユーザーカスタマイズで緩和。
- 収益化タイミング: UX毀損リスク → 段階的マネタイズとFeature FlagでA/B検証。
- プライバシー: 感情データ・位置情報の取扱い → 匿名化・同意管理・アクセス制御を厳格運用。

## 11. 参照ドキュメント
| 種別 | ファイル | 主な内容 |
|------|---------|----------|
| ビジネス戦略 | Docs/ビジネス要件定義書.md | 市場分析、戦略課題、ロードマップ、KPI、実行計画 |
| アーキテクチャ | Docs/コンテキストマップ.md | サービス境界、統合パターン、技術スタック、セキュリティ、運用指標 |
| データモデル | Docs/データモデル図.md | サービス別エンティティ、ER図、リレーション定義 |
| 画面/API | Docs/画面-API-データマッピング.md | 画面機能とAPI・データの対応表 |
| UX設計 | Docs/画面一覧・遷移図.md | 画面一覧、遷移フロー、エラーハンドリング、設計上の注意点 |

---
作成日: 2025年1月27日  
作成者: Codex支援による統合  
バージョン: 1.0

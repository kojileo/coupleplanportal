# UC-005: Date Canvas共同編集ボード

## 1. ユースケース概要

### 1.1 ユースケース名
Date Canvas共同編集ボード

### 1.2 説明
デートの思い出をキャンバス上に自由に記録し、パートナーとリアルタイムで共有・編集できる協働ボード機能。位置情報ピンと連携して、デートの体験を視覚的に記録できます。

### 1.3 目的
- デート中の出来事や感情をリアルタイムで記録
- パートナーと協働で思い出を可視化
- 位置情報と連携した思い出の記録
- デート後の振り返りを楽しく簡単に

### 1.4 アクター
- **プライマリアクター**: カップルユーザー
- **セカンダリアクター**: システム（リアルタイム同期）

## 2. 機能要件

### 2.1 コア機能

#### 2.1.1 キャンバス記録機能
- **メモ追加**: テキストメモ、絵文字、スタンプを自由に配置
- **写真追加**: デート中の写真をキャンバスに配置
- **位置情報連携**: 位置情報ピンと連携してマップベースで記録
- **描画機能**: 自由に線や図形を描画

#### 2.1.2 カテゴリ別記録
- **グルメ**: 食事やカフェの思い出
- **写真**: 記念写真やスナップショット
- **プレゼント**: サプライズやギフトの記録
- **お気に入り**: 特別な瞬間のハイライト

#### 2.1.3 リアルタイム協働編集
- **同時編集**: パートナーと同時にキャンバスを編集
- **プレゼンス表示**: 相手の操作をリアルタイムで確認
- **変更通知**: 相手の追加・編集をリアルタイムで通知

#### 2.1.4 フィルター・表示機能
- **カテゴリフィルター**: カテゴリ別にメモを絞り込み
- **時系列表示**: 時間順にメモを整理
- **ハイライト表示**: お気に入りメモを強調

### 2.2 サブ機能

#### 2.2.1 メモ管理
- **メモ詳細表示**: メモの詳細情報を表示
- **メモ編集**: 既存メモの編集
- **メモ削除**: 不要なメモの削除
- **メモ共有**: 個別メモの外部共有

#### 2.2.2 キャンバス操作
- **元に戻す/やり直す**: 操作の取り消し・やり直し
- **クリア**: キャンバス全体のクリア
- **エクスポート**: キャンバスを画像として保存

## 3. ユーザーストーリー

### 3.1 基本シナリオ

**シナリオ1: デート中の記録**
```
ユーザーがデート中に以下を実行：
1. Date Canvasを開く
2. グルメカテゴリでメモを追加（美味しいランチ）
3. 写真を撮影してキャンバスに追加
4. パートナーもサプライズメモを追加
5. お互いの記録をリアルタイムで確認
```

**シナリオ2: 位置情報連携**
```
ユーザーが位置情報ピンと連携：
1. Date Canvasから位置情報ピン画面に移動
2. 訪問した場所にピンを追加
3. Date Canvasに戻ってメモと紐付け
4. マップベースで思い出を可視化
```

**シナリオ3: デート後の振り返り**
```
デート後にカップルが以下を実行：
1. Date Canvasを開いて当日の記録を確認
2. カテゴリフィルターで思い出を整理
3. お気に入りメモをハイライト
4. キャンバスを画像として保存
```

### 3.2 代替シナリオ

**代替シナリオ1: オフライン記録**
```
オフライン時：
1. ローカルにメモを保存
2. オンライン復帰後に自動同期
3. 競合がある場合は通知
```

**代替シナリオ2: 編集競合**
```
同時編集で競合が発生：
1. 両方の変更を保持
2. タイムスタンプで順序を決定
3. 必要に応じてユーザーに確認
```

## 4. 非機能要件

### 4.1 パフォーマンス
- **リアルタイム同期**: 500ms以内に相手の変更を反映
- **メモ追加**: 200ms以内に完了
- **画像アップロード**: 2MB以下の画像を3秒以内にアップロード

### 4.2 ユーザビリティ
- **直感的操作**: ドラッグ&ドロップで簡単にメモを配置
- **ビジュアル重視**: カラフルなアイコンとマーカーで視覚的に記録
- **ワンタップ追加**: クイックメモ機能で素早く記録

### 4.3 可用性
- **オフライン対応**: オフラインでも記録可能
- **自動保存**: 編集内容を自動的に保存
- **データ復旧**: エラー時の自動復旧

## 5. 画面設計

### 5.1 画面構成
- **キャンバスエリア**: メインの記録エリア（左側、大きく表示）
- **サイドパネル**: メモ一覧、追加、フィルター（右側）
- **コントロールパネル**: ツール選択、操作ボタン（キャンバス右上）

### 5.2 UI要素
- **メモマーカー**: カラフルな円形マーカー（カテゴリ別に色分け）
- **メモラベル**: マーカー下部に表示される簡潔なラベル
- **ツールボタン**: メモ、写真、位置情報、描画ツール
- **メモカード**: サイドパネルのリスト表示

### 5.3 インタラクション
- **クリック**: メモ詳細を表示
- **ドラッグ**: メモの位置を変更
- **ダブルクリック**: メモを編集
- **右クリック**: コンテキストメニューを表示

## 6. データモデル

### 6.1 主要エンティティ

**DateCanvas**
- CanvasId (PK)
- DateId (FK)
- CoupleId (FK)
- Status (active/completed)
- CreatedAt
- UpdatedAt

**CanvasMemo**
- MemoId (PK)
- CanvasId (FK)
- UserId (FK)
- Category (food/photo/gift/heart)
- Title
- Description
- PositionX
- PositionY
- Color
- IconType
- CreatedAt
- UpdatedAt

**CanvasPhoto**
- PhotoId (PK)
- MemoId (FK)
- ImageUrl
- ThumbnailUrl
- CreatedAt

### 6.2 関連

- DateCanvas 1 - N CanvasMemo
- CanvasMemo 1 - N CanvasPhoto
- CanvasMemo N - 1 User
- DateCanvas N - 1 Couple

## 7. API設計

### 7.1 主要API

**キャンバス取得**
```
GET /api/v1/canvas/{canvasId}
Response: Canvas情報とメモ一覧
```

**メモ追加**
```
POST /api/v1/canvas/{canvasId}/memos
Body: {category, title, description, positionX, positionY, color, iconType}
Response: 作成されたMemo情報
```

**メモ更新**
```
PUT /api/v1/canvas/{canvasId}/memos/{memoId}
Body: {title, description, positionX, positionY}
Response: 更新されたMemo情報
```

**メモ削除**
```
DELETE /api/v1/canvas/{canvasId}/memos/{memoId}
Response: 204 No Content
```

**リアルタイム同期**
```
WebSocket /api/v1/canvas/{canvasId}/sync
Events: memo_added, memo_updated, memo_deleted, presence_update
```

## 8. 位置情報ピンとの連携

### 8.1 連携方法
- Date Canvasから位置情報ピン画面に遷移可能
- 位置情報ピンで追加した場所をDate Canvasのメモとして表示
- 両画面で同じデータを共有し、シームレスに切り替え

### 8.2 データ連携
- LocationPin → CanvasMemo (位置情報カテゴリのメモとして自動生成)
- CanvasMemo → LocationPin (位置情報を持つメモはピンとして表示)

## 9. 技術実装

### 9.1 フロントエンド
- **UI Framework**: React/Vue.js
- **リアルタイム同期**: WebSocket (Supabase Realtime)
- **状態管理**: Redux/Vuex
- **描画**: HTML5 Canvas API

### 9.2 バックエンド
- **API**: Supabase Edge Functions
- **データベース**: PostgreSQL (Supabase)
- **ストレージ**: Supabase Storage (写真保存)
- **リアルタイム**: Supabase Realtime

## 10. 差別化ポイント

### 10.1 既存サービスとの違い
- **位置情報ピンとの統合**: マップとキャンバスの両方で記録可能
- **カップル特化**: 二人で協働して思い出を作成
- **シンプルなUX**: 位置情報ピンと同じ直感的なインターフェース
- **リアルタイム協働**: その場で一緒に思い出を記録

### 10.2 ユーザー価値
- **思い出の可視化**: デートの体験を視覚的に記録
- **協働の楽しさ**: パートナーと一緒に思い出を作る体験
- **振り返りの価値**: デート後も楽しく振り返れる
- **簡単な記録**: ワンタップで素早く記録可能

